(window.webpackJsonp=window.webpackJsonp||[]).push([[53],{2223:function(t,a,s){t.exports=s.p+"assets/img/cpu_hight_issue1_1.f8ab7b08.png"},2224:function(t,a,s){t.exports=s.p+"assets/img/cpu_hight_issue1_2.6d951b16.jpg"},2405:function(t,a,s){"use strict";s.r(a);var e=s(2),r=Object(e.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"场景一"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#场景一"}},[t._v("#")]),t._v(" 场景一")]),t._v(" "),a("h3",{attrs:{id:"问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题"}},[t._v("#")]),t._v(" 问题")]),t._v(" "),a("p",[t._v("CPU使用率接近100%持续半小时"),a("br"),t._v(" "),a("img",{attrs:{src:s(2223),alt:""}})]),t._v(" "),a("h3",{attrs:{id:"监控"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#监控"}},[t._v("#")]),t._v(" 监控")]),t._v(" "),a("p",[t._v("某个SQL持续执行了7次并且总共持续了20-40mins")]),t._v(" "),a("h3",{attrs:{id:"排查"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#排查"}},[t._v("#")]),t._v(" 排查")]),t._v(" "),a("ol",[a("li",[t._v("通过查询后台服务日志发现，该SQL的确执行了多次，并且报了"),a("code",[t._v("java.sql.SQLRecoverableException: IO Error: Socket read timed out")]),t._v("，SQL对应的接口每次请求完成时间是3分钟。"),a("br"),t._v("\n初步怀疑是因为SQL执行太久，导致超时。通过检查apollo配置，发现数据库的连接读超时刚好设置为3分钟"),a("code",[t._v("spring.datasource.hikari.data-source-properties.oracle.jdbc.ReadTimeout=180000")]),t._v("。")]),t._v(" "),a("li",[t._v("检查业务发现这个接口是查询某种业务月度报表数据，调用链路为xxl-job---\x3e微服务A---\x3e微服务B---\x3e数据库，该SQL是微服务B中提供报表数据所执行的SQL。\n初步怀疑SQL多次执行是因为存在for循环或xxl-job的失败重试及超时导致，但是检查确认不存在for循环、xxl-job未配置任何重试策略并且xxl-job对执行时间是无限制的。通过查看SQL对应接口的请求日志发现，该接口被请求了多次，再次怀疑是因为微服务调用组件feign的超时重试机制导致。通过检查apollo发现确实配置了feign的超时重试。")])]),t._v(" "),a("div",{staticClass:"language-properties line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-properties"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#ribbon路由策略")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("ribbon.eureka.enabled")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("true")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("ribbon.ReadTimeout")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("180000")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("ribbon.ConnectTimeout")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("1000")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#同一实例最大重试次数，不包括首次调用")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("ribbon.MaxAutoRetries")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("1")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#重试其他实例的最大重试次数，不包括首次所选的server")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("ribbon.MaxAutoRetriesNextServer")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("2")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#是否所有操作都进行重试，")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("ribbon.OkToRetryOnAllOperations")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("true")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("12000000")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br")])]),a("h3",{attrs:{id:"链路"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#链路"}},[t._v("#")]),t._v(" 链路")]),t._v(" "),a("p",[a("img",{attrs:{src:s(2224),alt:""}}),a("br"),t._v("\n服务B一边调用两次，服务B另一边调了四次")]),t._v(" "),a("h3",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),a("ul",[a("li",[t._v("SQL执行需要考虑数据量大时的执行性能")]),t._v(" "),a("li",[t._v("对于微服务请求超时及数据库执行超时的合理配置")])]),t._v(" "),a("p",[t._v("参考："),a("br"),t._v(" "),a("a",{attrs:{href:"https://www.cnblogs.com/zhangjianbin/p/7228628.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://www.cnblogs.com/zhangjianbin/p/7228628.html"),a("OutboundLink")],1),a("br"),t._v(" "),a("a",{attrs:{href:"https://docs.oracle.com/cd/E57185_01/ESTUG/apbs02s23.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://docs.oracle.com/cd/E57185_01/ESTUG/apbs02s23.html"),a("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=r.exports}}]);