
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Brotherc">
    <title>标签: 云析学院 - Brotherc</title>
    <meta name="author" content="Brotherc">
    
    
    
    <script type="application/ld+json">{}</script>
    <meta property="og:type" content="blog">
<meta property="og:title" content="Brotherc">
<meta property="og:url" content="http://yoursite.com/tags/云析学院/index.html">
<meta property="og:site_name" content="Brotherc">
<meta property="og:locale" content="zh-cn">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Brotherc">
    
    
        
    
    
        <meta property="og:image" content="http://yoursite.com/assets/images/head.jpg"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-c4ozcsklz4kht2pebhp44xorvyverh23toayhn7i6ubrpyedak24hv1v0hyd.min.css">
    <!--STYLES END-->
    

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/ ">Brotherc</a>
    </div>
    
        
            <a class="header-right-picture " href="#about">
        
        
            <img class="header-picture" src="/assets/images/head.jpg" alt="作者的图片">
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="1">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a href="/#about">
                    <img class="sidebar-profile-picture" src="/assets/images/head.jpg" alt="作者的图片">
                </a>
                <h4 class="sidebar-profile-name">Brotherc</h4>
                
                    <h5 class="sidebar-profile-bio"><p>java development</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/ " title="首页">
                    
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首页</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-categories" title="分类">
                    
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">分类</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-tags" title="标签">
                    
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">标签</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link open-algolia-search" href="/all-archives" title="归档">
                    
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">归档</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="#about" title="关于">
                    
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">关于</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://github.com/Brotherc" target="_blank" rel="noopener" title="GitHub">
                    
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="1"
                 class="
                        hasCoverMetaIn
                        ">
                
    <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2020/09/01/双11电商网站应对千万级流量技术内幕/">
                            双11电商网站应对千万级流量技术内幕
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2020-09-01T23:21:33+08:00">
	
		    9月 01, 2020
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/双11电商网站应对千万级流量技术内幕/1.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/双11电商网站应对千万级流量技术内幕/1.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/双11电商网站应对千万级流量技术内幕/2.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/双11电商网站应对千万级流量技术内幕/2.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/双11电商网站应对千万级流量技术内幕/3.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/双11电商网站应对千万级流量技术内幕/3.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/双11电商网站应对千万级流量技术内幕/15.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/双11电商网站应对千万级流量技术内幕/15.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/双11电商网站应对千万级流量技术内幕/14.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/双11电商网站应对千万级流量技术内幕/14.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/双11电商网站应对千万级流量技术内幕/4.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/双11电商网站应对千万级流量技术内幕/4.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/双11电商网站应对千万级流量技术内幕/5.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/双11电商网站应对千万级流量技术内幕/5.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/双11电商网站应对千万级流量技术内幕/6.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/双11电商网站应对千万级流量技术内幕/6.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/双11电商网站应对千万级流量技术内幕/7.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/双11电商网站应对千万级流量技术内幕/7.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/双11电商网站应对千万级流量技术内幕/8.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/双11电商网站应对千万级流量技术内幕/8.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/双11电商网站应对千万级流量技术内幕/9.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/双11电商网站应对千万级流量技术内幕/9.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/双11电商网站应对千万级流量技术内幕/10.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/双11电商网站应对千万级流量技术内幕/10.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/双11电商网站应对千万级流量技术内幕/11.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/双11电商网站应对千万级流量技术内幕/11.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/双11电商网站应对千万级流量技术内幕/12.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/双11电商网站应对千万级流量技术内幕/12.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/双11电商网站应对千万级流量技术内幕/13.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/双11电商网站应对千万级流量技术内幕/13.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
                    
                        

                    
                    
                        <p>
                            <a href="/2020/09/01/双11电商网站应对千万级流量技术内幕/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2020/08/30/云析学院-Google平滑限流方案-Guava/">
                            Google平滑限流方案-Guava
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2020-08-30T23:54:56+08:00">
	
		    8月 30, 2020
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <ul>
<li><p><strong>大厂面试题，说说你知道的限流方案</strong></p>
</li>
<li><p><strong>限流场景</strong></p>
</li>
</ul>
<p>12306<br>双十一（11.11零点，由于各种商家的促销活动(前XX名免单)，支付宝进入排队支付状态）<br>外卖业务</p>
<ul>
<li><strong>常见的限流方案</strong></li>
</ul>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/Google平滑限流方案-Guava/1.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/Google平滑限流方案-Guava/1.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/Google平滑限流方案-Guava/2.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/Google平滑限流方案-Guava/2.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/Google平滑限流方案-Guava/3.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/Google平滑限流方案-Guava/3.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/Google平滑限流方案-Guava/4.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/Google平滑限流方案-Guava/4.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/Google平滑限流方案-Guava/5.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/Google平滑限流方案-Guava/5.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/Google平滑限流方案-Guava/6.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/Google平滑限流方案-Guava/6.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/Google平滑限流方案-Guava/7.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/Google平滑限流方案-Guava/7.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/Google平滑限流方案-Guava/8.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/Google平滑限流方案-Guava/8.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h2 id="Guava是什么"><a href="#Guava是什么" class="headerlink" title="Guava是什么"></a>Guava是什么</h2><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/Google平滑限流方案-Guava/9.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/Google平滑限流方案-Guava/9.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/Google平滑限流方案-Guava/10.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/Google平滑限流方案-Guava/10.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h2 id="Guava限流核心算法"><a href="#Guava限流核心算法" class="headerlink" title="Guava限流核心算法"></a>Guava限流核心算法</h2><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/Google平滑限流方案-Guava/11.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/Google平滑限流方案-Guava/11.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/Google平滑限流方案-Guava/12.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/Google平滑限流方案-Guava/12.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/Google平滑限流方案-Guava/13.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/Google平滑限流方案-Guava/13.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/Google平滑限流方案-Guava/14.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/Google平滑限流方案-Guava/14.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/Google平滑限流方案-Guava/15.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/Google平滑限流方案-Guava/15.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/Google平滑限流方案-Guava/16.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/Google平滑限流方案-Guava/16.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h2 id="Guava限流实战"><a href="#Guava限流实战" class="headerlink" title="Guava限流实战"></a>Guava限流实战</h2><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/Google平滑限流方案-Guava/20.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/Google平滑限流方案-Guava/20.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<ul>
<li><strong>平滑突发限流</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.google.common.util.concurrent.RateLimiter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 平滑突发限流(SmoothBursty)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmoothBurstyRateLimitTest01</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//每秒允许5个请求，表示桶容量为5且每秒新增5个令牌，即每隔0.2秒新增一个令牌</span></span><br><span class="line">        RateLimiter limiter = RateLimiter.create(<span class="number">5</span>);</span><br><span class="line">        <span class="comment">//如果当前桶中有足够令牌则成功（返回值为0）返回获取token的耗时，以秒为单位</span></span><br><span class="line">        <span class="comment">//将突发请求速率平均为了固定请求速率，固定频率=0.2s/个</span></span><br><span class="line">        System.out.println(limiter.acquire(<span class="number">1</span>));</span><br><span class="line">        System.out.println(limiter.acquire(<span class="number">1</span>));</span><br><span class="line">        System.out.println(limiter.acquire(<span class="number">1</span>));</span><br><span class="line">        System.out.println(limiter.acquire(<span class="number">1</span>));</span><br><span class="line">        System.out.println(limiter.acquire(<span class="number">1</span>));</span><br><span class="line">        System.out.println(limiter.acquire(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/Google平滑限流方案-Guava/17.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/Google平滑限流方案-Guava/17.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.google.common.util.concurrent.RateLimiter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 平滑突发限流(SmoothBursty) 使用场景：对冷数据的预热处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmoothBurstyRateLimitTest02</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//每秒允许5个请求，表示桶容量为5且每秒新增5个令牌，即每隔0.2秒新增一个令牌</span></span><br><span class="line">        RateLimiter limiter = RateLimiter.create(<span class="number">5</span>);</span><br><span class="line">        <span class="comment">//一次性消费5个令牌，模拟预热的场景（初始化redis缓存）</span></span><br><span class="line">        System.out.println(limiter.acquire(<span class="number">5</span>));</span><br><span class="line">        <span class="comment">//limiter.acquire(1)将等待差不多1秒桶中才能有令牌</span></span><br><span class="line">        System.out.println(limiter.acquire(<span class="number">1</span>));</span><br><span class="line">        <span class="comment">//固定速率</span></span><br><span class="line">        System.out.println(limiter.acquire(<span class="number">1</span>));</span><br><span class="line">        <span class="comment">//固定速率</span></span><br><span class="line">        System.out.println(limiter.acquire(<span class="number">1</span>));</span><br><span class="line">        <span class="comment">//固定速率</span></span><br><span class="line">        System.out.println(limiter.acquire(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/Google平滑限流方案-Guava/18.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/Google平滑限流方案-Guava/18.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.google.common.util.concurrent.RateLimiter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 平滑突发限流(SmoothBursty) 使用场景：对冷数据的预热处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmoothBurstyRateLimitTest03</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//每秒允许5个请求，表示桶容量为5且每秒新增5个令牌，即每隔0.2毫秒新增一个令牌</span></span><br><span class="line">        RateLimiter limiter = RateLimiter.create(<span class="number">5</span>);</span><br><span class="line">        <span class="comment">//第一秒突发了10个请求</span></span><br><span class="line">        System.out.println(limiter.acquire(<span class="number">10</span>));</span><br><span class="line">        <span class="comment">//limiter.acquire(1)将等待差不多2秒桶中才能有令牌</span></span><br><span class="line">        System.out.println(limiter.acquire(<span class="number">1</span>));</span><br><span class="line">        <span class="comment">//固定速率</span></span><br><span class="line">        System.out.println(limiter.acquire(<span class="number">1</span>));</span><br><span class="line">        <span class="comment">//固定速率</span></span><br><span class="line">        System.out.println(limiter.acquire(<span class="number">1</span>));</span><br><span class="line">        <span class="comment">//固定速率</span></span><br><span class="line">        System.out.println(limiter.acquire(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/Google平滑限流方案-Guava/19.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/Google平滑限流方案-Guava/19.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<ul>
<li><strong>平滑预热限流</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.google.common.util.concurrent.RateLimiter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 平滑预热限流(SmoothWarmingUp)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmoothWarmingUp</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//permitsPerSecond:每秒新增的令牌数  warmupPeriod:从冷启动速率过渡到平均速率的时间间隔</span></span><br><span class="line">        <span class="comment">//系统冷启动后慢慢的趋于平均固定速率（即刚开始速率慢一些，然后慢慢趋于我们设置的固定速率）</span></span><br><span class="line">        RateLimiter limiter = RateLimiter.create(<span class="number">10</span>, <span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>;i++) &#123;</span><br><span class="line">            <span class="comment">//获取一个令牌</span></span><br><span class="line">            System.out.println(limiter.acquire(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/Google平滑限流方案-Guava/21.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/Google平滑限流方案-Guava/21.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<ul>
<li><strong>Guava用于秒杀场景</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.google.common.util.concurrent.RateLimiter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> Guava秒杀场景：Guava使得商品被均匀的被秒杀，效果较好，未秒到商品的用户引流至推荐页</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GuavaSecKill</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//限流，每秒允许10个请求进入秒杀 QPS=10 令牌生成速度=100ms/个</span></span><br><span class="line">        RateLimiter limiter = RateLimiter.create(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 开线程池</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">100</span>);</span><br><span class="line">        <span class="comment">//100个线程同时抢购</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">            executorService.submit(() -&gt; &#123;</span><br><span class="line">                <span class="comment">//每个秒杀请求如果在50ms（0.05s）以内得到令牌，就算是秒杀成功，否则就返回秒杀失败</span></span><br><span class="line">                <span class="keyword">if</span> (limiter.tryAcquire(<span class="number">50</span>, TimeUnit.MILLISECONDS)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (CountUtils.TOTAL_COUNT.get() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">//库存减1</span></span><br><span class="line">                        CountUtils.decrease();</span><br><span class="line">                        System.out.println(<span class="string">"恭喜您，秒杀成功！！！"</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        System.out.println(<span class="string">"秒杀失败，商品已售完"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">"秒杀失败，请继续努力~"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">//给limiter 0.01s的时间生成新的令牌生成</span></span><br><span class="line">            Thread.sleep(<span class="number">10</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/Google平滑限流方案-Guava/22.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/Google平滑限流方案-Guava/22.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/Google平滑限流方案-Guava/23.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/Google平滑限流方案-Guava/23.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/Google平滑限流方案-Guava/24.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/Google平滑限流方案-Guava/24.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h2 id="笔记"><a href="#笔记" class="headerlink" title="笔记"></a>笔记</h2><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/Google平滑限流方案-Guava/25.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/Google平滑限流方案-Guava/25.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/Google平滑限流方案-Guava/26.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/Google平滑限流方案-Guava/26.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/Google平滑限流方案-Guava/27.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/Google平滑限流方案-Guava/27.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<p>参考：<br><a href="https://github.com/online-demo/yunxi-guava/tree/master/src/main/java/com/yunxi/demo/guava" target="_blank" rel="noopener">https://github.com/online-demo/yunxi-guava/tree/master/src/main/java/com/yunxi/demo/guava</a></p>

                    
                        

                    
                    
                        <p>
                            <a href="/2020/08/30/云析学院-Google平滑限流方案-Guava/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2020/08/12/云析学院-原生JDK线程扩展-Guava/">
                            原生JDK线程扩展-Guava
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2020-08-12T23:03:41+08:00">
	
		    8月 12, 2020
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="JDK线程"><a href="#JDK线程" class="headerlink" title="JDK线程"></a>JDK线程</h2><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/原生JDK线程扩展-Guava/1.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/原生JDK线程扩展-Guava/1.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<ul>
<li><strong>针对以上串行场景，有什么优化方案</strong></li>
</ul>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/原生JDK线程扩展-Guava/2.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/原生JDK线程扩展-Guava/2.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/原生JDK线程扩展-Guava/3.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/原生JDK线程扩展-Guava/3.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<ul>
<li><strong>谈谈你对Java线程池的理解</strong></li>
</ul>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/原生JDK线程扩展-Guava/4.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/原生JDK线程扩展-Guava/4.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/原生JDK线程扩展-Guava/5.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/原生JDK线程扩展-Guava/5.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/原生JDK线程扩展-Guava/6.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/原生JDK线程扩展-Guava/6.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/原生JDK线程扩展-Guava/7.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/原生JDK线程扩展-Guava/7.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/原生JDK线程扩展-Guava/8.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/原生JDK线程扩展-Guava/8.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/原生JDK线程扩展-Guava/9.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/原生JDK线程扩展-Guava/9.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/原生JDK线程扩展-Guava/10.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/原生JDK线程扩展-Guava/10.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/原生JDK线程扩展-Guava/11.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/原生JDK线程扩展-Guava/11.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<ul>
<li><strong>以上方式就是最优解吗？</strong></li>
</ul>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/原生JDK线程扩展-Guava/12.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/原生JDK线程扩展-Guava/12.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/原生JDK线程扩展-Guava/13.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/原生JDK线程扩展-Guava/13.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/原生JDK线程扩展-Guava/14.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/原生JDK线程扩展-Guava/14.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<ul>
<li><strong>95线  95%请求  300ms</strong></li>
</ul>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/原生JDK线程扩展-Guava/15.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/原生JDK线程扩展-Guava/15.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/原生JDK线程扩展-Guava/16.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/原生JDK线程扩展-Guava/16.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/原生JDK线程扩展-Guava/17.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/原生JDK线程扩展-Guava/17.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/原生JDK线程扩展-Guava/18.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/原生JDK线程扩展-Guava/18.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h2 id="Guava对JDK扩展"><a href="#Guava对JDK扩展" class="headerlink" title="Guava对JDK扩展"></a>Guava对JDK扩展</h2><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/云析学院/原生JDK线程扩展-Guava/19.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/云析学院/原生JDK线程扩展-Guava/19.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h2 id="Guava实战"><a href="#Guava实战" class="headerlink" title="Guava实战"></a>Guava实战</h2><h5 id="模拟外部服务"><a href="#模拟外部服务" class="headerlink" title="模拟外部服务"></a>模拟外部服务</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 模拟一个耗时的服务 如：RPC或者HTTP请求</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OuterService</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户服务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">userService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"用户服务开始执行"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//模拟耗时1000ms的用户服务</span></span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"用户服务执行结束"</span>);</span><br><span class="line">        <span class="comment">//假设用户服务返回值=1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单服务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">orderService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"订单服务开始执行"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//模拟耗时2000ms的订单服务</span></span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"订单服务执行结束"</span>);</span><br><span class="line">        <span class="comment">//假设订单服务返回值=3</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品服务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">itemService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"商品服务开始执行"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//模拟耗时3000ms的商品服务</span></span><br><span class="line">            Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">            <span class="comment">//模拟调用超时或者服务异常</span></span><br><span class="line">            <span class="comment">// throw new RuntimeException("Oh My God, OrderService Exception!!!");</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"商品服务执行结束"</span>);</span><br><span class="line">        <span class="comment">//假设商品服务返回值=5</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 地址服务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">addressService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"地址服务开始执行"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//模拟耗时5000ms的地址服务</span></span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"地址服务执行结束"</span>);</span><br><span class="line">        <span class="comment">//假设地址服务返回值=7</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">7</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="单线程演示"><a href="#单线程演示" class="headerlink" title="单线程演示"></a>单线程演示</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 单线程操作演示</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleThreadDemo</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OuterService outerService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试代码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/test/single"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">test</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//开始调用的时间</span></span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">//同步调用用户服务</span></span><br><span class="line">        <span class="keyword">long</span> userServiceResult = outerService.userService();</span><br><span class="line">        <span class="comment">//同步调用订单服务</span></span><br><span class="line">        <span class="keyword">long</span> orderServiceResult = outerService.orderService();</span><br><span class="line">        <span class="comment">//同步调用商品服务</span></span><br><span class="line">        <span class="keyword">long</span> itemServiceResult = outerService.itemService();</span><br><span class="line">        <span class="comment">//结束调用的时间</span></span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">        String time = <span class="string">"总调用时间是："</span> + (end - start) + <span class="string">"毫秒"</span>;</span><br><span class="line">        <span class="comment">//计算结果</span></span><br><span class="line">        <span class="keyword">long</span> result = userServiceResult + orderServiceResult + itemServiceResult;</span><br><span class="line">        <span class="comment">//为什么要初始化4个容量的Map</span></span><br><span class="line">        Map&lt;String, Object&gt; resultMap = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">4</span>);</span><br><span class="line">        resultMap.put(<span class="string">"time"</span>, time);</span><br><span class="line">        resultMap.put(<span class="string">"result"</span>, result);</span><br><span class="line">        <span class="comment">//结果</span></span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="JDK多线程演示"><a href="#JDK多线程演示" class="headerlink" title="JDK多线程演示"></a>JDK多线程演示</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: JDK多线程操作演示</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdkThreadController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OuterService outerService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/test/jdk"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">execute</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 固定大小的线程池 核心线程数和最大线程数=10</span></span><br><span class="line">        ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line">        <span class="comment">// 记录开始时间</span></span><br><span class="line">        Long start = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// 异步调用用户服务</span></span><br><span class="line">        Future&lt;Long&gt; userServiceFuture = executorService.submit(<span class="keyword">new</span> Callable&lt;Long&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Long <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> outerService.userService();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 异步调用订单服务</span></span><br><span class="line">        Future&lt;Long&gt; orderServiceFuture = executorService.submit(<span class="keyword">new</span> Callable&lt;Long&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Long <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> outerService.orderService();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 异步调用商品服务</span></span><br><span class="line">        Future&lt;Long&gt; itemServiceFuture = executorService.submit(<span class="keyword">new</span> Callable&lt;Long&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Long <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> outerService.itemService();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 阻塞 等待执行结果</span></span><br><span class="line">        <span class="keyword">long</span> userServiceResult = userServiceFuture.get();</span><br><span class="line">        <span class="keyword">long</span> orderServiceResult = orderServiceFuture.get();</span><br><span class="line">        <span class="keyword">long</span> itemServiceResult = itemServiceFuture.get();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//结束调用的时间</span></span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">//计算结果</span></span><br><span class="line">        <span class="keyword">long</span> result = userServiceResult + orderServiceResult + itemServiceResult;</span><br><span class="line">        String time = <span class="string">"总调用时间是："</span> + (end - start) + <span class="string">"毫秒"</span>;</span><br><span class="line">        <span class="comment">//为什么要初始化4个容量的Map</span></span><br><span class="line">        Map&lt;String, Object&gt; resultMap = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">4</span>);</span><br><span class="line">        resultMap.put(<span class="string">"time"</span>, time);</span><br><span class="line">        resultMap.put(<span class="string">"result"</span>, result);</span><br><span class="line">        <span class="comment">//结果</span></span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Guava特性演示"><a href="#Guava特性演示" class="headerlink" title="Guava特性演示"></a>Guava特性演示</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.google.common.util.concurrent.ListeningExecutorService;</span><br><span class="line"><span class="keyword">import</span> com.google.common.util.concurrent.MoreExecutors;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 公用的线程池</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ListeningExecutors</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ListeningExecutorService <span class="title">createListeningExecutorService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建线程池</span></span><br><span class="line">        <span class="keyword">return</span> MoreExecutors.listeningDecorator(Executors.newFixedThreadPool(<span class="number">10</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.google.common.util.concurrent.FutureCallback;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: ListenableFuture回调任务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureCallBackTask</span> <span class="keyword">implements</span> <span class="title">FutureCallback</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 成功的回调</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> result</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(Object result)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//执行回调函数</span></span><br><span class="line">        System.out.println(<span class="string">"进入正确的回调函数"</span>);</span><br><span class="line">        <span class="comment">//得到任务执行的结果</span></span><br><span class="line">        System.out.printf(<span class="string">"任务执行的结果是：%s%n"</span>, result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 失败的回调</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> thrown</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Throwable thrown)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"进入错误的回调函数"</span>);</span><br><span class="line">        System.out.printf(<span class="string">"系统出错了，错误原因是：%s%n"</span>, thrown.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: Guava 线程简单测试</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GuavaThreadController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ListeningExecutorService listeningExecutorService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/test/guava"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 记录开始时间</span></span><br><span class="line">        Long start = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// 一个耗时的任务</span></span><br><span class="line">        ListenableFuture&lt;Boolean&gt; listenableFuture = listeningExecutorService.submit(() -&gt; &#123;</span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 注册回调事件</span></span><br><span class="line">        Futures.addCallback(listenableFuture, <span class="keyword">new</span> FutureCallBackTask(), listeningExecutorService);</span><br><span class="line">        <span class="comment">// 记录结束时间</span></span><br><span class="line">        Long end = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// 执行时间</span></span><br><span class="line">        System.out.println(<span class="string">"execute()方法执行结束了，耗时="</span> + (end - start) + <span class="string">"毫秒"</span>);</span><br><span class="line">        System.out.println(<span class="string">"-----------------------华丽的分割线-----------------------"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 高级特性介绍</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * transform：对于ListenableFuture的返回值进行转换。</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * allAsList：对多个ListenableFuture的合并，返回一个当所有Future成功时返回多个Future返回值组成的List对象。</span></span><br><span class="line"><span class="comment"> * 注：当其中一个Future失败或者取消的时候，将会进入失败或者取消。</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * successfulAsList：和allAsList相似，唯一差别是对于失败或取消的Future返回值用null代替。不会进入失败或者取消流程。</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * immediateFuture/immediateCancelledFuture： 立即返回一个待返回值的ListenableFuture。</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * makeChecked: 将ListenableFuture 转换成CheckedFuture。CheckedFuture 是一个ListenableFuture 。</span></span><br><span class="line"><span class="comment"> * 其中包含了多个版本的get 方法，方法声明抛出检查异常.这样使得创建一个在执行逻辑中可以抛出异常的Future更加容易</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * JdkFutureAdapters.listenInPoolThread(jdkthread): guava同时提供了将JDK Future转换为ListenableFuture的接口函数。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeniorListenableFutureController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ListeningExecutorService listeningExecutorService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OuterService outerService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/test/senior"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">execute</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 异步调用用户服务</span></span><br><span class="line">        ListenableFuture&lt;Long&gt; userServiceFuture = listeningExecutorService.submit(<span class="keyword">new</span> Callable&lt;Long&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Long <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> outerService.userService();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 异步调用订单服务</span></span><br><span class="line">        ListenableFuture&lt;Long&gt; orderServiceFuture = listeningExecutorService.submit(<span class="keyword">new</span> Callable&lt;Long&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Long <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> outerService.orderService();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 异步调用商品服务</span></span><br><span class="line">        ListenableFuture&lt;Long&gt; itemServiceFuture = listeningExecutorService.submit(<span class="keyword">new</span> Callable&lt;Long&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Long <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> outerService.itemService();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//注册商品服务回调</span></span><br><span class="line">        addCallBack(itemServiceFuture);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// .......</span></span><br><span class="line">        <span class="comment">// 对多个ListenableFuture的合并，返回一个当所有Future成功时返回多个Future返回值组成的List对象。</span></span><br><span class="line">        <span class="comment">// 注：当其中一个Future失败或者取消的时候，会怎样？</span></span><br><span class="line">        <span class="keyword">final</span> ListenableFuture&lt;List&lt;Long&gt;&gt; threeServicesFutures = Futures.successfulAsList(userServiceFuture, orderServiceFuture, itemServiceFuture);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//对于多个ListenableFuture的进行转换，返回一个新的ListenableFuture</span></span><br><span class="line">        <span class="keyword">final</span> ListenableFuture&lt;Long&gt; transform = Futures.transformAsync(threeServicesFutures, <span class="keyword">new</span> AsyncFunction&lt;List&lt;Long&gt;, Long&gt;() &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 用给定的输入封装一个特定的ListenableFuture作为输出</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> input 输入的ListenableFuture对象</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> ListenableFuture&lt;Long&gt; <span class="title">apply</span><span class="params">(@Nullable List&lt;Long&gt; input)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (input == <span class="keyword">null</span> || input.isEmpty()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 这里可以对input进行复杂的处理，返回最终的一个结果</span></span><br><span class="line">                <span class="comment">// 比如：对用户服务，订单服务，商品服务的远程调用结果进行封装</span></span><br><span class="line">                <span class="keyword">long</span> result = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span> (Long serviceResult : input) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (serviceResult != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        result += serviceResult;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 立即返回一个带返回值的ListenableFuture</span></span><br><span class="line">                <span class="keyword">return</span> Futures.immediateFuture(result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, listeningExecutorService);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 异步调用地址服务</span></span><br><span class="line">        ListenableFuture&lt;Long&gt; addressServiceFuture = listeningExecutorService.submit(<span class="keyword">new</span> Callable&lt;Long&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Long <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> outerService.addressService();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ListenableFuture&lt;List&lt;Long&gt;&gt; finalFutures = Futures.successfulAsList(transform, addressServiceFuture);</span><br><span class="line"></span><br><span class="line">        ListenableFuture&lt;Long&gt; finalResult = Futures.transformAsync(finalFutures, <span class="keyword">new</span> AsyncFunction&lt;List&lt;Long&gt;, Long&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> ListenableFuture&lt;Long&gt; <span class="title">apply</span><span class="params">(@Nullable List&lt;Long&gt; input)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (CollectionUtils.isEmpty(input)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 这里可以对input进行复杂的处理，返回最终的一个结果</span></span><br><span class="line">                <span class="keyword">long</span> result = <span class="number">0</span>;</span><br><span class="line">                <span class="comment">// 比如：对上面的用户服务，订单服务，商品服务的总结果和地址服务再封装</span></span><br><span class="line">                <span class="keyword">for</span> (Long serviceResult : input) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (serviceResult != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        result += serviceResult;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 立即返回一个带返回值的ListenableFuture</span></span><br><span class="line">                <span class="keyword">return</span> Futures.immediateFuture(result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, listeningExecutorService);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册回调事件</span></span><br><span class="line">        addCallBack(finalResult);</span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">        String time = <span class="string">"总调用时间是："</span> + (end - start) + <span class="string">"毫秒"</span>;</span><br><span class="line">        <span class="comment">//为什么要初始化4个容量的Map</span></span><br><span class="line">        Map&lt;String, Object&gt; resultMap = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">3</span>);</span><br><span class="line">        resultMap.put(<span class="string">"time"</span>, time);</span><br><span class="line">        <span class="comment">//结果</span></span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加回调</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> listenableFuture</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addCallBack</span><span class="params">(ListenableFuture&lt;Long&gt; listenableFuture)</span> </span>&#123;</span><br><span class="line">        Futures.addCallback(listenableFuture, <span class="keyword">new</span> FutureCallback&lt;Long&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(@Nullable Long result)</span> </span>&#123;</span><br><span class="line">                System.out.printf(<span class="string">"服务调用成功,执行结果是%s%n"</span>,result);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Throwable t)</span> </span>&#123;</span><br><span class="line">                System.out.printf(<span class="string">"服务调用异常%s%n"</span>, t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, listeningExecutorService);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:  JdkFutureAdapters.listenInPoolThread(jdkthread)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * guava同时提供了将JDK Future转换为ListenableFuture的接口函数。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdkFutureAdaptersController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ListeningExecutorService listeningExecutorService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/test/adapter"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 固定大小的线程池 核心线程数和最大线程数=10</span></span><br><span class="line">        ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line">        <span class="comment">// 记录开始时间</span></span><br><span class="line">        Long start = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// 一个耗时的任务</span></span><br><span class="line">        Future&lt;Boolean&gt; future = executorService.submit(<span class="keyword">new</span> Callable&lt;Boolean&gt;() &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * Computes a result, or throws an exception if unable to do so.</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@return</span> computed result</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@throws</span> Exception if unable to compute a result</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Boolean <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="comment">//模拟耗时5s</span></span><br><span class="line">                Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        ListenableFuture listenableFuture = JdkFutureAdapters.listenInPoolThread(future);</span><br><span class="line">        Futures.addCallback(listenableFuture, <span class="keyword">new</span> FutureCallBackTask(), listeningExecutorService);</span><br><span class="line">        <span class="comment">// 记录结束时间</span></span><br><span class="line">        Long end = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// 执行时间</span></span><br><span class="line">        System.out.println(<span class="string">"线程执行结束了，耗时="</span> + (end - start) + <span class="string">"毫秒"</span>);</span><br><span class="line">        System.out.println(<span class="string">"-----------------------华丽的分割线-----------------------"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参考：<br><a href="https://github.com/online-demo/yunxi-guava-thread" target="_blank" rel="noopener">https://github.com/online-demo/yunxi-guava-thread</a></p>

                    
                        

                    
                    
                        <p>
                            <a href="/2020/08/12/云析学院-原生JDK线程扩展-Guava/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
        
        <li class="pagination-number">第 1 页 共 1 页</li>
    </ul>
</div>

</section>


                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2020 Brotherc. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/head.jpg" alt="作者的图片">
        
            <h4 id="about-card-name">Brotherc</h4>
        
            <div id="about-card-bio"><p>java development</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br>
                <p>java</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br>
                zhuhai
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-dbd16rvloemmuxdzniplmnxxvwoz24eya9wol0b7vvmlokgqsjivmb8dnscy.min.js"></script>
<!--SCRIPTS END-->



    </body>
</html>
