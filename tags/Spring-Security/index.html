
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Brotherc">
    <title>标签: Spring Security - Brotherc</title>
    <meta name="author" content="Brotherc">
    
    
    
    <script type="application/ld+json">{}</script>
    <meta property="og:type" content="blog">
<meta property="og:title" content="Brotherc">
<meta property="og:url" content="http://yoursite.com/tags/Spring-Security/index.html">
<meta property="og:site_name" content="Brotherc">
<meta property="og:locale" content="zh-cn">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Brotherc">
    
    
        
    
    
        <meta property="og:image" content="http://yoursite.com/assets/images/head.jpg"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-c4ozcsklz4kht2pebhp44xorvyverh23toayhn7i6ubrpyedak24hv1v0hyd.min.css">
    <!--STYLES END-->
    

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/ ">Brotherc</a>
    </div>
    
        
            <a class="header-right-picture " href="#about">
        
        
            <img class="header-picture" src="/assets/images/head.jpg" alt="作者的图片">
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="1">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a href="/#about">
                    <img class="sidebar-profile-picture" src="/assets/images/head.jpg" alt="作者的图片">
                </a>
                <h4 class="sidebar-profile-name">Brotherc</h4>
                
                    <h5 class="sidebar-profile-bio"><p>java development</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/ " title="首页">
                    
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首页</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-categories" title="分类">
                    
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">分类</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-tags" title="标签">
                    
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">标签</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link open-algolia-search" href="/all-archives" title="归档">
                    
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">归档</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="#about" title="关于">
                    
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">关于</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://github.com/Brotherc" target="_blank" rel="noopener" title="GitHub">
                    
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="1"
                 class="
                        hasCoverMetaIn
                        ">
                
    <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2020/04/09/Spring Social开发第三方认证/">
                            Spring Social开发第三方认证
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2020-04-09T20:00:36+08:00">
	
		    4月 09, 2020
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="1-OAuth协议以及Spring-Social原理简介"><a href="#1-OAuth协议以及Spring-Social原理简介" class="headerlink" title="1.OAuth协议以及Spring Social原理简介"></a>1.OAuth协议以及Spring Social原理简介</h2><h3 id="OAuth协议简介"><a href="#OAuth协议简介" class="headerlink" title="OAuth协议简介"></a>OAuth协议简介</h3><h5 id="OAuth协议要解决的问题"><a href="#OAuth协议要解决的问题" class="headerlink" title="OAuth协议要解决的问题"></a>OAuth协议要解决的问题</h5><p><img src="assets/SpringSecurity技术栈开发企业级认证与授权/40.jpg" alt="40"></p>
<ol>
<li>应用可以访问用户在微信上的所有数据</li>
<li>用户只有修改密码，才能收回授权</li>
<li>密码泄露的可能性大大提高</li>
</ol>
<h5 id="OAuth协议中的各种角色-amp-amp-运行流程"><a href="#OAuth协议中的各种角色-amp-amp-运行流程" class="headerlink" title="OAuth协议中的各种角色 &amp;&amp; 运行流程"></a>OAuth协议中的各种角色 &amp;&amp; 运行流程</h5><p><img src="assets/SpringSecurity技术栈开发企业级认证与授权/41.jpg" alt="41"><br><img src="assets/SpringSecurity技术栈开发企业级认证与授权/42.jpg" alt="42"></p>
<h3 id="Spring-Social原理简介"><a href="#Spring-Social原理简介" class="headerlink" title="Spring Social原理简介"></a>Spring Social原理简介</h3><p><img src="assets/SpringSecurity技术栈开发企业级认证与授权/43.jpg" alt="43"><br><img src="assets/SpringSecurity技术栈开发企业级认证与授权/44.jpg" alt="44"><br><img src="assets/SpringSecurity技术栈开发企业级认证与授权/45.jpg" alt="45"></p>
<h2 id="2-实现QQ认证和微信认证"><a href="#2-实现QQ认证和微信认证" class="headerlink" title="2.实现QQ认证和微信认证"></a>2.实现QQ认证和微信认证</h2><h3 id="QQ认证"><a href="#QQ认证" class="headerlink" title="QQ认证"></a>QQ认证</h3><p>参考：<br><a href="https://wiki.connect.qq.com/" target="_blank" rel="noopener">https://wiki.connect.qq.com/</a><br><img src="assets/SpringSecurity技术栈开发企业级认证与授权/47.jpg" alt="47"><br>spring-core:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class QQUserInfo &#123;</span><br><span class="line">	/**</span><br><span class="line">	 * 	返回码</span><br><span class="line">	 */</span><br><span class="line">	private String ret;</span><br><span class="line">	/**</span><br><span class="line">	 * 如果ret&lt;0，会有相应的错误信息提示，返回数据全部用UTF-8编码。</span><br><span class="line">	 */</span><br><span class="line">	private String msg;</span><br><span class="line">	/**</span><br><span class="line">	 *</span><br><span class="line">	 */</span><br><span class="line">	private String openId;</span><br><span class="line">	/**</span><br><span class="line">	 * 不知道什么东西，文档上没写，但是实际api返回里有。</span><br><span class="line">	 */</span><br><span class="line">	private String is_lost;</span><br><span class="line">	/**</span><br><span class="line">	 * 省(直辖市)</span><br><span class="line">	 */</span><br><span class="line">	private String province;</span><br><span class="line">	/**</span><br><span class="line">	 * 市(直辖市区)</span><br><span class="line">	 */</span><br><span class="line">	private String city;</span><br><span class="line">	/**</span><br><span class="line">	 * 出生年月</span><br><span class="line">	 */</span><br><span class="line">	private String year;</span><br><span class="line">	/**</span><br><span class="line">	 * 	用户在QQ空间的昵称。</span><br><span class="line">	 */</span><br><span class="line">	private String nickname;</span><br><span class="line">	/**</span><br><span class="line">	 * 	大小为30×30像素的QQ空间头像URL。</span><br><span class="line">	 */</span><br><span class="line">	private String figureurl;</span><br><span class="line">	/**</span><br><span class="line">	 * 	大小为50×50像素的QQ空间头像URL。</span><br><span class="line">	 */</span><br><span class="line">	private String figureurl_1;</span><br><span class="line">	/**</span><br><span class="line">	 * 	大小为100×100像素的QQ空间头像URL。</span><br><span class="line">	 */</span><br><span class="line">	private String figureurl_2;</span><br><span class="line">	/**</span><br><span class="line">	 * 	大小为40×40像素的QQ头像URL。</span><br><span class="line">	 */</span><br><span class="line">	private String figureurl_qq_1;</span><br><span class="line">	/**</span><br><span class="line">	 * 	大小为100×100像素的QQ头像URL。需要注意，不是所有的用户都拥有QQ的100×100的头像，但40×40像素则是一定会有。</span><br><span class="line">	 */</span><br><span class="line">	private String figureurl_qq_2;</span><br><span class="line">	/**</span><br><span class="line">	 * 	性别。 如果获取不到则默认返回”男”</span><br><span class="line">	 */</span><br><span class="line">	private String gender;</span><br><span class="line">	/**</span><br><span class="line">	 * 	标识用户是否为黄钻用户（0：不是；1：是）。</span><br><span class="line">	 */</span><br><span class="line">	private String is_yellow_vip;</span><br><span class="line">	/**</span><br><span class="line">	 * 	标识用户是否为黄钻用户（0：不是；1：是）</span><br><span class="line">	 */</span><br><span class="line">	private String vip;</span><br><span class="line">	/**</span><br><span class="line">	 * 	黄钻等级</span><br><span class="line">	 */</span><br><span class="line">	private String yellow_vip_level;</span><br><span class="line">	/**</span><br><span class="line">	 * 	黄钻等级</span><br><span class="line">	 */</span><br><span class="line">	private String level;</span><br><span class="line">	/**</span><br><span class="line">	 * 标识是否为年费黄钻用户（0：不是； 1：是）</span><br><span class="line">	 */</span><br><span class="line">	private String is_yellow_year_vip;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface QQ &#123;</span><br><span class="line">	QQUserInfo getUserInfo();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">public class QQImpl extends AbstractOAuth2ApiBinding implements QQ &#123;</span><br><span class="line">	private static final String URL_GET_OPENID = &quot;https://graph.qq.com/oauth2.0/me?access_token=%s&quot;;</span><br><span class="line"></span><br><span class="line">	private static final String URL_GET_USERINFO = &quot;https://graph.qq.com/user/get_user_info?oauth_consumer_key=%s&amp;openid=%s&quot;;</span><br><span class="line"></span><br><span class="line">	private String appId;</span><br><span class="line"></span><br><span class="line">	private String openId;</span><br><span class="line"></span><br><span class="line">	private ObjectMapper objectMapper = new ObjectMapper();</span><br><span class="line"></span><br><span class="line">	public QQImpl(String accessToken, String appId) &#123;</span><br><span class="line">		super(accessToken, TokenStrategy.ACCESS_TOKEN_PARAMETER);</span><br><span class="line"></span><br><span class="line">		this.appId = appId;</span><br><span class="line"></span><br><span class="line">		String url = String.format(URL_GET_OPENID, accessToken);</span><br><span class="line">		String result = getRestTemplate().getForObject(url, String.class);</span><br><span class="line"></span><br><span class="line">		this.openId = StringUtils.substringBetween(result, &quot;\&quot;openid\&quot;:\&quot;&quot;, &quot;\&quot;&#125;&quot;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public QQUserInfo getUserInfo() &#123;</span><br><span class="line"></span><br><span class="line">		String url = String.format(URL_GET_USERINFO, appId, openId);</span><br><span class="line">		String result = getRestTemplate().getForObject(url, String.class);</span><br><span class="line"></span><br><span class="line">		QQUserInfo userInfo = null;</span><br><span class="line">		try &#123;</span><br><span class="line">			userInfo = objectMapper.readValue(result, QQUserInfo.class);</span><br><span class="line">			userInfo.setOpenId(openId);</span><br><span class="line">			return userInfo;</span><br><span class="line">		&#125; catch (Exception e) &#123;</span><br><span class="line">			throw new RuntimeException(&quot;获取用户信息失败&quot;, e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">public class QQOAuth2Template extends OAuth2Template &#123;</span><br><span class="line">	private Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">	public QQOAuth2Template(String clientId, String clientSecret, String authorizeUrl, String accessTokenUrl) &#123;</span><br><span class="line">		super(clientId, clientSecret, authorizeUrl, accessTokenUrl);</span><br><span class="line">		setUseParametersForClientAuthentication(true);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	protected AccessGrant postForAccessGrant(String accessTokenUrl, MultiValueMap&lt;String, String&gt; parameters) &#123;</span><br><span class="line">		String responseStr = getRestTemplate().postForObject(accessTokenUrl, parameters, String.class);</span><br><span class="line"></span><br><span class="line">		logger.info(&quot;获取accessToke的响应：&quot;+responseStr);</span><br><span class="line"></span><br><span class="line">		String[] items = StringUtils.splitByWholeSeparatorPreserveAllTokens(responseStr, &quot;&amp;&quot;);</span><br><span class="line"></span><br><span class="line">		String accessToken = StringUtils.substringAfterLast(items[0], &quot;=&quot;);</span><br><span class="line">		Long expiresIn = new Long(StringUtils.substringAfterLast(items[1], &quot;=&quot;));</span><br><span class="line">		String refreshToken = StringUtils.substringAfterLast(items[2], &quot;=&quot;);</span><br><span class="line"></span><br><span class="line">		return new AccessGrant(accessToken, null, refreshToken, expiresIn);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	protected RestTemplate createRestTemplate() &#123;</span><br><span class="line">		RestTemplate restTemplate = super.createRestTemplate();</span><br><span class="line">		restTemplate.getMessageConverters().add(new StringHttpMessageConverter(Charset.forName(&quot;UTF-8&quot;)));</span><br><span class="line">		return restTemplate;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public class QQServiceProvider extends AbstractOAuth2ServiceProvider&lt;QQ&gt; &#123;</span><br><span class="line">	private String appId;</span><br><span class="line"></span><br><span class="line">	private static final String URL_AUTHORIZE = &quot;https://graph.qq.com/oauth2.0/authorize&quot;;</span><br><span class="line"></span><br><span class="line">	private static final String URL_ACCESS_TOKEN = &quot;https://graph.qq.com/oauth2.0/token&quot;;</span><br><span class="line"></span><br><span class="line">	public QQServiceProvider(String appId, String appSecret) &#123;</span><br><span class="line">		super(new QQOAuth2Template(appId, appSecret, URL_AUTHORIZE, URL_ACCESS_TOKEN));</span><br><span class="line">		this.appId = appId;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public QQ getApi(String accessToken) &#123;</span><br><span class="line">		return new QQImpl(accessToken, appId);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public class QQAdapter implements ApiAdapter&lt;QQ&gt; &#123;</span><br><span class="line">	@Override</span><br><span class="line">	public boolean test(QQ api) &#123;</span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void setConnectionValues(QQ api, ConnectionValues values) &#123;</span><br><span class="line">		QQUserInfo userInfo = api.getUserInfo();</span><br><span class="line"></span><br><span class="line">		values.setDisplayName(userInfo.getNickname());</span><br><span class="line">		values.setImageUrl(userInfo.getFigureurl_qq_1());</span><br><span class="line">		values.setProfileUrl(null);</span><br><span class="line">		values.setProviderUserId(userInfo.getOpenId());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public UserProfile fetchUserProfile(QQ api) &#123;</span><br><span class="line">		// TODO Auto-generated method stub</span><br><span class="line">		return null;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void updateStatus(QQ api, String message) &#123;</span><br><span class="line">		//do noting</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public class QQConnectionFactory extends OAuth2ConnectionFactory&lt;QQ&gt; &#123;</span><br><span class="line">	public QQConnectionFactory(String providerId, String appId, String appSecret) &#123;</span><br><span class="line">		super(providerId, new QQServiceProvider(appId, appSecret), new QQAdapter());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public class QQProperties extends SocialProperties &#123;</span><br><span class="line">	private String providerId = &quot;qq&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class SocialProperties &#123;</span><br><span class="line">  private String filterProcessesUrl = &quot;/auth&quot;;</span><br><span class="line"></span><br><span class="line">  private QQProperties qq = new QQProperties();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class BrowserProperties &#123;</span><br><span class="line">  ...</span><br><span class="line">  private String signUpUrl = &quot;/my-signUp.html&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">@ConfigurationProperties(prefix = &quot;security&quot;)</span><br><span class="line">public class SecurityProperties &#123;</span><br><span class="line">  ...</span><br><span class="line">  private SocialProperties social = new SocialProperties();</span><br><span class="line">  private BrowserProperties browser = new BrowserProperties();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public class MySpringSocialConfigurer extends SpringSocialConfigurer &#123;</span><br><span class="line">	private String filterProcessesUrl;</span><br><span class="line"></span><br><span class="line">	public MySpringSocialConfigurer(String filterProcessesUrl) &#123;</span><br><span class="line">		this.filterProcessesUrl = filterProcessesUrl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">	@Override</span><br><span class="line">	protected &lt;T&gt; T postProcess(T object) &#123;</span><br><span class="line">		SocialAuthenticationFilter filter = (SocialAuthenticationFilter) super.postProcess(object);</span><br><span class="line">		filter.setFilterProcessesUrl(filterProcessesUrl);</span><br><span class="line">		return (T) filter;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@EnableSocial</span><br><span class="line">public class SocialConfig extends SocialConfigurerAdapter &#123;</span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">	private DataSource dataSource;</span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">	private SecurityProperties securityProperties;</span><br><span class="line"></span><br><span class="line">	@Autowired(required = false)</span><br><span class="line">	private ConnectionSignUp connectionSignUp;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public UsersConnectionRepository getUsersConnectionRepository(ConnectionFactoryLocator connectionFactoryLocator) &#123;</span><br><span class="line">		JdbcUsersConnectionRepository repository = new JdbcUsersConnectionRepository(dataSource,</span><br><span class="line">				connectionFactoryLocator, Encryptors.noOpText());</span><br><span class="line">		repository.setTablePrefix(&quot;my_&quot;);</span><br><span class="line">		if(connectionSignUp != null) &#123;</span><br><span class="line">			repository.setConnectionSignUp(connectionSignUp);</span><br><span class="line">		&#125;</span><br><span class="line">		return repository;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Bean</span><br><span class="line">	public SpringSocialConfigurer mySocialSecurityConfig() &#123;</span><br><span class="line">		String filterProcessesUrl = securityProperties.getSocial().getFilterProcessesUrl();</span><br><span class="line">		MySpringSocialConfigurer configurer = new MySpringSocialConfigurer(filterProcessesUrl);</span><br><span class="line">		configurer.signupUrl(securityProperties.getBrowser().getSignUpUrl());</span><br><span class="line">		return configurer;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Bean</span><br><span class="line">	public ProviderSignInUtils providerSignInUtils(ConnectionFactoryLocator connectionFactoryLocator) &#123;</span><br><span class="line">		return new ProviderSignInUtils(connectionFactoryLocator,</span><br><span class="line">				getUsersConnectionRepository(connectionFactoryLocator)) &#123;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>org/springframework/social/spring-social-core/1.1.4.RELEASE/spring-social-core-1.1.4.RELEASE.jar!/org/springframework/social/connect/jdbc/JdbcUsersConnectionRepository.sql:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">create table UserConnection (userId varchar(255) not null,</span><br><span class="line">	providerId varchar(255) not null,</span><br><span class="line">	providerUserId varchar(255),</span><br><span class="line">	rank int not null,</span><br><span class="line">	displayName varchar(255),</span><br><span class="line">	profileUrl varchar(512),</span><br><span class="line">	imageUrl varchar(512),</span><br><span class="line">	accessToken varchar(512) not null,</span><br><span class="line">	secret varchar(512),</span><br><span class="line">	refreshToken varchar(512),</span><br><span class="line">	expireTime bigint,</span><br><span class="line">	primary key (userId, providerId, providerUserId));</span><br><span class="line">create unique index UserConnectionRank on UserConnection(userId, providerId, rank);</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@ConditionalOnProperty(prefix = &quot;security.social.qq&quot;, name = &quot;app-id&quot;)</span><br><span class="line">public class QQAutoConfig extends SocialAutoConfigurerAdapter &#123;</span><br><span class="line">	@Autowired</span><br><span class="line">	private SecurityProperties securityProperties;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	protected ConnectionFactory&lt;?&gt; createConnectionFactory() &#123;</span><br><span class="line">		QQProperties qqConfig = securityProperties.getSocial().getQq();</span><br><span class="line">		return new QQConnectionFactory(qqConfig.getProviderId(), qqConfig.getAppId(), qqConfig.getAppSecret());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>spring-browser:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class BrowserSecurityConfig extends AbstractChannelSecurityConfig &#123;</span><br><span class="line">  ...</span><br><span class="line">  @Autowired</span><br><span class="line">  private SpringSocialConfigurer mySocialSecurityConfig;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">	protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line">      http.apply(mySocialSecurityConfig)</span><br><span class="line">          .and()</span><br><span class="line">          .authorizeRequests()</span><br><span class="line">          .antMatchers(</span><br><span class="line">            securityProperties.getBrowser().getSignUpUrl(),</span><br><span class="line">            &quot;/user/regist&quot;</span><br><span class="line">          )</span><br><span class="line">          .permitAll()</span><br><span class="line">          ...</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class SocialUserInfo &#123;</span><br><span class="line">	private String providerId;</span><br><span class="line"></span><br><span class="line">	private String providerUserId;</span><br><span class="line"></span><br><span class="line">	private String nickname;</span><br><span class="line"></span><br><span class="line">	private String headimg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class BrowserSecurityController &#123;</span><br><span class="line">	@Autowired</span><br><span class="line">	private ProviderSignInUtils providerSignInUtils;</span><br><span class="line"></span><br><span class="line">	@GetMapping(&quot;/social/user&quot;)</span><br><span class="line">	public SocialUserInfo getSocialUserInfo(HttpServletRequest request) &#123;</span><br><span class="line">		SocialUserInfo userInfo = new SocialUserInfo();</span><br><span class="line">		Connection&lt;?&gt; connection = providerSignInUtils.getConnectionFromSession(new ServletWebRequest(request));</span><br><span class="line">		userInfo.setProviderId(connection.getKey().getProviderId());</span><br><span class="line">		userInfo.setProviderUserId(connection.getKey().getProviderUserId());</span><br><span class="line">		userInfo.setNickname(connection.getDisplayName());</span><br><span class="line">		userInfo.setHeadimg(connection.getImageUrl());</span><br><span class="line">		return userInfo;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>my-signIn.html<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">&lt;title&gt;登录&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;h3&gt;社交登录&lt;/h3&gt;</span><br><span class="line">  &lt;a href=&quot;/qqLogin/callback.do&quot;&gt;QQ登录&lt;/a&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>spring-demo:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class DemoConnectionSignUp implements ConnectionSignUp &#123;</span><br><span class="line">	@Override</span><br><span class="line">	public String execute(Connection&lt;?&gt; connection) &#123;</span><br><span class="line">		//根据社交用户信息默认创建用户并返回用户唯一标识</span><br><span class="line">		return connection.getDisplayName();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class MyUserDetailsService implements UserDetailsService, SocialUserDetailsService &#123;</span><br><span class="line">	private Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">	private PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123;</span><br><span class="line">		logger.info(&quot;表单登录用户名:&quot; + username);</span><br><span class="line">		return buildUser(username);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public SocialUserDetails loadUserByUserId(String userId) throws UsernameNotFoundException &#123;</span><br><span class="line">		logger.info(&quot;设计登录用户Id:&quot; + userId);</span><br><span class="line">		return buildUser(userId);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	private SocialUserDetails buildUser(String userId) &#123;</span><br><span class="line">		// 根据用户名查找用户信息</span><br><span class="line">		//根据查找到的用户信息判断用户是否被冻结</span><br><span class="line">		String password = passwordEncoder.encode(&quot;123456&quot;);</span><br><span class="line">		logger.info(&quot;数据库密码是:&quot;+password);</span><br><span class="line">		return new SocialUser(userId, password,</span><br><span class="line">				true, true, true, true,</span><br><span class="line">				AuthorityUtils.commaSeparatedStringToAuthorityList(&quot;admin&quot;));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/user&quot;)</span><br><span class="line">public class UserController &#123;</span><br><span class="line">  @Autowired</span><br><span class="line">  private ProviderSignInUtils providerSignInUtils;</span><br><span class="line"></span><br><span class="line">  @PostMapping(&quot;/regist&quot;)</span><br><span class="line">  public void regist(User user, HttpServletRequest request) &#123;</span><br><span class="line"></span><br><span class="line">    //不管是注册用户还是绑定用户，都会拿到一个用户唯一标识。</span><br><span class="line">    String userId = user.getUsername();</span><br><span class="line">    providerSignInUtils.doPostSignUp(userId, new ServletWebRequest(request));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="assets/SpringSecurity技术栈开发企业级认证与授权/46.jpg" alt="46"><br>application.properties:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">security.social.qq.app-id =</span><br><span class="line">security.social.qq.app-secret =</span><br><span class="line">security.social.qq.providerId = callback.do</span><br><span class="line"></span><br><span class="line">security.browser.signUpUrl = /demo-signUp.html</span><br><span class="line"></span><br><span class="line">security.social.filterProcessesUrl = /qqLogin</span><br></pre></td></tr></table></figure></p>
<p>demo-signUp.html:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">&lt;title&gt;登录&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">	&lt;h2&gt;Demo注册页&lt;/h2&gt;</span><br><span class="line"></span><br><span class="line">	&lt;form action=&quot;/user/regist&quot; method=&quot;post&quot;&gt;</span><br><span class="line">		&lt;table&gt;</span><br><span class="line">			&lt;tr&gt;</span><br><span class="line">				&lt;td&gt;用户名:&lt;/td&gt;</span><br><span class="line">				&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;username&quot;&gt;&lt;/td&gt;</span><br><span class="line">			&lt;/tr&gt;</span><br><span class="line">			&lt;tr&gt;</span><br><span class="line">				&lt;td&gt;密码:&lt;/td&gt;</span><br><span class="line">				&lt;td&gt;&lt;input type=&quot;password&quot; name=&quot;password&quot;&gt;&lt;/td&gt;</span><br><span class="line">			&lt;/tr&gt;</span><br><span class="line">			&lt;tr&gt;</span><br><span class="line">				&lt;td colspan=&quot;2&quot;&gt;</span><br><span class="line">					&lt;button type=&quot;submit&quot; name=&quot;type&quot; value=&quot;regist&quot;&gt;注册&lt;/button&gt;</span><br><span class="line">					&lt;button type=&quot;submit&quot; name=&quot;type&quot; value=&quot;binding&quot;&gt;绑定&lt;/button&gt;</span><br><span class="line">				&lt;/td&gt;</span><br><span class="line">			&lt;/tr&gt;</span><br><span class="line">		&lt;/table&gt;</span><br><span class="line">	&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="微信认证"><a href="#微信认证" class="headerlink" title="微信认证"></a>微信认证</h3><p>spring-core:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class WeixinUserInfo &#123;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 普通用户的标识，对当前开发者帐号唯一</span><br><span class="line">	 */</span><br><span class="line">	private String openid;</span><br><span class="line">	/**</span><br><span class="line">	 * 普通用户昵称</span><br><span class="line">	 */</span><br><span class="line">	private String nickname;</span><br><span class="line">	/**</span><br><span class="line">	 * 语言</span><br><span class="line">	 */</span><br><span class="line">	private String language;</span><br><span class="line">	/**</span><br><span class="line">	 * 普通用户性别，1为男性，2为女性</span><br><span class="line">	 */</span><br><span class="line">	private String sex;</span><br><span class="line">	/**</span><br><span class="line">	 * 普通用户个人资料填写的省份</span><br><span class="line">	 */</span><br><span class="line">	private String province;</span><br><span class="line">	/**</span><br><span class="line">	 * 普通用户个人资料填写的城市</span><br><span class="line">	 */</span><br><span class="line">	private String city;</span><br><span class="line">	/**</span><br><span class="line">	 * 国家，如中国为CN</span><br><span class="line">	 */</span><br><span class="line">	private String country;</span><br><span class="line">	/**</span><br><span class="line">	 * 用户头像，最后一个数值代表正方形头像大小（有0、46、64、96、132数值可选，0代表640*640正方形头像），用户没有头像时该项为空</span><br><span class="line">	 */</span><br><span class="line">	private String headimgurl;</span><br><span class="line">	/**</span><br><span class="line">	 * 用户特权信息，json数组，如微信沃卡用户为（chinaunicom）</span><br><span class="line">	 */</span><br><span class="line">	private String[] privilege;</span><br><span class="line">	/**</span><br><span class="line">	 * 用户统一标识。针对一个微信开放平台帐号下的应用，同一用户的unionid是唯一的。</span><br><span class="line">	 */</span><br><span class="line">	private String unionid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface Weixin &#123;</span><br><span class="line">	WeixinUserInfo getUserInfo(String openId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Weixin API调用模板， scope为Request的Spring bean, 根据当前用户的accessToken创建。</span><br><span class="line"> */</span><br><span class="line">public class WeixinImpl extends AbstractOAuth2ApiBinding implements Weixin &#123;</span><br><span class="line">	/**</span><br><span class="line">	 *</span><br><span class="line">	 */</span><br><span class="line">	private ObjectMapper objectMapper = new ObjectMapper();</span><br><span class="line">	/**</span><br><span class="line">	 * 获取用户信息的url</span><br><span class="line">	 */</span><br><span class="line">	private static final String URL_GET_USER_INFO = &quot;https://api.weixin.qq.com/sns/userinfo?openid=&quot;;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * @param accessToken</span><br><span class="line">	 */</span><br><span class="line">	public WeixinImpl(String accessToken) &#123;</span><br><span class="line">		super(accessToken, TokenStrategy.ACCESS_TOKEN_PARAMETER);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 默认注册的StringHttpMessageConverter字符集为ISO-8859-1，而微信返回的是UTF-8的，所以覆盖了原来的方法。</span><br><span class="line">	 */</span><br><span class="line">	protected List&lt;HttpMessageConverter&lt;?&gt;&gt; getMessageConverters() &#123;</span><br><span class="line">		List&lt;HttpMessageConverter&lt;?&gt;&gt; messageConverters = super.getMessageConverters();</span><br><span class="line">		messageConverters.remove(0);</span><br><span class="line">		messageConverters.add(new StringHttpMessageConverter(Charset.forName(&quot;UTF-8&quot;)));</span><br><span class="line">		return messageConverters;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 获取微信用户信息。</span><br><span class="line">	 */</span><br><span class="line">	@Override</span><br><span class="line">	public WeixinUserInfo getUserInfo(String openId) &#123;</span><br><span class="line">		String url = URL_GET_USER_INFO + openId;</span><br><span class="line">		String response = getRestTemplate().getForObject(url, String.class);</span><br><span class="line">		if(StringUtils.contains(response, &quot;errcode&quot;)) &#123;</span><br><span class="line">			return null;</span><br><span class="line">		&#125;</span><br><span class="line">		WeixinUserInfo profile = null;</span><br><span class="line">		try &#123;</span><br><span class="line">			profile = objectMapper.readValue(response, WeixinUserInfo.class);</span><br><span class="line">		&#125; catch (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		return profile;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class WeixinProperties extends SocialProperties &#123;</span><br><span class="line">	/**</span><br><span class="line">	 * 第三方id，用来决定发起第三方登录的url，默认是 weixin。</span><br><span class="line">	 */</span><br><span class="line">	private String providerId = &quot;weixin&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class SocialProperties &#123;</span><br><span class="line">  private String filterProcessesUrl = &quot;/auth&quot;;</span><br><span class="line">  ...</span><br><span class="line">  private WeixinProperties weixin = new WeixinProperties();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 微信的access_token信息。与标准OAuth2协议不同，微信在获取access_token时会同时返回openId,并没有单独的通过accessToke换取openId的服务</span><br><span class="line"> *</span><br><span class="line"> * 所以在这里继承了标准AccessGrant，添加了openId字段，作为对微信access_token信息的封装。</span><br><span class="line"> */</span><br><span class="line">@Data</span><br><span class="line">public class WeixinAccessGrant extends AccessGrant &#123;</span><br><span class="line">	private static final long serialVersionUID = -7243374526633186782L;</span><br><span class="line"></span><br><span class="line">	private String openId;</span><br><span class="line"></span><br><span class="line">	public WeixinAccessGrant() &#123;</span><br><span class="line">		super(&quot;&quot;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public WeixinAccessGrant(String accessToken, String scope, String refreshToken, Long expiresIn) &#123;</span><br><span class="line">		super(accessToken, scope, refreshToken, expiresIn);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 完成微信的OAuth2认证流程的模板类。国内厂商实现的OAuth2每个都不同, spring默认提供的OAuth2Template适应不了，只能针对每个厂商自己微调。</span><br><span class="line"> */</span><br><span class="line">public class WeixinOAuth2Template extends OAuth2Template &#123;</span><br><span class="line">	private String clientId;</span><br><span class="line"></span><br><span class="line">	private String clientSecret;</span><br><span class="line"></span><br><span class="line">	private String accessTokenUrl;</span><br><span class="line"></span><br><span class="line">	private static final String REFRESH_TOKEN_URL = &quot;https://api.weixin.qq.com/sns/oauth2/refresh_token&quot;;</span><br><span class="line"></span><br><span class="line">	private Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">	public WeixinOAuth2Template(String clientId, String clientSecret, String authorizeUrl, String accessTokenUrl) &#123;</span><br><span class="line">		super(clientId, clientSecret, authorizeUrl, accessTokenUrl);</span><br><span class="line">		setUseParametersForClientAuthentication(true);</span><br><span class="line">		this.clientId = clientId;</span><br><span class="line">		this.clientSecret = clientSecret;</span><br><span class="line">		this.accessTokenUrl = accessTokenUrl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public AccessGrant exchangeForAccess(String authorizationCode, String redirectUri,</span><br><span class="line">			MultiValueMap&lt;String, String&gt; parameters) &#123;</span><br><span class="line"></span><br><span class="line">		StringBuilder accessTokenRequestUrl = new StringBuilder(accessTokenUrl);</span><br><span class="line"></span><br><span class="line">		accessTokenRequestUrl.append(&quot;?appid=&quot;+clientId);</span><br><span class="line">		accessTokenRequestUrl.append(&quot;&amp;secret=&quot;+clientSecret);</span><br><span class="line">		accessTokenRequestUrl.append(&quot;&amp;code=&quot;+authorizationCode);</span><br><span class="line">		accessTokenRequestUrl.append(&quot;&amp;grant_type=authorization_code&quot;);</span><br><span class="line">		accessTokenRequestUrl.append(&quot;&amp;redirect_uri=&quot;+redirectUri);</span><br><span class="line"></span><br><span class="line">		return getAccessToken(accessTokenRequestUrl);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public AccessGrant refreshAccess(String refreshToken, MultiValueMap&lt;String, String&gt; additionalParameters) &#123;</span><br><span class="line"></span><br><span class="line">		StringBuilder refreshTokenUrl = new StringBuilder(REFRESH_TOKEN_URL);</span><br><span class="line"></span><br><span class="line">		refreshTokenUrl.append(&quot;?appid=&quot;+clientId);</span><br><span class="line">		refreshTokenUrl.append(&quot;&amp;grant_type=refresh_token&quot;);</span><br><span class="line">		refreshTokenUrl.append(&quot;&amp;refresh_token=&quot;+refreshToken);</span><br><span class="line"></span><br><span class="line">		return getAccessToken(refreshTokenUrl);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">	private AccessGrant getAccessToken(StringBuilder accessTokenRequestUrl) &#123;</span><br><span class="line"></span><br><span class="line">		logger.info(&quot;获取access_token, 请求URL: &quot;+accessTokenRequestUrl.toString());</span><br><span class="line"></span><br><span class="line">		String response = getRestTemplate().getForObject(accessTokenRequestUrl.toString(), String.class);</span><br><span class="line"></span><br><span class="line">		logger.info(&quot;获取access_token, 响应内容: &quot;+response);</span><br><span class="line"></span><br><span class="line">		Map&lt;String, Object&gt; result = null;</span><br><span class="line">		try &#123;</span><br><span class="line">			result = new ObjectMapper().readValue(response, Map.class);</span><br><span class="line">		&#125; catch (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		//返回错误码时直接返回空</span><br><span class="line">		if(StringUtils.isNotBlank(MapUtils.getString(result, &quot;errcode&quot;)))&#123;</span><br><span class="line">			String errcode = MapUtils.getString(result, &quot;errcode&quot;);</span><br><span class="line">			String errmsg = MapUtils.getString(result, &quot;errmsg&quot;);</span><br><span class="line">			throw new RuntimeException(&quot;获取access token失败, errcode:&quot;+errcode+&quot;, errmsg:&quot;+errmsg);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		WeixinAccessGrant accessToken = new WeixinAccessGrant(</span><br><span class="line">				MapUtils.getString(result, &quot;access_token&quot;),</span><br><span class="line">				MapUtils.getString(result, &quot;scope&quot;),</span><br><span class="line">				MapUtils.getString(result, &quot;refresh_token&quot;),</span><br><span class="line">				MapUtils.getLong(result, &quot;expires_in&quot;));</span><br><span class="line"></span><br><span class="line">		accessToken.setOpenId(MapUtils.getString(result, &quot;openid&quot;));</span><br><span class="line"></span><br><span class="line">		return accessToken;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 构建获取授权码的请求。也就是引导用户跳转到微信的地址。</span><br><span class="line">	 */</span><br><span class="line">	public String buildAuthenticateUrl(OAuth2Parameters parameters) &#123;</span><br><span class="line">		String url = super.buildAuthenticateUrl(parameters);</span><br><span class="line">		url = url + &quot;&amp;appid=&quot;+clientId+&quot;&amp;scope=snsapi_login&quot;;</span><br><span class="line">		return url;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public String buildAuthorizeUrl(OAuth2Parameters parameters) &#123;</span><br><span class="line">		return buildAuthenticateUrl(parameters);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 微信返回的contentType是html/text，添加相应的HttpMessageConverter来处理。</span><br><span class="line">	 */</span><br><span class="line">	protected RestTemplate createRestTemplate() &#123;</span><br><span class="line">		RestTemplate restTemplate = super.createRestTemplate();</span><br><span class="line">		restTemplate.getMessageConverters().add(new StringHttpMessageConverter(Charset.forName(&quot;UTF-8&quot;)));</span><br><span class="line">		return restTemplate;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 微信 api适配器，将微信 api的数据模型转为spring social的标准模型。</span><br><span class="line"> */</span><br><span class="line">public class WeixinAdapter implements ApiAdapter&lt;Weixin&gt; &#123;</span><br><span class="line">	private String openId;</span><br><span class="line"></span><br><span class="line">	public WeixinAdapter() &#123;&#125;</span><br><span class="line"></span><br><span class="line">	public WeixinAdapter(String openId)&#123;</span><br><span class="line">		this.openId = openId;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public boolean test(Weixin api) &#123;</span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void setConnectionValues(Weixin api, ConnectionValues values) &#123;</span><br><span class="line">		WeixinUserInfo profile = api.getUserInfo(openId);</span><br><span class="line">		values.setProviderUserId(profile.getOpenid());</span><br><span class="line">		values.setDisplayName(profile.getNickname());</span><br><span class="line">		values.setImageUrl(profile.getHeadimgurl());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public UserProfile fetchUserProfile(Weixin api) &#123;</span><br><span class="line">		return null;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void updateStatus(Weixin api, String message) &#123;</span><br><span class="line">		//do nothing</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 微信的OAuth2流程处理器的提供器，供spring social的connect体系调用</span><br><span class="line"> */</span><br><span class="line">public class WeixinServiceProvider extends AbstractOAuth2ServiceProvider&lt;Weixin&gt; &#123;</span><br><span class="line">	/**</span><br><span class="line">	 * 微信获取授权码的url</span><br><span class="line">	 */</span><br><span class="line">	private static final String URL_AUTHORIZE = &quot;https://open.weixin.qq.com/connect/qrconnect&quot;;</span><br><span class="line">	/**</span><br><span class="line">	 * 微信获取accessToken的url</span><br><span class="line">	 */</span><br><span class="line">	private static final String URL_ACCESS_TOKEN = &quot;https://api.weixin.qq.com/sns/oauth2/access_token&quot;;</span><br><span class="line"></span><br><span class="line">	public WeixinServiceProvider(String appId, String appSecret) &#123;</span><br><span class="line">		super(new WeixinOAuth2Template(appId, appSecret,URL_AUTHORIZE,URL_ACCESS_TOKEN));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public Weixin getApi(String accessToken) &#123;</span><br><span class="line">		return new WeixinImpl(accessToken);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 微信连接工厂</span><br><span class="line"> */</span><br><span class="line">public class WeixinConnectionFactory extends OAuth2ConnectionFactory&lt;Weixin&gt; &#123;</span><br><span class="line"></span><br><span class="line">	public WeixinConnectionFactory(String providerId, String appId, String appSecret) &#123;</span><br><span class="line">		super(providerId, new WeixinServiceProvider(appId, appSecret), new WeixinAdapter());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 由于微信的openId是和accessToken一起返回的，所以在这里直接根据accessToken设置providerUserId即可，不用像QQ那样通过QQAdapter来获取</span><br><span class="line">	 */</span><br><span class="line">	@Override</span><br><span class="line">	protected String extractProviderUserId(AccessGrant accessGrant) &#123;</span><br><span class="line">		if(accessGrant instanceof WeixinAccessGrant) &#123;</span><br><span class="line">			return ((WeixinAccessGrant)accessGrant).getOpenId();</span><br><span class="line">		&#125;</span><br><span class="line">		return null;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public Connection&lt;Weixin&gt; createConnection(AccessGrant accessGrant) &#123;</span><br><span class="line">		return new OAuth2Connection&lt;Weixin&gt;(getProviderId(), extractProviderUserId(accessGrant), accessGrant.getAccessToken(),</span><br><span class="line">				accessGrant.getRefreshToken(), accessGrant.getExpireTime(), getOAuth2ServiceProvider(), getApiAdapter(extractProviderUserId(accessGrant)));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public Connection&lt;Weixin&gt; createConnection(ConnectionData data) &#123;</span><br><span class="line">		return new OAuth2Connection&lt;Weixin&gt;(data, getOAuth2ServiceProvider(), getApiAdapter(data.getProviderUserId()));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	private ApiAdapter&lt;Weixin&gt; getApiAdapter(String providerUserId) &#123;</span><br><span class="line">		return new WeixinAdapter(providerUserId);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	private OAuth2ServiceProvider&lt;Weixin&gt; getOAuth2ServiceProvider() &#123;</span><br><span class="line">		return (OAuth2ServiceProvider&lt;Weixin&gt;) getServiceProvider();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 微信登录配置</span><br><span class="line"> */</span><br><span class="line">@Configuration</span><br><span class="line">@ConditionalOnProperty(prefix = &quot;security.social.weixin&quot;, name = &quot;app-id&quot;)</span><br><span class="line">public class WeixinAutoConfiguration extends SocialAutoConfigurerAdapter &#123;</span><br><span class="line">	@Autowired</span><br><span class="line">	private SecurityProperties securityProperties;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	protected ConnectionFactory&lt;?&gt; createConnectionFactory() &#123;</span><br><span class="line">		WeixinProperties weixinConfig = securityProperties.getSocial().getWeixin();</span><br><span class="line">		return new WeixinConnectionFactory(weixinConfig.getProviderId(), weixinConfig.getAppId(),</span><br><span class="line">				weixinConfig.getAppSecret());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Bean(&#123;&quot;connect/weixinConnect&quot;, &quot;connect/weixinConnected&quot;&#125;)</span><br><span class="line">	@ConditionalOnMissingBean(name = &quot;weixinConnectedView&quot;)</span><br><span class="line">	public View weixinConnectedView() &#123;</span><br><span class="line">		return new MyConnectView();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public class MyConnectView extends AbstractView &#123;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	protected void renderMergedOutputModel(Map&lt;String, Object&gt; model, HttpServletRequest request,</span><br><span class="line">			HttpServletResponse response) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">		response.setContentType(&quot;text/html;charset=UTF-8&quot;);</span><br><span class="line">		if (model.get(&quot;connection&quot;) == null) &#123;</span><br><span class="line">			response.getWriter().write(&quot;&lt;h3&gt;解绑成功&lt;/h3&gt;&quot;);</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			response.getWriter().write(&quot;&lt;h3&gt;绑定成功&lt;/h3&gt;&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@Component(&quot;connect/status&quot;)</span><br><span class="line">public class MyConnectionStatusView extends AbstractView &#123;</span><br><span class="line">	@Autowired</span><br><span class="line">	private ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">	@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">	@Override</span><br><span class="line">	protected void renderMergedOutputModel(Map&lt;String, Object&gt; model, HttpServletRequest request,</span><br><span class="line">			HttpServletResponse response) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">		Map&lt;String, List&lt;Connection&lt;?&gt;&gt;&gt; connections = (Map&lt;String, List&lt;Connection&lt;?&gt;&gt;&gt;) model.get(&quot;connectionMap&quot;);</span><br><span class="line"></span><br><span class="line">		Map&lt;String, Boolean&gt; result = new HashMap&lt;&gt;();</span><br><span class="line">		for (String key : connections.keySet()) &#123;</span><br><span class="line">			result.put(key, CollectionUtils.isNotEmpty(connections.get(key)));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		response.setContentType(&quot;application/json;charset=UTF-8&quot;);</span><br><span class="line">		response.getWriter().write(objectMapper.writeValueAsString(result));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>spring-browser:<br>my-signIn.html:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">&lt;title&gt;登录&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">...</span><br><span class="line">&lt;a href=&quot;/qqLogin/weixin&quot;&gt;微信登录&lt;/a&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>my-banding.html:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">&lt;title&gt;登录&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">	&lt;h2&gt;标准绑定页面&lt;/h2&gt;</span><br><span class="line">	&lt;form action=&quot;/connect/weixin&quot; method=&quot;post&quot;&gt;</span><br><span class="line">		&lt;button type=&quot;submit&quot;&gt;绑定微信&lt;/button&gt;</span><br><span class="line">	&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>spring-demo:<br>application.properties:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">security.social.weixin.app-id = wxd99431bbff8305a0</span><br><span class="line">security.social.weixin.app-secret = 60f78681d063590a469f1b297feff3c4</span><br></pre></td></tr></table></figure></p>
<h2 id="3-SESSION管理及退出"><a href="#3-SESSION管理及退出" class="headerlink" title="3.SESSION管理及退出"></a>3.SESSION管理及退出</h2><h3 id="Session超时处理"><a href="#Session超时处理" class="headerlink" title="Session超时处理"></a>Session超时处理</h3><h3 id="Session并发控制"><a href="#Session并发控制" class="headerlink" title="Session并发控制"></a>Session并发控制</h3><h3 id="集群Session管理"><a href="#集群Session管理" class="headerlink" title="集群Session管理"></a>集群Session管理</h3>
                    
                        

                    
                    
                        <p>
                            <a href="/2020/04/09/Spring Social开发第三方认证/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2020/04/07/Spring Security技术栈开发企业级认证与授权-使用Spring MVC开发 RESTful API/">
                            SpringSecurity技术栈开发企业级认证与授权-使用Spring MVC开发 RESTful API
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2020-04-07T21:37:40+08:00">
	
		    4月 07, 2020
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="1-开发基本的增删改查接口"><a href="#1-开发基本的增删改查接口" class="headerlink" title="1.开发基本的增删改查接口"></a>1.开发基本的增删改查接口</h2><h3 id="使用Spring-MVC编写Restful-API"><a href="#使用Spring-MVC编写Restful-API" class="headerlink" title="使用Spring MVC编写Restful API"></a>使用Spring MVC编写Restful API</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/1.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/1.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/2.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/2.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h3 id="编写针对RestfulAPI的测试用例"><a href="#编写针对RestfulAPI的测试用例" class="headerlink" title="编写针对RestfulAPI的测试用例"></a>编写针对RestfulAPI的测试用例</h3><p>security-demo：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">@RunWith(SpringRunner.class)</span><br><span class="line">@SpringBootTest</span><br><span class="line">public class UserControllerTest &#123;</span><br><span class="line">	@Autowired</span><br><span class="line">	private WebApplicationContext wac;</span><br><span class="line">	private MockMvc mockMvc;</span><br><span class="line"></span><br><span class="line">	@Before</span><br><span class="line">	public void setup() &#123;</span><br><span class="line">		mockMvc = MockMvcBuilders.webAppContextSetup(wac).build();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Test</span><br><span class="line">	public void whenQuerySuccess() throws Exception &#123;</span><br><span class="line">		String result = mockMvc.perform(</span><br><span class="line">				get(&quot;/user&quot;).param(&quot;username&quot;, &quot;jojo&quot;).param(&quot;age&quot;, &quot;18&quot;).param(&quot;ageTo&quot;, &quot;60&quot;).param(&quot;xxx&quot;, &quot;yyy&quot;)</span><br><span class="line">						// .param(&quot;size&quot;, &quot;15&quot;)</span><br><span class="line">						// .param(&quot;page&quot;, &quot;3&quot;)</span><br><span class="line">						// .param(&quot;sort&quot;, &quot;age,desc&quot;)</span><br><span class="line">						.contentType(MediaType.APPLICATION_JSON_UTF8))</span><br><span class="line">				.andExpect(status().isOk()).andExpect(jsonPath(&quot;$.length()&quot;).value(3))</span><br><span class="line">				.andReturn().getResponse().getContentAsString();</span><br><span class="line"></span><br><span class="line">		System.out.println(result);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Test</span><br><span class="line">	public void whenGetInfoSuccess() throws Exception &#123;</span><br><span class="line">		String result = mockMvc.perform(get(&quot;/user/1&quot;)</span><br><span class="line">				.contentType(MediaType.APPLICATION_JSON_UTF8))</span><br><span class="line">				.andExpect(status().isOk())</span><br><span class="line">				.andExpect(jsonPath(&quot;$.username&quot;).value(&quot;tom&quot;))</span><br><span class="line">				.andReturn().getResponse().getContentAsString();</span><br><span class="line"></span><br><span class="line">		System.out.println(result);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Test</span><br><span class="line">	public void whenGetInfoFail() throws Exception &#123;</span><br><span class="line">		mockMvc.perform(get(&quot;/user/a&quot;)</span><br><span class="line">				.contentType(MediaType.APPLICATION_JSON_UTF8))</span><br><span class="line">				.andExpect(status().is4xxClientError());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Test</span><br><span class="line">	public void whenCreateSuccess() throws Exception &#123;</span><br><span class="line"></span><br><span class="line">		Date date = new Date();</span><br><span class="line">		System.out.println(date.getTime());</span><br><span class="line">		String content = &quot;&#123;\&quot;username\&quot;:\&quot;tom\&quot;,\&quot;password\&quot;:null,\&quot;birthday\&quot;:&quot;+date.getTime()+&quot;&#125;&quot;;</span><br><span class="line">		String reuslt = mockMvc.perform(post(&quot;/user&quot;).contentType(MediaType.APPLICATION_JSON_UTF8)</span><br><span class="line">				.content(content))</span><br><span class="line">				.andExpect(status().isOk())</span><br><span class="line">				.andExpect(jsonPath(&quot;$.id&quot;).value(&quot;1&quot;))</span><br><span class="line">				.andReturn().getResponse().getContentAsString();</span><br><span class="line"></span><br><span class="line">		System.out.println(reuslt);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Test</span><br><span class="line">	public void whenCreateFail() throws Exception &#123;</span><br><span class="line"></span><br><span class="line">		Date date = new Date();</span><br><span class="line">		System.out.println(date.getTime());</span><br><span class="line">		String content = &quot;&#123;\&quot;username\&quot;:\&quot;tom\&quot;,\&quot;password\&quot;:null,\&quot;birthday\&quot;:&quot;+date.getTime()+&quot;&#125;&quot;;</span><br><span class="line">		String reuslt = mockMvc.perform(post(&quot;/user&quot;).contentType(MediaType.APPLICATION_JSON_UTF8)</span><br><span class="line">				.content(content))</span><br><span class="line">//				.andExpect(status().isOk())</span><br><span class="line">//				.andExpect(jsonPath(&quot;$.id&quot;).value(&quot;1&quot;))</span><br><span class="line">				.andReturn().getResponse().getContentAsString();</span><br><span class="line"></span><br><span class="line">		System.out.println(reuslt);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Test</span><br><span class="line">	public void whenUpdateSuccess() throws Exception &#123;</span><br><span class="line"></span><br><span class="line">		Date date = new Date(LocalDateTime.now().plusYears(1).atZone(ZoneId.systemDefault()).toInstant().toEpochMilli());</span><br><span class="line">		System.out.println(date.getTime());</span><br><span class="line">		String content = &quot;&#123;\&quot;id\&quot;:\&quot;1\&quot;, \&quot;username\&quot;:\&quot;tom\&quot;,\&quot;password\&quot;:null,\&quot;birthday\&quot;:&quot;+date.getTime()+&quot;&#125;&quot;;</span><br><span class="line">		String reuslt = mockMvc.perform(put(&quot;/user/1&quot;).contentType(MediaType.APPLICATION_JSON_UTF8)</span><br><span class="line">				.content(content))</span><br><span class="line">				.andExpect(status().isOk())</span><br><span class="line">				.andExpect(jsonPath(&quot;$.id&quot;).value(&quot;1&quot;))</span><br><span class="line">				.andReturn().getResponse().getContentAsString();</span><br><span class="line"></span><br><span class="line">		System.out.println(reuslt);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Test</span><br><span class="line">	public void whenDeleteSuccess() throws Exception &#123;</span><br><span class="line">		mockMvc.perform(delete(&quot;/user/1&quot;)</span><br><span class="line">				.contentType(MediaType.APPLICATION_JSON_UTF8))</span><br><span class="line">				.andExpect(status().isOk());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class User &#123;</span><br><span class="line">	private String id;</span><br><span class="line">	private String username;</span><br><span class="line">	private String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="在url声明中使用正则表达式-amp-PageableDefault指定分页参数默认值"><a href="#在url声明中使用正则表达式-amp-PageableDefault指定分页参数默认值" class="headerlink" title="在url声明中使用正则表达式 &amp; @PageableDefault指定分页参数默认值"></a>在url声明中使用正则表达式 &amp; @PageableDefault指定分页参数默认值</h3><p>security-demo：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/user&quot;)</span><br><span class="line">public class UserController &#123;</span><br><span class="line">	@GetMapping</span><br><span class="line">	@JsonView(User.UserSimpleView.class)</span><br><span class="line">	public List&lt;User&gt; query(</span><br><span class="line">			@PageableDefault(page = 2, size = 17, sort = &quot;username,asc&quot;) Pageable pageable) &#123;</span><br><span class="line">		List&lt;User&gt; users = new ArrayList&lt;&gt;();</span><br><span class="line">		users.add(new User());</span><br><span class="line">		users.add(new User());</span><br><span class="line">		users.add(new User());</span><br><span class="line">		return users;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@GetMapping(&quot;/&#123;id:\\d+&#125;&quot;)</span><br><span class="line">	@JsonView(User.UserDetailView.class)</span><br><span class="line">	public User getInfo(@PathVariable String id) &#123;</span><br><span class="line">		User user = new User();</span><br><span class="line">		user.setUsername(&quot;tom&quot;);</span><br><span class="line">		return user;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="JsonView控制json输出内容"><a href="#JsonView控制json输出内容" class="headerlink" title="@JsonView控制json输出内容"></a>@JsonView控制json输出内容</h3><p>1.使用接口来声明多个视图<br>2.在值对象的get方法上指定视图<br>3.在Controller方法上指定视图<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@Setter</span><br><span class="line">public class User &#123;</span><br><span class="line">	public interface UserSimpleView &#123;&#125;;</span><br><span class="line">	public interface UserDetailView extends UserSimpleView &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	private String id;</span><br><span class="line">	private String username;</span><br><span class="line">	private String password;</span><br><span class="line"></span><br><span class="line">	@JsonView(UserSimpleView.class)</span><br><span class="line">	public String getUsername() &#123;</span><br><span class="line">		return username;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@JsonView(UserDetailView.class)</span><br><span class="line">	public String getPassword() &#123;</span><br><span class="line">		return password;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@JsonView(UserSimpleView.class)</span><br><span class="line">	public String getId() &#123;</span><br><span class="line">		return id;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;/&#123;id:\\d+&#125;&quot;)</span><br><span class="line">@JsonView(User.UserDetailView.class)</span><br><span class="line">public User getInfo(@PathVariable String id) &#123;</span><br><span class="line">  User user = new User();</span><br><span class="line">  user.setUsername(&quot;tom&quot;);</span><br><span class="line">  return user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Valid注解和BindingResult验证请求参数的合法性并处理校验结果"><a href="#Valid注解和BindingResult验证请求参数的合法性并处理校验结果" class="headerlink" title="@Valid注解和BindingResult验证请求参数的合法性并处理校验结果"></a>@Valid注解和BindingResult验证请求参数的合法性并处理校验结果</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/3.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/3.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping</span><br><span class="line">public User create(@Valid @RequestBody User user) &#123;</span><br><span class="line">  user.setId(&quot;1&quot;);</span><br><span class="line">  return user;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@PutMapping(&quot;/&#123;id:\\d+&#125;&quot;)</span><br><span class="line">public User update(@Valid @RequestBody User user, BindingResult errors) &#123;</span><br><span class="line">  user.setId(&quot;1&quot;);</span><br><span class="line">  return user;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@DeleteMapping(&quot;/&#123;id:\\d+&#125;&quot;)</span><br><span class="line">public void delete(@PathVariable String id) &#123;</span><br><span class="line">  System.out.println(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">@Setter</span><br><span class="line">public class User &#123;</span><br><span class="line">	public interface UserSimpleView &#123;&#125;;</span><br><span class="line">	public interface UserDetailView extends UserSimpleView &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	private String id;</span><br><span class="line">	private String username;</span><br><span class="line"></span><br><span class="line">	@NotBlank(message = &quot;密码不能为空&quot;)</span><br><span class="line">	private String password;</span><br><span class="line"></span><br><span class="line">	@JsonView(UserSimpleView.class)</span><br><span class="line">	public String getUsername() &#123;</span><br><span class="line">		return username;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@JsonView(UserDetailView.class)</span><br><span class="line">	public String getPassword() &#123;</span><br><span class="line">		return password;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@JsonView(UserSimpleView.class)</span><br><span class="line">	public String getId() &#123;</span><br><span class="line">		return id;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="自定义Validator"><a href="#自定义Validator" class="headerlink" title="自定义Validator"></a>自定义Validator</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Target(&#123;ElementType.METHOD, ElementType.FIELD&#125;)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Constraint(validatedBy = MyConstraintValidator.class)</span><br><span class="line">public @interface MyConstraint &#123;</span><br><span class="line">	String message();</span><br><span class="line">	Class&lt;?&gt;[] groups() default &#123; &#125;;</span><br><span class="line">	Class&lt;? extends Payload&gt;[] payload() default &#123; &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public class MyConstraintValidator implements ConstraintValidator&lt;MyConstraint, Object&gt; &#123;</span><br><span class="line">	@Override</span><br><span class="line">	public void initialize(MyConstraint constraintAnnotation) &#123;</span><br><span class="line">		System.out.println(&quot;my validator init&quot;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public boolean isValid(Object value, ConstraintValidatorContext context) &#123;</span><br><span class="line">    System.out.println(&quot;my validator valid&quot;);</span><br><span class="line">		System.out.println(value);</span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public class User &#123;</span><br><span class="line">  @MyConstraint(message = &quot;这是一个测试&quot;)</span><br><span class="line">  private String username;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="文件上传下载"><a href="#文件上传下载" class="headerlink" title="文件上传下载"></a>文件上传下载</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void whenUploadSuccess() throws Exception &#123;</span><br><span class="line">	String result = mockMvc.perform(fileUpload(&quot;/file&quot;)</span><br><span class="line">			.file(new MockMultipartFile(&quot;file&quot;, &quot;test.txt&quot;, &quot;multipart/form-data&quot;, &quot;hello upload&quot;.getBytes(&quot;UTF-8&quot;))))</span><br><span class="line">			.andExpect(status().isOk())</span><br><span class="line">			.andReturn().getResponse().getContentAsString();</span><br><span class="line">	System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/file&quot;)</span><br><span class="line">public class FileController &#123;</span><br><span class="line">	private String folder = &quot;/Users/path&quot;;</span><br><span class="line"></span><br><span class="line">	@PostMapping</span><br><span class="line">	public FileInfo upload(MultipartFile file) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">		System.out.println(file.getName());</span><br><span class="line">		System.out.println(file.getOriginalFilename());</span><br><span class="line">		System.out.println(file.getSize());</span><br><span class="line"></span><br><span class="line">		File localFile = new File(folder, new Date().getTime() + &quot;.txt&quot;);</span><br><span class="line">		file.transferTo(localFile);</span><br><span class="line"></span><br><span class="line">		return new FileInfo(localFile.getAbsolutePath());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br><span class="line">	public void download(@PathVariable String id, HttpServletRequest request, HttpServletResponse response) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">		try (InputStream inputStream = new FileInputStream(new File(folder, id + &quot;.txt&quot;));</span><br><span class="line">				OutputStream outputStream = response.getOutputStream();) &#123;</span><br><span class="line"></span><br><span class="line">			response.setContentType(&quot;application/x-download&quot;);</span><br><span class="line">			response.addHeader(&quot;Content-Disposition&quot;, &quot;attachment;filename=test.txt&quot;);</span><br><span class="line"></span><br><span class="line">			IOUtils.copy(inputStream, outputStream);</span><br><span class="line">			outputStream.flush();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">@AllArgsConstructor</span><br><span class="line">public class FileInfo &#123;</span><br><span class="line">	private String path;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="异步处理REST服务"><a href="#异步处理REST服务" class="headerlink" title="异步处理REST服务"></a>异步处理REST服务</h3><p>使用Runnable异步处理：<br><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/7.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/7.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class AsyncController &#123;</span><br><span class="line">	@RequestMapping(&quot;/order&quot;)</span><br><span class="line">	public void order() throws Exception &#123;</span><br><span class="line">		logger.info(&quot;主线程开始&quot;);</span><br><span class="line"></span><br><span class="line">		Callable&lt;String&gt; result = new Callable&lt;String&gt;() &#123;</span><br><span class="line">			@Override</span><br><span class="line">			public String call() throws Exception &#123;</span><br><span class="line">				logger.info(&quot;副线程开始&quot;);</span><br><span class="line">				Thread.sleep(1000);</span><br><span class="line">				logger.info(&quot;副线程返回&quot;);</span><br><span class="line">				return &quot;success&quot;;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用DeferredResult异步处理REST服务：<br><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/8.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/8.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class AsyncController &#123;</span><br><span class="line">	@Autowired</span><br><span class="line">	private MockQueue mockQueue;</span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">	private DeferredResultHolder deferredResultHolder;</span><br><span class="line"></span><br><span class="line">	private Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">	@RequestMapping(&quot;/order&quot;)</span><br><span class="line">	public DeferredResult&lt;String&gt; order() throws Exception &#123;</span><br><span class="line">		logger.info(&quot;主线程开始&quot;);</span><br><span class="line"></span><br><span class="line">		String orderNumber = RandomStringUtils.randomNumeric(8);</span><br><span class="line">		mockQueue.setPlaceOrder(orderNumber);</span><br><span class="line"></span><br><span class="line">		DeferredResult&lt;String&gt; result = new DeferredResult&lt;&gt;();</span><br><span class="line">		deferredResultHolder.getMap().put(orderNumber, result);</span><br><span class="line"></span><br><span class="line">		return result;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class DeferredResultHolder &#123;</span><br><span class="line">	private Map&lt;String, DeferredResult&lt;String&gt;&gt; map = new HashMap&lt;String, DeferredResult&lt;String&gt;&gt;();</span><br><span class="line"></span><br><span class="line">	public Map&lt;String, DeferredResult&lt;String&gt;&gt; getMap() &#123;</span><br><span class="line">		return map;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void setMap(Map&lt;String, DeferredResult&lt;String&gt;&gt; map) &#123;</span><br><span class="line">		this.map = map;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class MockQueue &#123;</span><br><span class="line">	private String placeOrder;</span><br><span class="line">	private String completeOrder;</span><br><span class="line">	private Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">	public String getPlaceOrder() &#123;</span><br><span class="line">		return placeOrder;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void setPlaceOrder(String placeOrder) throws Exception &#123;</span><br><span class="line">		new Thread(() -&gt; &#123;</span><br><span class="line">			logger.info(&quot;接到下单请求, &quot; + placeOrder);</span><br><span class="line">			try &#123;</span><br><span class="line">				Thread.sleep(1000);</span><br><span class="line">			&#125; catch (Exception e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">			this.completeOrder = placeOrder;</span><br><span class="line">			logger.info(&quot;下单请求处理完毕,&quot; + placeOrder);</span><br><span class="line">		&#125;).start();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public String getCompleteOrder() &#123;</span><br><span class="line">		return completeOrder;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void setCompleteOrder(String completeOrder) &#123;</span><br><span class="line">		this.completeOrder = completeOrder;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-Spring-MVC-高级特性"><a href="#2-Spring-MVC-高级特性" class="headerlink" title="2.Spring MVC 高级特性"></a>2.Spring MVC 高级特性</h2><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/4.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/4.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/5.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/5.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/6.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/6.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h2 id="3-REST服务开发常用工具"><a href="#3-REST服务开发常用工具" class="headerlink" title="3.REST服务开发常用工具"></a>3.REST服务开发常用工具</h2><h3 id="使用swagger自动生成html文档"><a href="#使用swagger自动生成html文档" class="headerlink" title="使用swagger自动生成html文档"></a>使用swagger自动生成html文档</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;io.springfox&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;springfox-swagger2&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;2.7.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;io.springfox&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;springfox-swagger-ui&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;2.7.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@EnableSwagger2</span><br><span class="line">@ApiModelProperty</span><br><span class="line">@ApiOperation</span><br><span class="line">@ApiParam</span><br></pre></td></tr></table></figure>
<h3 id="使用WireMock快速伪造RESTful服务"><a href="#使用WireMock快速伪造RESTful服务" class="headerlink" title="使用WireMock快速伪造RESTful服务"></a>使用WireMock快速伪造RESTful服务</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/9.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/9.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/10.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/10.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar wiremock-standalone-2.7.1.jar --port 8062</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;com.github.tomakehurst&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;wiremock&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public class MockServer &#123;</span><br><span class="line">	public static void main(String[] args) throws IOException &#123;</span><br><span class="line">		configureFor(8062);</span><br><span class="line">		removeAllMappings();</span><br><span class="line"></span><br><span class="line">		mock(&quot;/order/1&quot;, &quot;01&quot;);</span><br><span class="line">		mock(&quot;/order/2&quot;, &quot;02&quot;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	private static void mock(String url, String file) throws IOException &#123;</span><br><span class="line">		ClassPathResource resource = new ClassPathResource(&quot;mock/response/&quot; + file + &quot;.txt&quot;);</span><br><span class="line">		String content = StringUtils.join(FileUtils.readLines(resource.getFile(), &quot;UTF-8&quot;).toArray(), &quot;\n&quot;);</span><br><span class="line">		stubFor(get(urlPathEqualTo(url)).willReturn(aResponse().withBody(content).withStatus(200)));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

                    
                        

                    
                    
                        <p>
                            <a href="/2020/04/07/Spring Security技术栈开发企业级认证与授权-使用Spring MVC开发 RESTful API/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2020/04/07/Spring Security技术栈开发企业级认证与授权-认证流程源码级详解/">
                            SpringSecurity技术栈开发企业级认证与授权-认证流程源码级详解
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2020-04-07T21:37:40+08:00">
	
		    4月 07, 2020
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="1-认证处理流程说明"><a href="#1-认证处理流程说明" class="headerlink" title="1.认证处理流程说明"></a>1.认证处理流程说明</h2><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/21.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/21.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/22.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/22.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken(username, password);</span><br></pre></td></tr></table></figure>
<p>获取请求中携带的用户名和密码，然后拿用户名和密码构建了一个UsernamePasswordAuthenticationToken这样一个对象。</p>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/23.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/23.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/24.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/24.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<p>该对象是Authentication接口的实现，该接口实际上封装了我们的认证信息。<br>通过该类构造函数发现，会先调用父类的构造函数设置空的权限，设置用户名和密码到本地变量上。<br>设置当前传进去的身份信息还没经过认证。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this.setDetails(request, authRequest);</span><br></pre></td></tr></table></figure>
<p>会把请求的一些信息设到authRequest中，包括当前发请求的机器的ip，session等。</p>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/25.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/25.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;? extends Authentication&gt; toTest = authentication.getClass();</span><br><span class="line">AuthenticationException lastException = null;</span><br><span class="line">Authentication result = null;</span><br><span class="line">boolean debug = logger.isDebugEnabled();</span><br><span class="line">Iterator var6 = this.getProviders().iterator();</span><br><span class="line"></span><br><span class="line">while(var6.hasNext()) &#123;</span><br><span class="line">    AuthenticationProvider provider = (AuthenticationProvider)var6.next();</span><br><span class="line">    if (provider.supports(toTest)) &#123;</span><br><span class="line">        if (debug) &#123;</span><br><span class="line">            logger.debug(&quot;Authentication attempt using &quot; + provider.getClass().getName());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            result = provider.authenticate(authentication);</span><br><span class="line">            if (result != null) &#123;</span><br><span class="line">                this.copyDetails(authentication, result);</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (AccountStatusException var11) &#123;</span><br><span class="line">            this.prepareException(var11, authentication);</span><br><span class="line">            throw var11;</span><br><span class="line">        &#125; catch (InternalAuthenticationServiceException var12) &#123;</span><br><span class="line">            this.prepareException(var12, authentication);</span><br><span class="line">            throw var12;</span><br><span class="line">        &#125; catch (AuthenticationException var13) &#123;</span><br><span class="line">            lastException = var13;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AuthenticationManager用来管理下面的AuthenticationProvider。<br>真正的检验逻辑是写在AuthenticationProvider中，不同的登录方式的认证逻辑是不一样的。<br>用户名密码登录，校验的是用户名密码。如果是第三方登录，这时候是不用验密码的。<br>spring提供了两个provider，AuthenticationManager负责把所有的provider收集起来，然后收到请求的时候去循环它们，挨个去问你当前这个provider支不支持我这种登录方式。<br>即调用supports方法，判断支不支持我传进来的这个Authentication类型。<br>比如当前拿到的是UsernamePasswordAuthenticationToken，比如第三方的登录传的就是SocialAuthenticationToken。<br>根据传进来的Authentication类型会挑出其中一个provider来进行校验处理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = provider.authenticate(authentication);</span><br></pre></td></tr></table></figure>
<p>如果支持的话，往下走，真正去执行校验逻辑。</p>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/26.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/26.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/27.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/27.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<p>Authentication的主要校验逻辑是写在抽象类里面的，首先调用retrieveUser，获取到UserDetails对象。<br><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/28.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/28.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div><br>DaoAuthenticationProvider中实现了retrieveUser接口，在实现方法里，调用了我们提供的UserDetailsService实现。<br>通过loadUserByUsername查到我们的用户信息，并包装成UserDetails。如果拿不到，则抛出异常。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this.preAuthenticationChecks.check(user);</span><br></pre></td></tr></table></figure></p>
<p>如果拿到了用户信息，会做预检查。<br><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/29.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/29.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div><br>UserDetalis这个接口有4个方法来判断用户是否可用。锁定，过期等校验。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this.additionalAuthenticationChecks(user, (UsernamePasswordAuthenticationToken)authentication);</span><br></pre></td></tr></table></figure></p>
<p>做完预检查后，会做附加检查。在DaoAuthenticationProvider中有具体实现。<br><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/30.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/30.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div><br>用passwordEncoder校验当前的密码是否匹配。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this.postAuthenticationChecks.check(user);</span><br></pre></td></tr></table></figure></p>
<p>做完前面两步检查之后，还有一个后检查。也是UserDetails中的校验。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return this.createSuccessAuthentication(principalToReturn, authentication, user);</span><br></pre></td></tr></table></figure>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/31.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/31.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<p>所有的这些检查都通过之后，那么认为用户认证是成功的，拿获取到的用户信息、Authentication传进来的认证请求信息来创建SuccessAuthentication。</p>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/32.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/32.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<p>设置权限和认证通过。</p>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/33.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/33.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this.successfulAuthentication(request, response, chain, authResult);</span><br></pre></td></tr></table></figure>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/34.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/34.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<p>会调我们自己写的成功处理器。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">    authResult = this.attemptAuthentication(request, response);</span><br><span class="line">    if (authResult == null) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    this.sessionStrategy.onAuthentication(authResult, request, response);</span><br><span class="line">&#125; catch (InternalAuthenticationServiceException var8) &#123;</span><br><span class="line">    this.logger.error(&quot;An internal error occurred while trying to authenticate the user.&quot;, var8);</span><br><span class="line">    this.unsuccessfulAuthentication(request, response, var8);</span><br><span class="line">    return;</span><br><span class="line">&#125; catch (AuthenticationException var9) &#123;</span><br><span class="line">    this.unsuccessfulAuthentication(request, response, var9);</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果在认证过程中任何一处出了异常，会调用unsuccessfulAuthentication方法，其中会调用我们自己写的失败处理器。</p>
<h2 id="2-认证结果如何在多个请求之间共享"><a href="#2-认证结果如何在多个请求之间共享" class="headerlink" title="2.认证结果如何在多个请求之间共享"></a>2.认证结果如何在多个请求之间共享</h2><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/36.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/36.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/35.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/35.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<p>在调成功处理器之前，将我们认证成功的Authentication放到SecurityContext，然后放到SecurityContextHolder里面，<br>SecurityContextHolder实际上是ThreadLocal的封装。</p>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/37.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/37.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<p>当请求进来的时候，检查sessionl里是否有SecurityContext。如果有，把SecurityContext从session中拿出来放到线程里，如果没有，则为空，放过。<br>当整个请求响应回来以后，过它的时候，它检查线程，如果线程里面有SecurityContext,就拿出来放到session里，这样不用的请求就可以在session中<br>拿到相同的认证信息。</p>
<h2 id="3-获取认证用户信息"><a href="#3-获取认证用户信息" class="headerlink" title="3.获取认证用户信息"></a>3.获取认证用户信息</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/user&quot;)</span><br><span class="line">public class UserController &#123;</span><br><span class="line">  @GetMapping(&quot;/me&quot;)</span><br><span class="line">  public Object getCurrentUser(@AuthenticationPrincipal UserDetails user) &#123;</span><br><span class="line">    return user;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @GetMapping(&quot;/me2&quot;)</span><br><span class="line">  public Object getCurrentUser2(Authentication authentication) &#123;</span><br><span class="line">    return authentication;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

                    
                        

                    
                    
                        <p>
                            <a href="/2020/04/07/Spring Security技术栈开发企业级认证与授权-认证流程源码级详解/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2020/02/01/Spring Security技术栈开发企业级认证与授权-开始开发/">
                            Spring Security技术栈开发企业级认证与授权-开始开发
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2020-02-01T10:16:02+08:00">
	
		    2月 01, 2020
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="1-架构介绍"><a href="#1-架构介绍" class="headerlink" title="1.架构介绍"></a>1.架构介绍</h2><p>security：主模块<br>security-core: 核心业务逻辑（子模块）<br>security-browser: 浏览器安全特定代码（子模块）<br>security-app: app相关特定代码（子模块）<br>security-demo: 样例程序（子模块）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">            security</span><br><span class="line"></span><br><span class="line">          security-core</span><br><span class="line">                ↑</span><br><span class="line">          --------------</span><br><span class="line">          |            |</span><br><span class="line">security-browser  security-app</span><br><span class="line">          ↑            ↑</span><br><span class="line">          --------------</span><br><span class="line">                |</span><br><span class="line">          security-demo</span><br></pre></td></tr></table></figure></p>
<p>security pom.xml：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&lt;properties&gt;</span><br><span class="line">  &lt;security.version&gt;1.0.0-SNAPSHOT&lt;/security.version&gt;</span><br><span class="line">&lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependencyManagement&gt;</span><br><span class="line">  &lt;!--管理版本、依赖--&gt;</span><br><span class="line">  &lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;io.spring.platform&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;platform-bom&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;Brussels-SR4&lt;/version&gt;</span><br><span class="line">      &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">      &lt;scope&gt;import&lt;/scope&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;Dalston.SR2&lt;/version&gt;</span><br><span class="line">      &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">      &lt;scope&gt;import&lt;/scope&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">  &lt;/dependencies&gt;</span><br><span class="line">&lt;/dependencyManagement&gt;</span><br><span class="line"></span><br><span class="line">&lt;build&gt;</span><br><span class="line">  &lt;plugins&gt;</span><br><span class="line">    &lt;plugin&gt;</span><br><span class="line">      &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;2.3.2&lt;/version&gt;</span><br><span class="line">      &lt;configuration&gt;</span><br><span class="line">        &lt;source&gt;1.8&lt;/source&gt;</span><br><span class="line">        &lt;target&gt;1.8&lt;/target&gt;</span><br><span class="line">        &lt;encoding&gt;UTF-8&lt;/encoding&gt;</span><br><span class="line">      &lt;/configuration&gt;</span><br><span class="line">    &lt;/plugin&gt;</span><br><span class="line">  &lt;/plugins&gt;</span><br><span class="line">&lt;/build&gt;</span><br><span class="line"></span><br><span class="line">&lt;modules&gt;</span><br><span class="line">  &lt;module&gt;../security-app&lt;/module&gt;</span><br><span class="line">  &lt;module&gt;../security-browser&lt;/module&gt;</span><br><span class="line">  &lt;module&gt;../security-core&lt;/module&gt;</span><br><span class="line">  &lt;module&gt;../security-demo&lt;/module&gt;</span><br><span class="line">&lt;/modules&gt;</span><br></pre></td></tr></table></figure></p>
<p>security-core pom.xml：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-oauth2&lt;/artifactId&gt;</span><br><span class="line">  &lt;/dependency&gt;</span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span><br><span class="line">  &lt;/dependency&gt;</span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-jdbc&lt;/artifactId&gt;</span><br><span class="line">  &lt;/dependency&gt;</span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">  &lt;/dependency&gt;</span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.social&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-social-config&lt;/artifactId&gt;</span><br><span class="line">  &lt;/dependency&gt;</span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.social&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-social-core&lt;/artifactId&gt;</span><br><span class="line">  &lt;/dependency&gt;</span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.social&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-social-security&lt;/artifactId&gt;</span><br><span class="line">  &lt;/dependency&gt;</span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.social&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-social-web&lt;/artifactId&gt;</span><br><span class="line">  &lt;/dependency&gt;</span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;commons-lang&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;commons-lang&lt;/artifactId&gt;</span><br><span class="line">  &lt;/dependency&gt;</span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;commons-collections&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;commons-collections&lt;/artifactId&gt;</span><br><span class="line">  &lt;/dependency&gt;</span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;commons-beanutils&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;commons-beanutils&lt;/artifactId&gt;</span><br><span class="line">  &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure></p>
<p>security-app pom.xml：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.security&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;security-core&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;security.version&#125;&lt;/version&gt;</span><br><span class="line">  &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure></p>
<p>security-browser pom.xml：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.security&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;security-core&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;security.version&#125;&lt;/version&gt;</span><br><span class="line">  &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.session&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-session&lt;/artifactId&gt;</span><br><span class="line">  &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure></p>
<p>security-demo pom.xml：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.security&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;security-browser&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;security.version&#125;&lt;/version&gt;</span><br><span class="line">  &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">  &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="2-Hello-Spring-Security"><a href="#2-Hello-Spring-Security" class="headerlink" title="2.Hello Spring Security"></a>2.Hello Spring Security</h2><p>security-demo application.properties：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">spring.datasource.driver-class-name = com.mysql.jdbc.Driver</span><br><span class="line">spring.datasource.url= jdbc:mysql://127.0.0.1:3306/demo?useUnicode=yes&amp;characterEncoding=UTF-8&amp;useSSL=false</span><br><span class="line">spring.datasource.username = root</span><br><span class="line">spring.datasource.password = 123456</span><br><span class="line"></span><br><span class="line">spring.session.store-type = none</span><br><span class="line"></span><br><span class="line">#security.basic.enabled = false</span><br><span class="line"></span><br><span class="line">server.port = 8060</span><br></pre></td></tr></table></figure></p>

                    
                        

                    
                    
                        <p>
                            <a href="/2020/02/01/Spring Security技术栈开发企业级认证与授权-开始开发/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
        
        <li class="pagination-number">第 1 页 共 1 页</li>
    </ul>
</div>

</section>


                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2020 Brotherc. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/head.jpg" alt="作者的图片">
        
            <h4 id="about-card-name">Brotherc</h4>
        
            <div id="about-card-bio"><p>java development</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br>
                <p>java</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br>
                zhuhai
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-dbd16rvloemmuxdzniplmnxxvwoz24eya9wol0b7vvmlokgqsjivmb8dnscy.min.js"></script>
<!--SCRIPTS END-->



    </body>
</html>
