
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Brotherc">
    <title>并发编程 - Brotherc</title>
    <meta name="author" content="Brotherc">
    
    
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Brotherc","sameAs":["https://github.com/Brotherc"],"image":"head.jpg"},"articleBody":"准备\n\n\n\n基本概念\n\n\nCPU多级缓存\n\n\n\n\nJAVA内存模型\n\n\n\n\n\n\n\n\n\n\n\n并发的优势与风险\n线程安全性\n\n原子性\n123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051import lombok.extern.slf4j.Slf4j;import java.util.concurrent.CountDownLatch;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;import java.util.concurrent.Semaphore;import java.util.concurrent.atomic.AtomicInteger;import java.util.concurrent.atomic.AtomicLong;import java.util.concurrent.atomic.LongAdder;@Slf4j@ThreadSafepublic class AtomicExample1 &#123;    // 请求总数    public static int clientTotal = 5000;    // 同时并发执行的线程数    public static int threadTotal = 200;    public static AtomicInteger count = new AtomicInteger(0);    // public static AtomicLong count = new AtomicLong(0);    // public static LongAdder count = new LongAdder();    public static void main(String[] args) throws Exception &#123;        ExecutorService executorService = Executors.newCachedThreadPool();        final Semaphore semaphore = new Semaphore(threadTotal);        final CountDownLatch countDownLatch = new CountDownLatch(clientTotal);        for (int i = 0; i &lt; clientTotal ; i++) &#123;            executorService.execute(() -&gt; &#123;                try &#123;                    semaphore.acquire();                    add();                    semaphore.release();                &#125; catch (Exception e) &#123;                    log.error(&quot;exception&quot;, e);                &#125;                countDownLatch.countDown();            &#125;);        &#125;        countDownLatch.await();        executorService.shutdown();        log.info(&quot;count:&#123;&#125;&quot;, count.get());    &#125;    private static void add() &#123;        count.incrementAndGet();        // count.getAndIncrement();        // count.increment();    &#125;&#125;\n123456789101112131415161718192021222324import lombok.extern.slf4j.Slf4j;import java.util.concurrent.CountDownLatch;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;import java.util.concurrent.Semaphore;import java.util.concurrent.atomic.AtomicReference;import java.util.concurrent.atomic.LongAdder;@Slf4j@ThreadSafepublic class AtomicExample4 &#123;    private static AtomicReference&lt;Integer&gt; count = new AtomicReference&lt;&gt;(0);    public static void main(String[] args) &#123;        count.compareAndSet(0, 2); // 2        count.compareAndSet(0, 1); // no        count.compareAndSet(1, 3); // no        count.compareAndSet(2, 4); // 4        count.compareAndSet(3, 5); // no        log.info(&quot;count:&#123;&#125;&quot;, count.get());    &#125;&#125;\n1234567891011121314151617181920212223242526272829import java.util.concurrent.atomic.AtomicIntegerFieldUpdater;import lombok.Getter;import lombok.extern.slf4j.Slf4j;@Slf4jpublic class AtomicExample5 &#123;    private static AtomicIntegerFieldUpdater&lt;AtomicExample5&gt; updater =            AtomicIntegerFieldUpdater.newUpdater(AtomicExample5.class, &quot;count&quot;);    @Getter    public volatile int count = 100;    public static void main(String[] args) &#123;        AtomicExample5 example5 = new AtomicExample5();        if (updater.compareAndSet(example5, 100, 120)) &#123;            log.info(&quot;update success 1, &#123;&#125;&quot;, example5.getCount());        &#125;        if (updater.compareAndSet(example5, 100, 120)) &#123;            log.info(&quot;update success 2, &#123;&#125;&quot;, example5.getCount());        &#125; else &#123;            log.info(&quot;update failed, &#123;&#125;&quot;, example5.getCount());        &#125;    &#125;&#125;\n结果:1223:15:33.084 [main] INFO com.mmall.concurrency.example.atomic.AtomicExample5 - update success 1, 12023:15:33.089 [main] INFO com.mmall.concurrency.example.atomic.AtomicExample5 - update failed, 120\n1234567891011121314151617181920212223242526272829303132333435363738394041424344454647import lombok.extern.slf4j.Slf4j;import java.util.concurrent.CountDownLatch;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;import java.util.concurrent.Semaphore;import java.util.concurrent.atomic.AtomicBoolean;@Slf4j@ThreadSafepublic class AtomicExample6 &#123;    private static AtomicBoolean isHappened = new AtomicBoolean(false);    // 请求总数    public static int clientTotal = 5000;    // 同时并发执行的线程数    public static int threadTotal = 200;    public static void main(String[] args) throws Exception &#123;        ExecutorService executorService = Executors.newCachedThreadPool();        final Semaphore semaphore = new Semaphore(threadTotal);        final CountDownLatch countDownLatch = new CountDownLatch(clientTotal);        for (int i = 0; i &lt; clientTotal ; i++) &#123;            executorService.execute(() -&gt; &#123;                try &#123;                    semaphore.acquire();                    test();                    semaphore.release();                &#125; catch (Exception e) &#123;                    log.error(&quot;exception&quot;, e);                &#125;                countDownLatch.countDown();            &#125;);        &#125;        countDownLatch.await();        executorService.shutdown();        log.info(&quot;isHappened:&#123;&#125;&quot;, isHappened.get());    &#125;    private static void test() &#123;        if (isHappened.compareAndSet(false, true)) &#123;            log.info(&quot;execute&quot;);        &#125;    &#125;&#125;\n结果:1223:19:09.823 [pool-1-thread-1] INFO com.mmall.concurrency.example.atomic.AtomicExample6 - execute23:19:09.840 [main] INFO com.mmall.concurrency.example.atomic.AtomicExample6 - isHappened:true\n\n\n\n可见性\n\n\n\n\n\n有序性\n\n\n\n\n安全发布对象\n123456789101112131415161718192021222324import lombok.extern.slf4j.Slf4j;@Slf4j@NotThreadSafe@NotRecommendpublic class Escape &#123;    private int thisCanBeEscape = 0;    public Escape () &#123;        new InnerClass();    &#125;    private class InnerClass &#123;        public InnerClass() &#123;            log.info(&quot;&#123;&#125;&quot;, Escape.this.thisCanBeEscape);        &#125;    &#125;    public static void main(String[] args) &#123;        new Escape();    &#125;&#125;\n123456789101112131415161718192021import lombok.extern.slf4j.Slf4j;import java.util.Arrays;@Slf4j@NotThreadSafepublic class UnsafePublish &#123;    private String[] states = &#123;&quot;a&quot;, &quot;b&quot;, &quot;c&quot;&#125;;    public String[] getStates() &#123;        return states;    &#125;    public static void main(String[] args) &#123;        UnsafePublish unsafePublish = new UnsafePublish();        log.info(&quot;&#123;&#125;&quot;, Arrays.toString(unsafePublish.getStates()));        unsafePublish.getStates()[0] = &quot;d&quot;;        log.info(&quot;&#123;&#125;&quot;, Arrays.toString(unsafePublish.getStates()));    &#125;&#125;\n\n1234567891011121314151617181920/** * 懒汉模式 * 单例实例在第一次使用时进行创建 */@NotThreadSafepublic class SingletonExample1 &#123;    // 私有构造函数    private SingletonExample1() &#123;&#125;    // 单例对象    private static SingletonExample1 instance = null;    // 静态的工厂方法    public static SingletonExample1 getInstance() &#123;        if (instance == null) &#123;            instance = new SingletonExample1();        &#125;        return instance;    &#125;&#125;\n1234567891011121314151617/** * 饿汉模式 * 单例实例在类装载时进行创建 */@ThreadSafepublic class SingletonExample2 &#123;    // 私有构造函数    private SingletonExample2() &#123;&#125;    // 单例对象    private static SingletonExample2 instance = new SingletonExample2();    // 静态的工厂方法    public static SingletonExample2 getInstance() &#123;        return instance;    &#125;&#125;\n123456789101112131415161718192021/** * 懒汉模式 * 单例实例在第一次使用时进行创建 */@ThreadSafe@NotRecommendpublic class SingletonExample3 &#123;    // 私有构造函数    private SingletonExample3() &#123;&#125;    // 单例对象    private static SingletonExample3 instance = null;    // 静态的工厂方法    public static synchronized SingletonExample3 getInstance() &#123;        if (instance == null) &#123;            instance = new SingletonExample3();        &#125;        return instance;    &#125;&#125;\n12345678910111213141516171819202122232425262728293031323334/** * 懒汉模式 -》 双重同步锁单例模式 * 单例实例在第一次使用时进行创建 */@NotThreadSafepublic class SingletonExample4 &#123;    // 私有构造函数    private SingletonExample4() &#123;&#125;    // 1、memory = allocate() 分配对象的内存空间    // 2、ctorInstance() 初始化对象    // 3、instance = memory 设置instance指向刚分配的内存    // JVM和cpu优化，发生了指令重排    // 1、memory = allocate() 分配对象的内存空间    // 3、instance = memory 设置instance指向刚分配的内存    // 2、ctorInstance() 初始化对象    // 单例对象    private static SingletonExample4 instance = null;    // 静态的工厂方法    public static SingletonExample4 getInstance() &#123;        if (instance == null) &#123; // 双重检测机制        // B            synchronized (SingletonExample4.class) &#123; // 同步锁                if (instance == null) &#123;                    instance = new SingletonExample4(); // A - 3                &#125;            &#125;        &#125;        return instance;    &#125;&#125;\n12345678910111213141516171819202122232425262728/** * 懒汉模式 -》 双重同步锁单例模式 * 单例实例在第一次使用时进行创建 */@ThreadSafepublic class SingletonExample5 &#123;    // 私有构造函数    private SingletonExample5() &#123;&#125;    // 1、memory = allocate() 分配对象的内存空间    // 2、ctorInstance() 初始化对象    // 3、instance = memory 设置instance指向刚分配的内存    // 单例对象 volatile + 双重检测机制 -&gt; 禁止指令重排    private volatile static SingletonExample5 instance = null;    // 静态的工厂方法    public static SingletonExample5 getInstance() &#123;        if (instance == null) &#123; // 双重检测机制        // B            synchronized (SingletonExample5.class) &#123; // 同步锁                if (instance == null) &#123;                    instance = new SingletonExample5(); // A - 3                &#125;            &#125;        &#125;        return instance;    &#125;&#125;\n1234567891011121314151617181920212223242526/** * 饿汉模式 * 单例实例在类装载时进行创建 */@ThreadSafepublic class SingletonExample6 &#123;    // 私有构造函数    private SingletonExample6() &#123;&#125;    // 单例对象    private static SingletonExample6 instance = null;    static &#123;        instance = new SingletonExample6();    &#125;    // 静态的工厂方法    public static SingletonExample6 getInstance() &#123;        return instance;    &#125;    public static void main(String[] args) &#123;        System.out.println(getInstance().hashCode());        System.out.println(getInstance().hashCode());    &#125;&#125;\n1234567891011121314151617181920212223242526272829/** * 枚举模式：最安全 */@ThreadSafe@Recommendpublic class SingletonExample7 &#123;    // 私有构造函数    private SingletonExample7() &#123;&#125;    public static SingletonExample7 getInstance() &#123;        return Singleton.INSTANCE.getInstance();    &#125;    private enum Singleton &#123;        INSTANCE;        private SingletonExample7 singleton;        // JVM保证这个方法绝对只调用一次        Singleton() &#123;            singleton = new SingletonExample7();        &#125;        public SingletonExample7 getInstance() &#123;            return singleton;        &#125;    &#125;&#125;\n不可变对象\n\n12345678910111213141516171819202122232425262728293031import com.google.common.collect.Maps;import lombok.extern.slf4j.Slf4j;import java.util.Map;@Slf4j@NotThreadSafepublic class ImmutableExample1 &#123;    private final static Integer a = 1;    private final static String b = &quot;2&quot;;    private final static Map&lt;Integer, Integer&gt; map = Maps.newHashMap();    static &#123;        map.put(1, 2);        map.put(3, 4);        map.put(5, 6);    &#125;    public static void main(String[] args) &#123;//        a = 2;//        b = &quot;3&quot;;//        map = Maps.newHashMap();        map.put(1, 3);        log.info(&quot;&#123;&#125;&quot;, map.get(1));    &#125;    private void test(final int a) &#123;//        a = 1;    &#125;&#125;\n\n12345678910111213141516171819202122232425import com.google.common.collect.Maps;import lombok.extern.slf4j.Slf4j;import java.util.Collections;import java.util.Map;@Slf4j@ThreadSafepublic class ImmutableExample2 &#123;    private static Map&lt;Integer, Integer&gt; map = Maps.newHashMap();    static &#123;        map.put(1, 2);        map.put(3, 4);        map.put(5, 6);        map = Collections.unmodifiableMap(map);    &#125;    public static void main(String[] args) &#123;        map.put(1, 3);        log.info(&quot;&#123;&#125;&quot;, map.get(1));    &#125;&#125;\n结果:12Exception in thread &quot;main&quot; java.lang.UnsupportedOperationException\tat java.util.Collections$UnmodifiableMap.put(Collections.java:1457)\n123456789101112131415161718import com.google.common.collect.ImmutableList;import com.google.common.collect.ImmutableMap;import com.google.common.collect.ImmutableSet;@ThreadSafepublic class ImmutableExample3 &#123;    private final static ImmutableList&lt;Integer&gt; list = ImmutableList.of(1, 2, 3);    private final static ImmutableSet set = ImmutableSet.copyOf(list);    private final static ImmutableMap&lt;Integer, Integer&gt; map = ImmutableMap.of(1, 2, 3, 4);    private final static ImmutableMap&lt;Integer, Integer&gt; map2 = ImmutableMap.&lt;Integer, Integer&gt;builder()            .put(1, 2).put(3, 4).put(5, 6).build();    public static void main(String[] args) &#123;        System.out.println(map2.get(3));    &#125;&#125;\n线程封闭\n线程不安全类与写法\nJodaTime:12345678910111213141516171819202122232425262728293031323334353637383940414243444546import com.mmall.concurrency.annoations.ThreadSafe;import lombok.extern.slf4j.Slf4j;import org.joda.time.DateTime;import org.joda.time.format.DateTimeFormat;import org.joda.time.format.DateTimeFormatter;import java.util.concurrent.CountDownLatch;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;import java.util.concurrent.Semaphore;@Slf4j@ThreadSafepublic class DateFormatExample3 &#123;    // 请求总数    public static int clientTotal = 5000;    // 同时并发执行的线程数    public static int threadTotal = 200;    private static DateTimeFormatter dateTimeFormatter = DateTimeFormat.forPattern(&quot;yyyyMMdd&quot;);    public static void main(String[] args) throws Exception &#123;        ExecutorService executorService = Executors.newCachedThreadPool();        final Semaphore semaphore = new Semaphore(threadTotal);        final CountDownLatch countDownLatch = new CountDownLatch(clientTotal);        for (int i = 0; i &lt; clientTotal; i++) &#123;            final int count = i;            executorService.execute(() -&gt; &#123;                try &#123;                    semaphore.acquire();                    update(count);                    semaphore.release();                &#125; catch (Exception e) &#123;                    log.error(&quot;exception&quot;, e);                &#125;                countDownLatch.countDown();            &#125;);        &#125;        countDownLatch.await();        executorService.shutdown();    &#125;    private static void update(int i) &#123;        log.info(&quot;&#123;&#125;, &#123;&#125;&quot;, i, DateTime.parse(&quot;20180208&quot;, dateTimeFormatter).toDate());    &#125;&#125;\n同步容器\nVector不是线程安全的情况:1234567891011121314151617181920212223242526272829303132333435import java.util.Vector;@NotThreadSafepublic class VectorExample2 &#123;    private static Vector&lt;Integer&gt; vector = new Vector&lt;&gt;();    public static void main(String[] args) &#123;        while (true) &#123;            for (int i = 0; i &lt; 10; i++) &#123;                vector.add(i);            &#125;            Thread thread1 = new Thread() &#123;                public void run() &#123;                    for (int i = 0; i &lt; vector.size(); i++) &#123;                        vector.remove(i);                    &#125;                &#125;            &#125;;            Thread thread2 = new Thread() &#123;                public void run() &#123;                    for (int i = 0; i &lt; vector.size(); i++) &#123;                        vector.get(i);                    &#125;                &#125;            &#125;;            thread1.start();            thread2.start();        &#125;    &#125;&#125;\nConcurrentModificationException:123456789101112131415161718192021222324252627282930313233343536373839404142import java.util.Iterator;import java.util.Vector;public class VectorExample3 &#123;    // java.util.ConcurrentModificationException    private static void test1(Vector&lt;Integer&gt; v1) &#123; // foreach        for(Integer i : v1) &#123;            if (i.equals(3)) &#123;                v1.remove(i);            &#125;        &#125;    &#125;    // java.util.ConcurrentModificationException    private static void test2(Vector&lt;Integer&gt; v1) &#123; // iterator        Iterator&lt;Integer&gt; iterator = v1.iterator();        while (iterator.hasNext()) &#123;            Integer i = iterator.next();            if (i.equals(3)) &#123;                v1.remove(i);            &#125;        &#125;    &#125;    // success    private static void test3(Vector&lt;Integer&gt; v1) &#123; // for        for (int i = 0; i &lt; v1.size(); i++) &#123;            if (v1.get(i).equals(3)) &#123;                v1.remove(i);            &#125;        &#125;    &#125;    public static void main(String[] args) &#123;        Vector&lt;Integer&gt; vector = new Vector&lt;&gt;();        vector.add(1);        vector.add(2);        vector.add(3);        test1(vector);    &#125;&#125;\nCollections.synchronizedXXX1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556import com.google.common.collect.Lists;import com.google.common.collect.Sets;import com.mmall.concurrency.annoations.ThreadSafe;import lombok.extern.slf4j.Slf4j;import java.util.Collections;import java.util.List;import java.util.Vector;import java.util.Set;import java.util.concurrent.CountDownLatch;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;import java.util.concurrent.Semaphore;@Slf4j@ThreadSafepublic class CollectionsExample1 &#123;    // 请求总数    public static int clientTotal = 5000;    // 同时并发执行的线程数    public static int threadTotal = 200;    private static List&lt;Integer&gt; list = Collections.synchronizedList(Lists.newArrayList());    // private static Set&lt;Integer&gt; set = Collections.synchronizedSet(Sets.newHashSet());    // private static Map&lt;Integer, Integer&gt; map = Collections.synchronizedMap(new HashMap&lt;&gt;());    public static void main(String[] args) throws Exception &#123;        ExecutorService executorService = Executors.newCachedThreadPool();        final Semaphore semaphore = new Semaphore(threadTotal);        final CountDownLatch countDownLatch = new CountDownLatch(clientTotal);        for (int i = 0; i &lt; clientTotal; i++) &#123;            final int count = i;            executorService.execute(() -&gt; &#123;                try &#123;                    semaphore.acquire();                    update(count);                    semaphore.release();                &#125; catch (Exception e) &#123;                    log.error(&quot;exception&quot;, e);                &#125;                countDownLatch.countDown();            &#125;);        &#125;        countDownLatch.await();        executorService.shutdown();        log.info(&quot;size:&#123;&#125;&quot;, list.size());    &#125;    private static void update(int i) &#123;        list.add(i);        // set.add(i);        // map.put(i, i);    &#125;&#125;\n\n安全共享策略\n\nAQS\n\n\nSync queue 同步队列（底层是双向链表）Condition queue 单向链表（不是必须的，需要用到的时候才会使用）\naqs实现的具体大致思路:123aqs内部维护了一个clh队列来管理锁，线程会首先尝试获取锁，如果失败，就将当前线程以及等待信息包成一个node节点，加入到之前介绍的同步队列，接着会不断循环尝试获取锁，条件是，当前节点为head的直接后继才会尝试，如果失败，就会阻塞自己，直到自己被唤醒，而当持有锁的线程释放锁的时候，会唤醒队列中的后继线程，基于这些基础的设计和思路，jdk提供了很多基于aqs的子类\n\n\n\n使用场景:123程序执行需要等待某个条件完成后才能继续执行后续的操作，典型的应用比如：并行计算当某个处理的运算量很大时，可以将该运算任务拆分成多个子任务，等待所有的子任务都完成后，父任务再拿到所有子任务的运算结果进行汇总\n12345678910111213141516171819202122232425262728293031323334353637383940import lombok.extern.slf4j.Slf4j;import java.util.concurrent.CountDownLatch;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;@Slf4jpublic class CountDownLatchExample1 &#123;    private final static int threadCount = 200;    public static void main(String[] args) throws Exception &#123;        ExecutorService exec = Executors.newCachedThreadPool();        final CountDownLatch countDownLatch = new CountDownLatch(threadCount);        for (int i = 0; i &lt; threadCount; i++) &#123;            final int threadNum = i;            exec.execute(() -&gt; &#123;                try &#123;                    test(threadNum);                &#125; catch (Exception e) &#123;                    log.error(&quot;exception&quot;, e);                &#125; finally &#123;                    countDownLatch.countDown();                &#125;            &#125;);        &#125;        countDownLatch.await();        log.info(&quot;finish&quot;);        exec.shutdown();    &#125;    private static void test(int threadNum) throws Exception &#123;        Thread.sleep(100);        log.info(&quot;&#123;&#125;&quot;, threadNum);        Thread.sleep(100);    &#125;&#125;\n结果:123456789101115:14:51.589 [pool-1-thread-10] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample1 - 915:14:51.589 [pool-1-thread-6] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample1 - 515:14:51.589 [pool-1-thread-3] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample1 - 215:14:51.589 [pool-1-thread-7] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample1 - 615:14:51.589 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample1 - 015:14:51.589 [pool-1-thread-5] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample1 - 415:14:51.589 [pool-1-thread-9] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample1 - 815:14:51.589 [pool-1-thread-4] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample1 - 315:14:51.589 [pool-1-thread-2] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample1 - 115:14:51.589 [pool-1-thread-8] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample1 - 715:14:51.696 [main] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample1 - finish\n12345678910111213141516171819202122232425262728293031323334353637383940import java.util.concurrent.CountDownLatch;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;import java.util.concurrent.TimeUnit;import lombok.extern.slf4j.Slf4j;@Slf4jpublic class CountDownLatchExample2 &#123;    private final static int threadCount = 10;    public static void main(String[] args) throws Exception &#123;        ExecutorService exec = Executors.newCachedThreadPool();        final CountDownLatch countDownLatch = new CountDownLatch(threadCount);        for (int i = 0; i &lt; threadCount; i++) &#123;            final int threadNum = i;            exec.execute(() -&gt; &#123;                try &#123;                    test(threadNum);                &#125; catch (Exception e) &#123;                    log.error(&quot;exception&quot;, e);                &#125; finally &#123;                    countDownLatch.countDown();                &#125;            &#125;);        &#125;        countDownLatch.await(10, TimeUnit.MILLISECONDS);        log.info(&quot;finish&quot;);        exec.shutdown();    &#125;    private static void test(int threadNum) throws Exception &#123;        Thread.sleep(100);        log.info(&quot;&#123;&#125;&quot;, threadNum);    &#125;&#125;\n结果:123456789101115:17:50.556 [main] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample2 - finish15:17:50.644 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample2 - 015:17:50.644 [pool-1-thread-4] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample2 - 315:17:50.644 [pool-1-thread-3] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample2 - 215:17:50.644 [pool-1-thread-7] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample2 - 615:17:50.644 [pool-1-thread-8] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample2 - 715:17:50.644 [pool-1-thread-2] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample2 - 115:17:50.645 [pool-1-thread-10] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample2 - 915:17:50.644 [pool-1-thread-9] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample2 - 815:17:50.644 [pool-1-thread-6] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample2 - 515:17:50.644 [pool-1-thread-5] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample2 - 4\n\n使用场景:12仅能提供有限的访问资源，比如：我们项目中的数据库，数据库的最大连接数只有20，而我们的上层应用的并发数会远远大于20，如果同时对数据库进行操作，就可能会出现因为无法获取数据库连接数导致异常，这时候就可以通过信号量来做并发访问控制，当信号量semaphore把并发数控制到1时，就跟单线程运行很相似，\n1234567891011121314151617181920212223242526272829303132333435363738import lombok.extern.slf4j.Slf4j;import java.util.concurrent.CountDownLatch;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;import java.util.concurrent.Semaphore;@Slf4jpublic class SemaphoreExample1 &#123;    private final static int threadCount = 10;    public static void main(String[] args) throws Exception &#123;        ExecutorService exec = Executors.newCachedThreadPool();        final Semaphore semaphore = new Semaphore(3);        for (int i = 0; i &lt; threadCount; i++) &#123;            final int threadNum = i;            exec.execute(() -&gt; &#123;                try &#123;                    semaphore.acquire(); // 获取一个许可                    test(threadNum);                    semaphore.release(); // 释放一个许可                &#125; catch (Exception e) &#123;                    log.error(&quot;exception&quot;, e);                &#125;            &#125;);        &#125;        exec.shutdown();    &#125;    private static void test(int threadNum) throws Exception &#123;        log.info(&quot;&#123;&#125;&quot;, threadNum);        Thread.sleep(1000);    &#125;&#125;\n结果: 大概每隔1s打印3行1234567891012:14:18.188 [pool-1-thread-2] INFO com.mmall.concurrency.example.aqs.SemaphoreExample1 - 112:14:18.188 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.SemaphoreExample1 - 012:14:18.188 [pool-1-thread-3] INFO com.mmall.concurrency.example.aqs.SemaphoreExample1 - 212:14:19.194 [pool-1-thread-4] INFO com.mmall.concurrency.example.aqs.SemaphoreExample1 - 312:14:19.194 [pool-1-thread-5] INFO com.mmall.concurrency.example.aqs.SemaphoreExample1 - 412:14:19.194 [pool-1-thread-6] INFO com.mmall.concurrency.example.aqs.SemaphoreExample1 - 512:14:20.195 [pool-1-thread-8] INFO com.mmall.concurrency.example.aqs.SemaphoreExample1 - 712:14:20.195 [pool-1-thread-9] INFO com.mmall.concurrency.example.aqs.SemaphoreExample1 - 812:14:20.195 [pool-1-thread-7] INFO com.mmall.concurrency.example.aqs.SemaphoreExample1 - 612:14:21.196 [pool-1-thread-10] INFO com.mmall.concurrency.example.aqs.SemaphoreExample1 - 9\n12345678910111213141516171819202122232425262728293031323334353637import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;import java.util.concurrent.Semaphore;import lombok.extern.slf4j.Slf4j;@Slf4jpublic class SemaphoreExample2 &#123;    private final static int threadCount = 10;    public static void main(String[] args) throws Exception &#123;        ExecutorService exec = Executors.newCachedThreadPool();        final Semaphore semaphore = new Semaphore(3);        for (int i = 0; i &lt; threadCount; i++) &#123;            final int threadNum = i;            exec.execute(() -&gt; &#123;                try &#123;                    semaphore.acquire(3); // 获取多个许可                    test(threadNum);                    semaphore.release(3); // 释放多个许可                &#125; catch (Exception e) &#123;                    log.error(&quot;exception&quot;, e);                &#125;            &#125;);        &#125;        exec.shutdown();    &#125;    private static void test(int threadNum) throws Exception &#123;        log.info(&quot;&#123;&#125;&quot;, threadNum);        Thread.sleep(1000);    &#125;&#125;\n结果: 大概每隔1s打印1行1234567891012:17:05.304 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - 012:17:06.310 [pool-1-thread-2] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - 112:17:07.310 [pool-1-thread-3] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - 212:17:08.310 [pool-1-thread-4] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - 312:17:09.311 [pool-1-thread-5] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - 412:17:10.312 [pool-1-thread-6] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - 512:17:11.312 [pool-1-thread-7] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - 612:17:12.313 [pool-1-thread-8] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - 712:17:13.314 [pool-1-thread-9] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - 812:17:14.314 [pool-1-thread-10] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - 9\n123456789101112131415161718192021222324252627282930313233343536373839import lombok.extern.slf4j.Slf4j;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;import java.util.concurrent.Semaphore;import java.util.concurrent.TimeUnit;@Slf4jpublic class SemaphoreExample3 &#123;    private final static int threadCount = 20;    public static void main(String[] args) throws Exception &#123;        ExecutorService exec = Executors.newCachedThreadPool();        final Semaphore semaphore = new Semaphore(3);        for (int i = 0; i &lt; threadCount; i++) &#123;            final int threadNum = i;            exec.execute(() -&gt; &#123;                try &#123;                    if (semaphore.tryAcquire()) &#123; // 尝试获取一个许可                        test(threadNum);                        semaphore.release(); // 释放一个许可                    &#125;                &#125; catch (Exception e) &#123;                    log.error(&quot;exception&quot;, e);                &#125;            &#125;);        &#125;        exec.shutdown();    &#125;    private static void test(int threadNum) throws Exception &#123;        log.info(&quot;&#123;&#125;&quot;, threadNum);        Thread.sleep(1000);    &#125;&#125;\n结果:12312:19:05.556 [pool-1-thread-3] INFO com.mmall.concurrency.example.aqs.SemaphoreExample3 - 212:19:05.556 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.SemaphoreExample3 - 012:19:05.556 [pool-1-thread-2] INFO com.mmall.concurrency.example.aqs.SemaphoreExample3 - 1\n123456789101112131415161718192021222324252627282930313233343536373839import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;import java.util.concurrent.Semaphore;import java.util.concurrent.TimeUnit;import lombok.extern.slf4j.Slf4j;@Slf4jpublic class SemaphoreExample4 &#123;    private final static int threadCount = 10;    public static void main(String[] args) throws Exception &#123;        ExecutorService exec = Executors.newCachedThreadPool();        final Semaphore semaphore = new Semaphore(3);        for (int i = 0; i &lt; threadCount; i++) &#123;            final int threadNum = i;            exec.execute(() -&gt; &#123;                try &#123;                    if (semaphore.tryAcquire(5000, TimeUnit.MILLISECONDS)) &#123; // 尝试获取一个许可                        test(threadNum);                        semaphore.release(); // 释放一个许可                    &#125;                &#125; catch (Exception e) &#123;                    log.error(&quot;exception&quot;, e);                &#125;            &#125;);        &#125;        exec.shutdown();    &#125;    private static void test(int threadNum) throws Exception &#123;        log.info(&quot;&#123;&#125;&quot;, threadNum);        Thread.sleep(1000);    &#125;&#125;\n结果: 大概每隔1s打印3行12345678910111213141512:22:58.289 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 012:22:58.289 [pool-1-thread-3] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 212:22:58.289 [pool-1-thread-2] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 112:22:59.294 [pool-1-thread-6] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 512:22:59.294 [pool-1-thread-5] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 412:22:59.294 [pool-1-thread-4] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 312:23:00.294 [pool-1-thread-8] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 712:23:00.294 [pool-1-thread-7] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 612:23:00.294 [pool-1-thread-9] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 812:23:01.294 [pool-1-thread-11] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 1012:23:01.294 [pool-1-thread-10] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 912:23:01.294 [pool-1-thread-12] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 1112:23:02.295 [pool-1-thread-15] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 1412:23:02.295 [pool-1-thread-13] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 1212:23:02.295 [pool-1-thread-14] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 13\n\n12345678910111213141516171819202122232425262728293031323334353637383940414243import lombok.extern.slf4j.Slf4j;import java.util.concurrent.CyclicBarrier;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;@Slf4jpublic class CyclicBarrierExample1 &#123;    private static CyclicBarrier barrier = new CyclicBarrier(5);    public static void main(String[] args) throws Exception &#123;        ExecutorService executor = Executors.newCachedThreadPool();        for (int i = 0; i &lt; 10; i++) &#123;            final int threadNum = i;            Thread.sleep(1000);            executor.execute(() -&gt; &#123;                try &#123;                    race(threadNum);                &#125; catch (Exception e) &#123;                    log.error(&quot;exception&quot;, e);                &#125;            &#125;);        &#125;        executor.shutdown();    &#125;    private static void race(int threadNum) throws Exception &#123;        Thread.sleep(1000);        log.info(&quot;&#123;&#125; is ready&quot;, threadNum);        barrier.await();/*        try &#123;            barrier.await(2000, TimeUnit.MILLISECONDS);        &#125; catch (Exception e) &#123;            log.warn(&quot;BarrierException&quot;, e);        &#125;*/        log.info(&quot;&#123;&#125; continue&quot;, threadNum);    &#125;&#125;\n结果：123456789101112131415161718192023:57:27.925 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 0 is ready23:57:28.916 [pool-1-thread-2] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 1 is ready23:57:29.917 [pool-1-thread-3] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 2 is ready23:57:30.917 [pool-1-thread-4] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 3 is ready23:57:31.918 [pool-1-thread-5] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 4 is ready23:57:31.918 [pool-1-thread-5] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 4 continue23:57:31.918 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 0 continue23:57:31.918 [pool-1-thread-2] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 1 continue23:57:31.918 [pool-1-thread-3] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 2 continue23:57:31.918 [pool-1-thread-4] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 3 continue23:57:32.919 [pool-1-thread-6] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 5 is ready23:57:33.918 [pool-1-thread-4] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 6 is ready23:57:34.919 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 7 is ready23:57:35.919 [pool-1-thread-2] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 8 is ready23:57:36.920 [pool-1-thread-3] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 9 is ready23:57:36.920 [pool-1-thread-3] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 9 continue23:57:36.920 [pool-1-thread-6] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 5 continue23:57:36.920 [pool-1-thread-4] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 6 continue23:57:36.920 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 7 continue23:57:36.920 [pool-1-thread-2] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 8 continue\n1234567891011121314151617181920212223242526272829303132333435363738import lombok.extern.slf4j.Slf4j;import java.util.concurrent.CyclicBarrier;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;@Slf4jpublic class CyclicBarrierExample3 &#123;    private static CyclicBarrier barrier = new CyclicBarrier(5, () -&gt; &#123;        log.info(&quot;callback is running&quot;);    &#125;);    public static void main(String[] args) throws Exception &#123;        ExecutorService executor = Executors.newCachedThreadPool();        for (int i = 0; i &lt; 10; i++) &#123;            final int threadNum = i;            Thread.sleep(1000);            executor.execute(() -&gt; &#123;                try &#123;                    race(threadNum);                &#125; catch (Exception e) &#123;                    log.error(&quot;exception&quot;, e);                &#125;            &#125;);        &#125;        executor.shutdown();    &#125;    private static void race(int threadNum) throws Exception &#123;        Thread.sleep(1000);        log.info(&quot;&#123;&#125; is ready&quot;, threadNum);        barrier.await();        log.info(&quot;&#123;&#125; continue&quot;, threadNum);    &#125;&#125;\n1234567891011121314151617181920212200:00:48.622 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 0 is ready00:00:49.618 [pool-1-thread-2] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 1 is ready00:00:50.618 [pool-1-thread-3] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 2 is ready00:00:51.618 [pool-1-thread-4] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 3 is ready00:00:52.617 [pool-1-thread-5] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 4 is ready00:00:52.617 [pool-1-thread-5] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - callback is running00:00:52.617 [pool-1-thread-5] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 4 continue00:00:52.618 [pool-1-thread-2] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 1 continue00:00:52.618 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 0 continue00:00:52.618 [pool-1-thread-3] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 2 continue00:00:52.618 [pool-1-thread-4] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 3 continue00:00:53.619 [pool-1-thread-6] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 5 is ready00:00:54.618 [pool-1-thread-4] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 6 is ready00:00:55.619 [pool-1-thread-3] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 7 is ready00:00:56.619 [pool-1-thread-2] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 8 is ready00:00:57.620 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 9 is ready00:00:57.620 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - callback is running00:00:57.620 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 9 continue00:00:57.620 [pool-1-thread-6] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 5 continue00:00:57.620 [pool-1-thread-4] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 6 continue00:00:57.620 [pool-1-thread-3] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 7 continue00:00:57.620 [pool-1-thread-2] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 8 continue\n\n\nsynchronized:12345678910111213141516171819202122232425262728293031323334353637383940414243import lombok.extern.slf4j.Slf4j;import java.util.concurrent.CountDownLatch;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;import java.util.concurrent.Semaphore;@Slf4j@ThreadSafepublic class LockExample1 &#123;    // 请求总数    public static int clientTotal = 5000;    // 同时并发执行的线程数    public static int threadTotal = 200;    public static int count = 0;    public static void main(String[] args) throws Exception &#123;        ExecutorService executorService = Executors.newCachedThreadPool();        final Semaphore semaphore = new Semaphore(threadTotal);        final CountDownLatch countDownLatch = new CountDownLatch(clientTotal);        for (int i = 0; i &lt; clientTotal ; i++) &#123;            executorService.execute(() -&gt; &#123;                try &#123;                    semaphore.acquire();                    add();                    semaphore.release();                &#125; catch (Exception e) &#123;                    log.error(&quot;exception&quot;, e);                &#125;                countDownLatch.countDown();            &#125;);        &#125;        countDownLatch.await();        executorService.shutdown();        log.info(&quot;count:&#123;&#125;&quot;, count);    &#125;    private synchronized static void add() &#123;        count++;    &#125;&#125;\nReentrantLock:1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253import lombok.extern.slf4j.Slf4j;import java.util.concurrent.CountDownLatch;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;import java.util.concurrent.Semaphore;import java.util.concurrent.locks.Lock;import java.util.concurrent.locks.ReentrantLock;@Slf4j@ThreadSafepublic class LockExample2 &#123;    // 请求总数    public static int clientTotal = 5000;    // 同时并发执行的线程数    public static int threadTotal = 200;    public static int count = 0;    private final static Lock lock = new ReentrantLock();    public static void main(String[] args) throws Exception &#123;        ExecutorService executorService = Executors.newCachedThreadPool();        final Semaphore semaphore = new Semaphore(threadTotal);        final CountDownLatch countDownLatch = new CountDownLatch(clientTotal);        for (int i = 0; i &lt; clientTotal ; i++) &#123;            executorService.execute(() -&gt; &#123;                try &#123;                    semaphore.acquire();                    add();                    semaphore.release();                &#125; catch (Exception e) &#123;                    log.error(&quot;exception&quot;, e);                &#125;                countDownLatch.countDown();            &#125;);        &#125;        countDownLatch.await();        executorService.shutdown();        log.info(&quot;count:&#123;&#125;&quot;, count);    &#125;    private static void add() &#123;        lock.lock();        try &#123;            count++;        &#125; finally &#123;            lock.unlock();        &#125;    &#125;&#125;\nReentrantReadWriteLock:123456789101112131415161718192021222324252627282930313233343536373839404142434445464748import lombok.extern.slf4j.Slf4j;import java.util.Map;import java.util.Set;import java.util.TreeMap;import java.util.concurrent.locks.Lock;import java.util.concurrent.locks.ReentrantReadWriteLock;@Slf4jpublic class LockExample3 &#123;    private final Map&lt;String, Data&gt; map = new TreeMap&lt;&gt;();    private final ReentrantReadWriteLock lock = new ReentrantReadWriteLock();    private final Lock readLock = lock.readLock();    private final Lock writeLock = lock.writeLock();    public Data get(String key) &#123;        readLock.lock();        try &#123;            return map.get(key);        &#125; finally &#123;            readLock.unlock();        &#125;    &#125;    public Set&lt;String&gt; getAllKeys() &#123;        readLock.lock();        try &#123;            return map.keySet();        &#125; finally &#123;            readLock.unlock();        &#125;    &#125;    public Data put(String key, Data value) &#123;        writeLock.lock();        try &#123;            return map.put(key, value);        &#125; finally &#123;            readLock.unlock();        &#125;    &#125;    class Data &#123;&#125;&#125;\nStampedLock:123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657import java.util.concurrent.locks.StampedLock;public class LockExample4 &#123;    class Point &#123;        private double x, y;        private final StampedLock sl = new StampedLock();        void move(double deltaX, double deltaY) &#123; // an exclusively locked method            long stamp = sl.writeLock();            try &#123;                x += deltaX;                y += deltaY;            &#125; finally &#123;                sl.unlockWrite(stamp);            &#125;        &#125;        //下面看看乐观读锁案例        double distanceFromOrigin() &#123; // A read-only method            long stamp = sl.tryOptimisticRead(); //获得一个乐观读锁            double currentX = x, currentY = y;  //将两个字段读入本地局部变量            if (!sl.validate(stamp)) &#123; //检查发出乐观读锁后同时是否有其他写锁发生？                stamp = sl.readLock();  //如果没有，我们再次获得一个读悲观锁                try &#123;                    currentX = x; // 将两个字段读入本地局部变量                    currentY = y; // 将两个字段读入本地局部变量                &#125; finally &#123;                    sl.unlockRead(stamp);                &#125;            &#125;            return Math.sqrt(currentX * currentX + currentY * currentY);        &#125;        //下面是悲观读锁案例        void moveIfAtOrigin(double newX, double newY) &#123; // upgrade            // Could instead start with optimistic, not read mode            long stamp = sl.readLock();            try &#123;                while (x == 0.0 &amp;&amp; y == 0.0) &#123; //循环，检查当前状态是否符合                    long ws = sl.tryConvertToWriteLock(stamp); //将读锁转为写锁                    if (ws != 0L) &#123; //这是确认转为写锁是否成功                        stamp = ws; //如果成功 替换票据                        x = newX; //进行状态改变                        y = newY;  //进行状态改变                        break;                    &#125; else &#123; //如果不能成功转换为写锁                        sl.unlockRead(stamp);  //我们显式释放读锁                        stamp = sl.writeLock();  //显式直接进行写锁 然后再通过循环再试                    &#125;                &#125;            &#125; finally &#123;                sl.unlock(stamp); //释放读锁或写锁            &#125;        &#125;    &#125;&#125;\n12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152import lombok.extern.slf4j.Slf4j;import java.util.concurrent.CountDownLatch;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;import java.util.concurrent.Semaphore;import java.util.concurrent.locks.StampedLock;@Slf4j@ThreadSafepublic class LockExample5 &#123;    // 请求总数    public static int clientTotal = 5000;    // 同时并发执行的线程数    public static int threadTotal = 200;    public static int count = 0;    private final static StampedLock lock = new StampedLock();    public static void main(String[] args) throws Exception &#123;        ExecutorService executorService = Executors.newCachedThreadPool();        final Semaphore semaphore = new Semaphore(threadTotal);        final CountDownLatch countDownLatch = new CountDownLatch(clientTotal);        for (int i = 0; i &lt; clientTotal ; i++) &#123;            executorService.execute(() -&gt; &#123;                try &#123;                    semaphore.acquire();                    add();                    semaphore.release();                &#125; catch (Exception e) &#123;                    log.error(&quot;exception&quot;, e);                &#125;                countDownLatch.countDown();            &#125;);        &#125;        countDownLatch.await();        executorService.shutdown();        log.info(&quot;count:&#123;&#125;&quot;, count);    &#125;    private static void add() &#123;        long stamp = lock.writeLock();        try &#123;            count++;        &#125; finally &#123;            lock.unlock(stamp);        &#125;    &#125;&#125;\nCondition:1234567891011121314151617181920212223242526272829303132333435363738import lombok.extern.slf4j.Slf4j;import java.util.concurrent.locks.Condition;import java.util.concurrent.locks.ReentrantLock;@Slf4jpublic class LockExample6 &#123;    public static void main(String[] args) &#123;        ReentrantLock reentrantLock = new ReentrantLock();        Condition condition = reentrantLock.newCondition();        new Thread(() -&gt; &#123;            try &#123;                reentrantLock.lock();                log.info(&quot;wait signal&quot;); // 1                condition.await();            &#125; catch (InterruptedException e) &#123;                e.printStackTrace();            &#125;            log.info(&quot;get signal&quot;); // 4            reentrantLock.unlock();        &#125;).start();        new Thread(() -&gt; &#123;            reentrantLock.lock();            log.info(&quot;get lock&quot;); // 2            try &#123;                Thread.sleep(3000);            &#125; catch (InterruptedException e) &#123;                e.printStackTrace();            &#125;            condition.signalAll();            log.info(&quot;send signal ~ &quot;); // 3            reentrantLock.unlock();        &#125;).start();    &#125;&#125;\nFuture:1234567891011121314151617181920212223242526272829import lombok.extern.slf4j.Slf4j;import java.util.concurrent.Callable;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;import java.util.concurrent.Future;@Slf4jpublic class FutureExample &#123;    static class MyCallable implements Callable&lt;String&gt; &#123;        @Override        public String call() throws Exception &#123;            log.info(&quot;do something in callable&quot;);            Thread.sleep(5000);            return &quot;Done&quot;;        &#125;    &#125;    public static void main(String[] args) throws Exception &#123;        ExecutorService executorService = Executors.newCachedThreadPool();        Future&lt;String&gt; future = executorService.submit(new MyCallable());        log.info(&quot;do something in main&quot;);        Thread.sleep(1000);        String result = future.get();        log.info(&quot;result：&#123;&#125;&quot;, result);    &#125;&#125;\nFutureTask:12345678910111213141516171819202122232425import lombok.extern.slf4j.Slf4j;import java.util.concurrent.Callable;import java.util.concurrent.FutureTask;@Slf4jpublic class FutureTaskExample &#123;    public static void main(String[] args) throws Exception &#123;        FutureTask&lt;String&gt; futureTask = new FutureTask&lt;String&gt;(new Callable&lt;String&gt;() &#123;            @Override            public String call() throws Exception &#123;                log.info(&quot;do something in callable&quot;);                Thread.sleep(5000);                return &quot;Done&quot;;            &#125;        &#125;);        new Thread(futureTask).start();        log.info(&quot;do something in main&quot;);        Thread.sleep(1000);        String result = futureTask.get();        log.info(&quot;result：&#123;&#125;&quot;, result);    &#125;&#125;\n结果:12309:06:15.160 [main] INFO com.mmall.concurrency.example.aqs.FutureTaskExample - do something in main09:06:15.160 [Thread-0] INFO com.mmall.concurrency.example.aqs.FutureTaskExample - do something in callable09:06:20.164 [main] INFO com.mmall.concurrency.example.aqs.FutureTaskExample - result：Done\nJUC组件拓展\n12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364import lombok.extern.slf4j.Slf4j;import java.util.concurrent.ForkJoinPool;import java.util.concurrent.Future;import java.util.concurrent.RecursiveTask;@Slf4jpublic class ForkJoinTaskExample extends RecursiveTask&lt;Integer&gt; &#123;    public static final int threshold = 2;    private int start;    private int end;    public ForkJoinTaskExample(int start, int end) &#123;        this.start = start;        this.end = end;    &#125;    @Override    protected Integer compute() &#123;        int sum = 0;        //如果任务足够小就计算任务        boolean canCompute = (end - start) &lt;= threshold;        if (canCompute) &#123;            for (int i = start; i &lt;= end; i++) &#123;                sum += i;            &#125;        &#125; else &#123;            // 如果任务大于阈值，就分裂成两个子任务计算            int middle = (start + end) / 2;            ForkJoinTaskExample leftTask = new ForkJoinTaskExample(start, middle);            ForkJoinTaskExample rightTask = new ForkJoinTaskExample(middle + 1, end);            // 执行子任务            leftTask.fork();            rightTask.fork();            // 等待任务执行结束合并其结果            int leftResult = leftTask.join();            int rightResult = rightTask.join();            // 合并子任务            sum = leftResult + rightResult;        &#125;        return sum;    &#125;    public static void main(String[] args) &#123;        ForkJoinPool forkjoinPool = new ForkJoinPool();        //生成一个计算任务，计算1+2+3+4        ForkJoinTaskExample task = new ForkJoinTaskExample(1, 100);        //执行一个任务        Future&lt;Integer&gt; result = forkjoinPool.submit(task);        try &#123;            log.info(&quot;result:&#123;&#125;&quot;, result.get());        &#125; catch (Exception e) &#123;            log.error(&quot;exception&quot;, e);        &#125;    &#125;&#125;\n\n\n\n\n线程调度-线程池\n\n\n1234运行的线程数量  &lt;  corePoolSize                        直接创建新线程来处理任务即使线程池中的其他线程是空闲的corePoolSize  &lt;=  线程池的线程数量  &lt; maximumPoolSize  只有当workQueue满时才会创建新的线程处理任务corePoolSize   =  maximumPoolSize                     创建的线程池大小是固定的，这时如果有新任务提交，workQueue没满时，把请求放到workQueue里面，等待有空闲等待线程从里面取出任务进行处理运行的线程数量  &gt;  maximumPoolSize                     如果workQueue满了，通过指定策略来处理这个任务\n1234提交一个新的任务到线程池以后，线程池会根据当前线程池中运行的线程数量来决定该任务的处理方式1.直接切换       SynchronousQueue2.使用无界队列   LnkedBlockingQueue 能创建的最大线程数就是corePoolSize3.使用有界队列   ArrayBlockQueue    将线程的最大线程数量设置为maximumPoolSize ，降低资源的消耗\n12降低系统资源的消耗（cpu使用率，操作系统资源的消耗）可以设置一个较大的队列容量，较小的线程池容量，降低线程处理任务的吞吐量提交的任务经常发生阻塞，调用设置线程最大线程数方法重新设置线程的容量，如果队列容量设置较小通常需要把线程池容量设置大一点，CPU的使用率会相对高一些\n\n1234AbortPolicy：直接抛出异常CallerRunsPolicy：用调用者使用的线程来执行任务DiscardOldestPolicy：丢弃掉阻塞队列中最靠前的任务，并执行当前任务DiscardPolicy：直接丢弃当前任务\n\n\n\n\n\n12345678910111213141516171819202122232425import lombok.extern.slf4j.Slf4j;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;@Slf4jpublic class ThreadPoolExample1 &#123;    public static void main(String[] args) &#123;        ExecutorService executorService = Executors.newCachedThreadPool();        // ExecutorService executorService = Executors.newFixedThreadPool(3);        // ExecutorService executorService = Executors.newSingleThreadExecutor();        for (int i = 0; i &lt; 10; i++) &#123;            final int index = i;            executorService.execute(new Runnable() &#123;                @Override                public void run() &#123;                    log.info(&quot;task:&#123;&#125;&quot;, index);                &#125;            &#125;);        &#125;        executorService.shutdown();    &#125;&#125;\n1234567891011121314151617181920212223242526272829303132333435363738import lombok.extern.slf4j.Slf4j;import java.util.Date;import java.util.Timer;import java.util.TimerTask;import java.util.concurrent.Executors;import java.util.concurrent.ScheduledExecutorService;import java.util.concurrent.TimeUnit;@Slf4jpublic class ThreadPoolExample4 &#123;    public static void main(String[] args) &#123;        ScheduledExecutorService executorService = Executors.newScheduledThreadPool(1);//        executorService.schedule(new Runnable() &#123;//            @Override//            public void run() &#123;//                log.warn(&quot;schedule run&quot;);//            &#125;//        &#125;, 3, TimeUnit.SECONDS);        executorService.scheduleAtFixedRate(new Runnable() &#123;            @Override            public void run() &#123;                log.warn(&quot;schedule run&quot;);            &#125;        &#125;, 1, 3, TimeUnit.SECONDS);//        executorService.shutdown();        Timer timer = new Timer();        timer.schedule(new TimerTask() &#123;            @Override            public void run() &#123;                log.warn(&quot;timer run&quot;);            &#125;        &#125;, new Date(), 5 * 1000);    &#125;&#125;\n\n死锁\n1234567891011避免死锁1.按顺序加锁2.加锁时间（超过一定时间就放弃该锁的请求，并释放自己占有的锁）3.死锁检测（以上两种方式都无法解决）每当一个线程获取了锁，会在线程和锁的相关数据结构中记下来，除此之外，每当有线程请求锁，也需要记录在这个数据结构中，当一个线程请求锁失败的时候，这个线程可以遍历锁的关系图，看是否有死锁发生，并决定后续操作该怎么办，具体这个结构需要大家根据实际情况去设计一下，那么，当检测出死锁的时候，线程都可以做哪些是事情呢，一个可执行的做法是释放所有锁，回退，并且等待一定时间（随机）后，之后进行重试，这个和简单的加锁超时有些类似，不一样的是，只有死锁发生了才回退而不会因为加锁请求超时了，虽然有了回退和等待，但是，如果有大量线程又同时竞争同一批锁，他们还是有可能出现重复死锁，这时候有个更好的方案，给这些线程设置优先级，让一个或几个线程回退，剩下的线程就像reantran锁一样，继续保持他们，如果赋予这些线程的优先级是固定不变的，可以在死锁发生的时候设置随机的线程优先级\n并发最佳实践\n\n\nspring与线程安全\nHashMap与ConcurrentHashMap解析\n\n\n\n\n\n\n\n","dateCreated":"2019-08-25T11:46:27+08:00","dateModified":"2019-08-25T12:12:28+08:00","datePublished":"2019-08-25T11:46:27+08:00","description":"","headline":"并发编程","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"http://yoursite.com/2019/08/25/并发编程与高并发解决方案/"},"publisher":{"@type":"Organization","name":"Brotherc","sameAs":["https://github.com/Brotherc"],"image":"head.jpg","logo":{"@type":"ImageObject","url":"head.jpg"}},"url":"http://yoursite.com/2019/08/25/并发编程与高并发解决方案/","keywords":"并发编程与高并发解决方案"}</script>
    <meta name="description" content="准备    基本概念   CPU多级缓存     JAVA内存模型            并发的优势与风险 线程安全性  原子性 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051import lombok.extern.slf4j.Slf4j;import ja">
<meta name="keywords" content="并发编程与高并发解决方案">
<meta property="og:type" content="blog">
<meta property="og:title" content="并发编程">
<meta property="og:url" content="http://yoursite.com/2019/08/25/并发编程与高并发解决方案/index.html">
<meta property="og:site_name" content="Brotherc">
<meta property="og:description" content="准备    基本概念   CPU多级缓存     JAVA内存模型            并发的优势与风险 线程安全性  原子性 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051import lombok.extern.slf4j.Slf4j;import ja">
<meta property="og:locale" content="zh-cn">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/1.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/2.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/3.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/54.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/4.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/5.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/6.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/7.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/8.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/9.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/10.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/11.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/12.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/13.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/14.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/15.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/16.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/17.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/18.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/19.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/20.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/21.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/22.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/23.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/24.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/25.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/26.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/27.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/28.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/29.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/30.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/31.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/32.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/33.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/34.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/35.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/36.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/38.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/39.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/40.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/41.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/42.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/43.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/44.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/45.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/47.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/48.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/49.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/51.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/52.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/53.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/55.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/57.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/58.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/59.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/60.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/61.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/62.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/63.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/64.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/65.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/66.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/67.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/68.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/69.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/70.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/71.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/72.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/73.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/74.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/75.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/76.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/77.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/78.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/79.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/80.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/81.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/82.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/83.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/84.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/85.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/86.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/87.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/88.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/89.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/90.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/91.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/92.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/93.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/94.jpg">
<meta property="og:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/95.jpg">
<meta property="og:updated_time" content="2019-08-25T04:12:28.561Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="并发编程">
<meta name="twitter:description" content="准备    基本概念   CPU多级缓存     JAVA内存模型            并发的优势与风险 线程安全性  原子性 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051import lombok.extern.slf4j.Slf4j;import ja">
<meta name="twitter:image" content="http://yoursite.com/assets/并发编程与高并发解决方案/1.jpg">
    
    
        
    
    
        <meta property="og:image" content="http://yoursite.com/assets/images/head.jpg"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-c4ozcsklz4kht2pebhp44xorvyverh23toayhn7i6ubrpyedak24hv1v0hyd.min.css">
    <!--STYLES END-->
    

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/ ">Brotherc</a>
    </div>
    
        
            <a class="header-right-picture " href="#about">
        
        
            <img class="header-picture" src="/assets/images/head.jpg" alt="作者的图片">
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="4">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a href="/#about">
                    <img class="sidebar-profile-picture" src="/assets/images/head.jpg" alt="作者的图片">
                </a>
                <h4 class="sidebar-profile-name">Brotherc</h4>
                
                    <h5 class="sidebar-profile-bio"><p>java development</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/ " title="首页">
                    
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首页</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-categories" title="分类">
                    
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">分类</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-tags" title="标签">
                    
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">标签</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link open-algolia-search" href="/all-archives" title="归档">
                    
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">归档</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="#about" title="关于">
                    
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">关于</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://github.com/Brotherc" target="_blank" rel="noopener" title="GitHub">
                    
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="4"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            并发编程
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2019-08-25T11:46:27+08:00">
	
		    8月 25, 2019
    	
    </time>
    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/1.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/1.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/2.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/2.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/3.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/3.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/54.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/54.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/4.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/4.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/5.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/5.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/6.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/6.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h3 id="CPU多级缓存"><a href="#CPU多级缓存" class="headerlink" title="CPU多级缓存"></a>CPU多级缓存</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/7.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/7.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/8.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/8.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/9.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/9.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/10.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/10.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/11.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/11.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h3 id="JAVA内存模型"><a href="#JAVA内存模型" class="headerlink" title="JAVA内存模型"></a>JAVA内存模型</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/12.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/12.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/13.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/13.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/14.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/14.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/15.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/15.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/16.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/16.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/17.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/17.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/18.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/18.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/19.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/19.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/20.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/20.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/21.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/21.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/22.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/22.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/23.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/23.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h3 id="并发的优势与风险"><a href="#并发的优势与风险" class="headerlink" title="并发的优势与风险"></a>并发的优势与风险</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/24.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/24.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h3 id="线程安全性"><a href="#线程安全性" class="headerlink" title="线程安全性"></a>线程安全性</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/25.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/25.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/26.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/26.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h4 id="原子性"><a href="#原子性" class="headerlink" title="原子性"></a>原子性</h4><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/27.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/27.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.CountDownLatch;</span><br><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line">import java.util.concurrent.Semaphore;</span><br><span class="line">import java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line">import java.util.concurrent.atomic.AtomicLong;</span><br><span class="line">import java.util.concurrent.atomic.LongAdder;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@ThreadSafe</span><br><span class="line">public class AtomicExample1 &#123;</span><br><span class="line"></span><br><span class="line">    // 请求总数</span><br><span class="line">    public static int clientTotal = 5000;</span><br><span class="line"></span><br><span class="line">    // 同时并发执行的线程数</span><br><span class="line">    public static int threadTotal = 200;</span><br><span class="line"></span><br><span class="line">    public static AtomicInteger count = new AtomicInteger(0);</span><br><span class="line">    // public static AtomicLong count = new AtomicLong(0);</span><br><span class="line">    // public static LongAdder count = new LongAdder();</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        final Semaphore semaphore = new Semaphore(threadTotal);</span><br><span class="line">        final CountDownLatch countDownLatch = new CountDownLatch(clientTotal);</span><br><span class="line">        for (int i = 0; i &lt; clientTotal ; i++) &#123;</span><br><span class="line">            executorService.execute(() -&gt; &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    add();</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    log.error(&quot;exception&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(&quot;count:&#123;&#125;&quot;, count.get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void add() &#123;</span><br><span class="line">        count.incrementAndGet();</span><br><span class="line">        // count.getAndIncrement();</span><br><span class="line">        // count.increment();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.CountDownLatch;</span><br><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line">import java.util.concurrent.Semaphore;</span><br><span class="line">import java.util.concurrent.atomic.AtomicReference;</span><br><span class="line">import java.util.concurrent.atomic.LongAdder;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@ThreadSafe</span><br><span class="line">public class AtomicExample4 &#123;</span><br><span class="line"></span><br><span class="line">    private static AtomicReference&lt;Integer&gt; count = new AtomicReference&lt;&gt;(0);</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        count.compareAndSet(0, 2); // 2</span><br><span class="line">        count.compareAndSet(0, 1); // no</span><br><span class="line">        count.compareAndSet(1, 3); // no</span><br><span class="line">        count.compareAndSet(2, 4); // 4</span><br><span class="line">        count.compareAndSet(3, 5); // no</span><br><span class="line">        log.info(&quot;count:&#123;&#125;&quot;, count.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">import java.util.concurrent.atomic.AtomicIntegerFieldUpdater;</span><br><span class="line"></span><br><span class="line">import lombok.Getter;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">public class AtomicExample5 &#123;</span><br><span class="line"></span><br><span class="line">    private static AtomicIntegerFieldUpdater&lt;AtomicExample5&gt; updater =</span><br><span class="line">            AtomicIntegerFieldUpdater.newUpdater(AtomicExample5.class, &quot;count&quot;);</span><br><span class="line"></span><br><span class="line">    @Getter</span><br><span class="line">    public volatile int count = 100;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line"></span><br><span class="line">        AtomicExample5 example5 = new AtomicExample5();</span><br><span class="line"></span><br><span class="line">        if (updater.compareAndSet(example5, 100, 120)) &#123;</span><br><span class="line">            log.info(&quot;update success 1, &#123;&#125;&quot;, example5.getCount());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (updater.compareAndSet(example5, 100, 120)) &#123;</span><br><span class="line">            log.info(&quot;update success 2, &#123;&#125;&quot;, example5.getCount());</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            log.info(&quot;update failed, &#123;&#125;&quot;, example5.getCount());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">23:15:33.084 [main] INFO com.mmall.concurrency.example.atomic.AtomicExample5 - update success 1, 120</span><br><span class="line">23:15:33.089 [main] INFO com.mmall.concurrency.example.atomic.AtomicExample5 - update failed, 120</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.CountDownLatch;</span><br><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line">import java.util.concurrent.Semaphore;</span><br><span class="line">import java.util.concurrent.atomic.AtomicBoolean;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@ThreadSafe</span><br><span class="line">public class AtomicExample6 &#123;</span><br><span class="line"></span><br><span class="line">    private static AtomicBoolean isHappened = new AtomicBoolean(false);</span><br><span class="line"></span><br><span class="line">    // 请求总数</span><br><span class="line">    public static int clientTotal = 5000;</span><br><span class="line"></span><br><span class="line">    // 同时并发执行的线程数</span><br><span class="line">    public static int threadTotal = 200;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        final Semaphore semaphore = new Semaphore(threadTotal);</span><br><span class="line">        final CountDownLatch countDownLatch = new CountDownLatch(clientTotal);</span><br><span class="line">        for (int i = 0; i &lt; clientTotal ; i++) &#123;</span><br><span class="line">            executorService.execute(() -&gt; &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    test();</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    log.error(&quot;exception&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(&quot;isHappened:&#123;&#125;&quot;, isHappened.get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void test() &#123;</span><br><span class="line">        if (isHappened.compareAndSet(false, true)) &#123;</span><br><span class="line">            log.info(&quot;execute&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">23:19:09.823 [pool-1-thread-1] INFO com.mmall.concurrency.example.atomic.AtomicExample6 - execute</span><br><span class="line">23:19:09.840 [main] INFO com.mmall.concurrency.example.atomic.AtomicExample6 - isHappened:true</span><br></pre></td></tr></table></figure></p>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/28.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/28.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/29.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/29.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/30.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/30.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h4 id="可见性"><a href="#可见性" class="headerlink" title="可见性"></a>可见性</h4><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/31.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/31.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/32.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/32.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/33.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/33.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/34.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/34.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/35.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/35.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/36.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/36.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h4 id="有序性"><a href="#有序性" class="headerlink" title="有序性"></a>有序性</h4><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/38.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/38.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/39.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/39.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/40.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/40.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/41.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/41.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/42.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/42.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h3 id="安全发布对象"><a href="#安全发布对象" class="headerlink" title="安全发布对象"></a>安全发布对象</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/43.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/43.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@NotThreadSafe</span><br><span class="line">@NotRecommend</span><br><span class="line">public class Escape &#123;</span><br><span class="line"></span><br><span class="line">    private int thisCanBeEscape = 0;</span><br><span class="line"></span><br><span class="line">    public Escape () &#123;</span><br><span class="line">        new InnerClass();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private class InnerClass &#123;</span><br><span class="line"></span><br><span class="line">        public InnerClass() &#123;</span><br><span class="line">            log.info(&quot;&#123;&#125;&quot;, Escape.this.thisCanBeEscape);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        new Escape();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">import java.util.Arrays;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@NotThreadSafe</span><br><span class="line">public class UnsafePublish &#123;</span><br><span class="line">    private String[] states = &#123;&quot;a&quot;, &quot;b&quot;, &quot;c&quot;&#125;;</span><br><span class="line"></span><br><span class="line">    public String[] getStates() &#123;</span><br><span class="line">        return states;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        UnsafePublish unsafePublish = new UnsafePublish();</span><br><span class="line">        log.info(&quot;&#123;&#125;&quot;, Arrays.toString(unsafePublish.getStates()));</span><br><span class="line"></span><br><span class="line">        unsafePublish.getStates()[0] = &quot;d&quot;;</span><br><span class="line">        log.info(&quot;&#123;&#125;&quot;, Arrays.toString(unsafePublish.getStates()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/44.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/44.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 懒汉模式</span><br><span class="line"> * 单例实例在第一次使用时进行创建</span><br><span class="line"> */</span><br><span class="line">@NotThreadSafe</span><br><span class="line">public class SingletonExample1 &#123;</span><br><span class="line">    // 私有构造函数</span><br><span class="line">    private SingletonExample1() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    // 单例对象</span><br><span class="line">    private static SingletonExample1 instance = null;</span><br><span class="line"></span><br><span class="line">    // 静态的工厂方法</span><br><span class="line">    public static SingletonExample1 getInstance() &#123;</span><br><span class="line">        if (instance == null) &#123;</span><br><span class="line">            instance = new SingletonExample1();</span><br><span class="line">        &#125;</span><br><span class="line">        return instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 饿汉模式</span><br><span class="line"> * 单例实例在类装载时进行创建</span><br><span class="line"> */</span><br><span class="line">@ThreadSafe</span><br><span class="line">public class SingletonExample2 &#123;</span><br><span class="line">    // 私有构造函数</span><br><span class="line">    private SingletonExample2() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    // 单例对象</span><br><span class="line">    private static SingletonExample2 instance = new SingletonExample2();</span><br><span class="line"></span><br><span class="line">    // 静态的工厂方法</span><br><span class="line">    public static SingletonExample2 getInstance() &#123;</span><br><span class="line">        return instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 懒汉模式</span><br><span class="line"> * 单例实例在第一次使用时进行创建</span><br><span class="line"> */</span><br><span class="line">@ThreadSafe</span><br><span class="line">@NotRecommend</span><br><span class="line">public class SingletonExample3 &#123;</span><br><span class="line">    // 私有构造函数</span><br><span class="line">    private SingletonExample3() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    // 单例对象</span><br><span class="line">    private static SingletonExample3 instance = null;</span><br><span class="line"></span><br><span class="line">    // 静态的工厂方法</span><br><span class="line">    public static synchronized SingletonExample3 getInstance() &#123;</span><br><span class="line">        if (instance == null) &#123;</span><br><span class="line">            instance = new SingletonExample3();</span><br><span class="line">        &#125;</span><br><span class="line">        return instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 懒汉模式 -》 双重同步锁单例模式</span><br><span class="line"> * 单例实例在第一次使用时进行创建</span><br><span class="line"> */</span><br><span class="line">@NotThreadSafe</span><br><span class="line">public class SingletonExample4 &#123;</span><br><span class="line">    // 私有构造函数</span><br><span class="line">    private SingletonExample4() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    // 1、memory = allocate() 分配对象的内存空间</span><br><span class="line">    // 2、ctorInstance() 初始化对象</span><br><span class="line">    // 3、instance = memory 设置instance指向刚分配的内存</span><br><span class="line"></span><br><span class="line">    // JVM和cpu优化，发生了指令重排</span><br><span class="line"></span><br><span class="line">    // 1、memory = allocate() 分配对象的内存空间</span><br><span class="line">    // 3、instance = memory 设置instance指向刚分配的内存</span><br><span class="line">    // 2、ctorInstance() 初始化对象</span><br><span class="line"></span><br><span class="line">    // 单例对象</span><br><span class="line">    private static SingletonExample4 instance = null;</span><br><span class="line"></span><br><span class="line">    // 静态的工厂方法</span><br><span class="line">    public static SingletonExample4 getInstance() &#123;</span><br><span class="line">        if (instance == null) &#123; // 双重检测机制        // B</span><br><span class="line">            synchronized (SingletonExample4.class) &#123; // 同步锁</span><br><span class="line">                if (instance == null) &#123;</span><br><span class="line">                    instance = new SingletonExample4(); // A - 3</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 懒汉模式 -》 双重同步锁单例模式</span><br><span class="line"> * 单例实例在第一次使用时进行创建</span><br><span class="line"> */</span><br><span class="line">@ThreadSafe</span><br><span class="line">public class SingletonExample5 &#123;</span><br><span class="line">    // 私有构造函数</span><br><span class="line">    private SingletonExample5() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    // 1、memory = allocate() 分配对象的内存空间</span><br><span class="line">    // 2、ctorInstance() 初始化对象</span><br><span class="line">    // 3、instance = memory 设置instance指向刚分配的内存</span><br><span class="line"></span><br><span class="line">    // 单例对象 volatile + 双重检测机制 -&gt; 禁止指令重排</span><br><span class="line">    private volatile static SingletonExample5 instance = null;</span><br><span class="line"></span><br><span class="line">    // 静态的工厂方法</span><br><span class="line">    public static SingletonExample5 getInstance() &#123;</span><br><span class="line">        if (instance == null) &#123; // 双重检测机制        // B</span><br><span class="line">            synchronized (SingletonExample5.class) &#123; // 同步锁</span><br><span class="line">                if (instance == null) &#123;</span><br><span class="line">                    instance = new SingletonExample5(); // A - 3</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 饿汉模式</span><br><span class="line"> * 单例实例在类装载时进行创建</span><br><span class="line"> */</span><br><span class="line">@ThreadSafe</span><br><span class="line">public class SingletonExample6 &#123;</span><br><span class="line">    // 私有构造函数</span><br><span class="line">    private SingletonExample6() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    // 单例对象</span><br><span class="line">    private static SingletonExample6 instance = null;</span><br><span class="line"></span><br><span class="line">    static &#123;</span><br><span class="line">        instance = new SingletonExample6();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 静态的工厂方法</span><br><span class="line">    public static SingletonExample6 getInstance() &#123;</span><br><span class="line">        return instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        System.out.println(getInstance().hashCode());</span><br><span class="line">        System.out.println(getInstance().hashCode());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 枚举模式：最安全</span><br><span class="line"> */</span><br><span class="line">@ThreadSafe</span><br><span class="line">@Recommend</span><br><span class="line">public class SingletonExample7 &#123;</span><br><span class="line"></span><br><span class="line">    // 私有构造函数</span><br><span class="line">    private SingletonExample7() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    public static SingletonExample7 getInstance() &#123;</span><br><span class="line">        return Singleton.INSTANCE.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private enum Singleton &#123;</span><br><span class="line">        INSTANCE;</span><br><span class="line"></span><br><span class="line">        private SingletonExample7 singleton;</span><br><span class="line"></span><br><span class="line">        // JVM保证这个方法绝对只调用一次</span><br><span class="line">        Singleton() &#123;</span><br><span class="line">            singleton = new SingletonExample7();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public SingletonExample7 getInstance() &#123;</span><br><span class="line">            return singleton;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="不可变对象"><a href="#不可变对象" class="headerlink" title="不可变对象"></a>不可变对象</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/45.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/45.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/47.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/47.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">import com.google.common.collect.Maps;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@NotThreadSafe</span><br><span class="line">public class ImmutableExample1 &#123;</span><br><span class="line"></span><br><span class="line">    private final static Integer a = 1;</span><br><span class="line">    private final static String b = &quot;2&quot;;</span><br><span class="line">    private final static Map&lt;Integer, Integer&gt; map = Maps.newHashMap();</span><br><span class="line"></span><br><span class="line">    static &#123;</span><br><span class="line">        map.put(1, 2);</span><br><span class="line">        map.put(3, 4);</span><br><span class="line">        map.put(5, 6);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">//        a = 2;</span><br><span class="line">//        b = &quot;3&quot;;</span><br><span class="line">//        map = Maps.newHashMap();</span><br><span class="line">        map.put(1, 3);</span><br><span class="line">        log.info(&quot;&#123;&#125;&quot;, map.get(1));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void test(final int a) &#123;</span><br><span class="line">//        a = 1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/48.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/48.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">import com.google.common.collect.Maps;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">import java.util.Collections;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@ThreadSafe</span><br><span class="line">public class ImmutableExample2 &#123;</span><br><span class="line"></span><br><span class="line">    private static Map&lt;Integer, Integer&gt; map = Maps.newHashMap();</span><br><span class="line"></span><br><span class="line">    static &#123;</span><br><span class="line">        map.put(1, 2);</span><br><span class="line">        map.put(3, 4);</span><br><span class="line">        map.put(5, 6);</span><br><span class="line">        map = Collections.unmodifiableMap(map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        map.put(1, 3);</span><br><span class="line">        log.info(&quot;&#123;&#125;&quot;, map.get(1));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.UnsupportedOperationException</span><br><span class="line">	at java.util.Collections$UnmodifiableMap.put(Collections.java:1457)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">import com.google.common.collect.ImmutableList;</span><br><span class="line">import com.google.common.collect.ImmutableMap;</span><br><span class="line">import com.google.common.collect.ImmutableSet;</span><br><span class="line"></span><br><span class="line">@ThreadSafe</span><br><span class="line">public class ImmutableExample3 &#123;</span><br><span class="line"></span><br><span class="line">    private final static ImmutableList&lt;Integer&gt; list = ImmutableList.of(1, 2, 3);</span><br><span class="line">    private final static ImmutableSet set = ImmutableSet.copyOf(list);</span><br><span class="line">    private final static ImmutableMap&lt;Integer, Integer&gt; map = ImmutableMap.of(1, 2, 3, 4);</span><br><span class="line">    private final static ImmutableMap&lt;Integer, Integer&gt; map2 = ImmutableMap.&lt;Integer, Integer&gt;builder()</span><br><span class="line">            .put(1, 2).put(3, 4).put(5, 6).build();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        System.out.println(map2.get(3));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="线程封闭"><a href="#线程封闭" class="headerlink" title="线程封闭"></a>线程封闭</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/49.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/49.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h3 id="线程不安全类与写法"><a href="#线程不安全类与写法" class="headerlink" title="线程不安全类与写法"></a>线程不安全类与写法</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/51.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/51.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<p>JodaTime:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">import com.mmall.concurrency.annoations.ThreadSafe;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.joda.time.DateTime;</span><br><span class="line">import org.joda.time.format.DateTimeFormat;</span><br><span class="line">import org.joda.time.format.DateTimeFormatter;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.CountDownLatch;</span><br><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line">import java.util.concurrent.Semaphore;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@ThreadSafe</span><br><span class="line">public class DateFormatExample3 &#123;</span><br><span class="line">    // 请求总数</span><br><span class="line">    public static int clientTotal = 5000;</span><br><span class="line">    // 同时并发执行的线程数</span><br><span class="line">    public static int threadTotal = 200;</span><br><span class="line"></span><br><span class="line">    private static DateTimeFormatter dateTimeFormatter = DateTimeFormat.forPattern(&quot;yyyyMMdd&quot;);</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        final Semaphore semaphore = new Semaphore(threadTotal);</span><br><span class="line">        final CountDownLatch countDownLatch = new CountDownLatch(clientTotal);</span><br><span class="line">        for (int i = 0; i &lt; clientTotal; i++) &#123;</span><br><span class="line">            final int count = i;</span><br><span class="line">            executorService.execute(() -&gt; &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    update(count);</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    log.error(&quot;exception&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void update(int i) &#123;</span><br><span class="line">        log.info(&quot;&#123;&#125;, &#123;&#125;&quot;, i, DateTime.parse(&quot;20180208&quot;, dateTimeFormatter).toDate());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="同步容器"><a href="#同步容器" class="headerlink" title="同步容器"></a>同步容器</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/52.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/52.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<p>Vector不是线程安全的情况:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">import java.util.Vector;</span><br><span class="line"></span><br><span class="line">@NotThreadSafe</span><br><span class="line">public class VectorExample2 &#123;</span><br><span class="line"></span><br><span class="line">    private static Vector&lt;Integer&gt; vector = new Vector&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line"></span><br><span class="line">        while (true) &#123;</span><br><span class="line"></span><br><span class="line">            for (int i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">                vector.add(i);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Thread thread1 = new Thread() &#123;</span><br><span class="line">                public void run() &#123;</span><br><span class="line">                    for (int i = 0; i &lt; vector.size(); i++) &#123;</span><br><span class="line">                        vector.remove(i);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            Thread thread2 = new Thread() &#123;</span><br><span class="line">                public void run() &#123;</span><br><span class="line">                    for (int i = 0; i &lt; vector.size(); i++) &#123;</span><br><span class="line">                        vector.get(i);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            thread1.start();</span><br><span class="line">            thread2.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ConcurrentModificationException:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">import java.util.Iterator;</span><br><span class="line">import java.util.Vector;</span><br><span class="line"></span><br><span class="line">public class VectorExample3 &#123;</span><br><span class="line">    // java.util.ConcurrentModificationException</span><br><span class="line">    private static void test1(Vector&lt;Integer&gt; v1) &#123; // foreach</span><br><span class="line">        for(Integer i : v1) &#123;</span><br><span class="line">            if (i.equals(3)) &#123;</span><br><span class="line">                v1.remove(i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // java.util.ConcurrentModificationException</span><br><span class="line">    private static void test2(Vector&lt;Integer&gt; v1) &#123; // iterator</span><br><span class="line">        Iterator&lt;Integer&gt; iterator = v1.iterator();</span><br><span class="line">        while (iterator.hasNext()) &#123;</span><br><span class="line">            Integer i = iterator.next();</span><br><span class="line">            if (i.equals(3)) &#123;</span><br><span class="line">                v1.remove(i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // success</span><br><span class="line">    private static void test3(Vector&lt;Integer&gt; v1) &#123; // for</span><br><span class="line">        for (int i = 0; i &lt; v1.size(); i++) &#123;</span><br><span class="line">            if (v1.get(i).equals(3)) &#123;</span><br><span class="line">                v1.remove(i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line"></span><br><span class="line">        Vector&lt;Integer&gt; vector = new Vector&lt;&gt;();</span><br><span class="line">        vector.add(1);</span><br><span class="line">        vector.add(2);</span><br><span class="line">        vector.add(3);</span><br><span class="line">        test1(vector);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Collections.synchronizedXXX<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">import com.google.common.collect.Lists;</span><br><span class="line">import com.google.common.collect.Sets;</span><br><span class="line">import com.mmall.concurrency.annoations.ThreadSafe;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">import java.util.Collections;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Vector;</span><br><span class="line">import java.util.Set;</span><br><span class="line">import java.util.concurrent.CountDownLatch;</span><br><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line">import java.util.concurrent.Semaphore;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@ThreadSafe</span><br><span class="line">public class CollectionsExample1 &#123;</span><br><span class="line"></span><br><span class="line">    // 请求总数</span><br><span class="line">    public static int clientTotal = 5000;</span><br><span class="line"></span><br><span class="line">    // 同时并发执行的线程数</span><br><span class="line">    public static int threadTotal = 200;</span><br><span class="line"></span><br><span class="line">    private static List&lt;Integer&gt; list = Collections.synchronizedList(Lists.newArrayList());</span><br><span class="line">    // private static Set&lt;Integer&gt; set = Collections.synchronizedSet(Sets.newHashSet());</span><br><span class="line">    // private static Map&lt;Integer, Integer&gt; map = Collections.synchronizedMap(new HashMap&lt;&gt;());</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        final Semaphore semaphore = new Semaphore(threadTotal);</span><br><span class="line">        final CountDownLatch countDownLatch = new CountDownLatch(clientTotal);</span><br><span class="line">        for (int i = 0; i &lt; clientTotal; i++) &#123;</span><br><span class="line">            final int count = i;</span><br><span class="line">            executorService.execute(() -&gt; &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    update(count);</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    log.error(&quot;exception&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(&quot;size:&#123;&#125;&quot;, list.size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void update(int i) &#123;</span><br><span class="line">        list.add(i);</span><br><span class="line">        // set.add(i);</span><br><span class="line">        // map.put(i, i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/53.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/53.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h3 id="安全共享策略"><a href="#安全共享策略" class="headerlink" title="安全共享策略"></a>安全共享策略</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/55.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/55.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/57.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/57.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h3 id="AQS"><a href="#AQS" class="headerlink" title="AQS"></a>AQS</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/58.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/58.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/59.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/59.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/60.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/60.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<p>Sync queue 同步队列（底层是双向链表）<br>Condition queue 单向链表（不是必须的，需要用到的时候才会使用）</p>
<h4 id="aqs实现的具体大致思路"><a href="#aqs实现的具体大致思路" class="headerlink" title="aqs实现的具体大致思路:"></a>aqs实现的具体大致思路:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">aqs内部维护了一个clh队列来管理锁，线程会首先尝试获取锁，如果失败，就将当前线程以及等待信息包成一个node节点，加入到之前介绍的同步队列</span><br><span class="line">，接着会不断循环尝试获取锁，条件是，当前节点为head的直接后继才会尝试，如果失败，就会阻塞自己，直到自己被唤醒，而当持有锁的线程释放锁的时候，会</span><br><span class="line">唤醒队列中的后继线程，基于这些基础的设计和思路，jdk提供了很多基于aqs的子类</span><br></pre></td></tr></table></figure>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/61.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/61.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/62.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/62.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/63.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/63.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h4 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景:"></a>使用场景:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">程序执行需要等待某个条件完成后才能继续执行后续的操作，典型的应用比如：并行计算</span><br><span class="line">当某个处理的运算量很大时，可以将该运算任务拆分成多个子任务，等待所有的子任务都完成后，</span><br><span class="line">父任务再拿到所有子任务的运算结果进行汇总</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.CountDownLatch;</span><br><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">public class CountDownLatchExample1 &#123;</span><br><span class="line"></span><br><span class="line">    private final static int threadCount = 200;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        ExecutorService exec = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">        final CountDownLatch countDownLatch = new CountDownLatch(threadCount);</span><br><span class="line"></span><br><span class="line">        for (int i = 0; i &lt; threadCount; i++) &#123;</span><br><span class="line">            final int threadNum = i;</span><br><span class="line">            exec.execute(() -&gt; &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    test(threadNum);</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    log.error(&quot;exception&quot;, e);</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    countDownLatch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        log.info(&quot;finish&quot;);</span><br><span class="line">        exec.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void test(int threadNum) throws Exception &#123;</span><br><span class="line">        Thread.sleep(100);</span><br><span class="line">        log.info(&quot;&#123;&#125;&quot;, threadNum);</span><br><span class="line">        Thread.sleep(100);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">15:14:51.589 [pool-1-thread-10] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample1 - 9</span><br><span class="line">15:14:51.589 [pool-1-thread-6] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample1 - 5</span><br><span class="line">15:14:51.589 [pool-1-thread-3] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample1 - 2</span><br><span class="line">15:14:51.589 [pool-1-thread-7] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample1 - 6</span><br><span class="line">15:14:51.589 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample1 - 0</span><br><span class="line">15:14:51.589 [pool-1-thread-5] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample1 - 4</span><br><span class="line">15:14:51.589 [pool-1-thread-9] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample1 - 8</span><br><span class="line">15:14:51.589 [pool-1-thread-4] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample1 - 3</span><br><span class="line">15:14:51.589 [pool-1-thread-2] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample1 - 1</span><br><span class="line">15:14:51.589 [pool-1-thread-8] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample1 - 7</span><br><span class="line">15:14:51.696 [main] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample1 - finish</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">import java.util.concurrent.CountDownLatch;</span><br><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">public class CountDownLatchExample2 &#123;</span><br><span class="line"></span><br><span class="line">    private final static int threadCount = 10;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        ExecutorService exec = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">        final CountDownLatch countDownLatch = new CountDownLatch(threadCount);</span><br><span class="line"></span><br><span class="line">        for (int i = 0; i &lt; threadCount; i++) &#123;</span><br><span class="line">            final int threadNum = i;</span><br><span class="line">            exec.execute(() -&gt; &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    test(threadNum);</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    log.error(&quot;exception&quot;, e);</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    countDownLatch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await(10, TimeUnit.MILLISECONDS);</span><br><span class="line">        log.info(&quot;finish&quot;);</span><br><span class="line">        exec.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void test(int threadNum) throws Exception &#123;</span><br><span class="line">        Thread.sleep(100);</span><br><span class="line">        log.info(&quot;&#123;&#125;&quot;, threadNum);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">15:17:50.556 [main] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample2 - finish</span><br><span class="line">15:17:50.644 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample2 - 0</span><br><span class="line">15:17:50.644 [pool-1-thread-4] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample2 - 3</span><br><span class="line">15:17:50.644 [pool-1-thread-3] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample2 - 2</span><br><span class="line">15:17:50.644 [pool-1-thread-7] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample2 - 6</span><br><span class="line">15:17:50.644 [pool-1-thread-8] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample2 - 7</span><br><span class="line">15:17:50.644 [pool-1-thread-2] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample2 - 1</span><br><span class="line">15:17:50.645 [pool-1-thread-10] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample2 - 9</span><br><span class="line">15:17:50.644 [pool-1-thread-9] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample2 - 8</span><br><span class="line">15:17:50.644 [pool-1-thread-6] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample2 - 5</span><br><span class="line">15:17:50.644 [pool-1-thread-5] INFO com.mmall.concurrency.example.aqs.CountDownLatchExample2 - 4</span><br></pre></td></tr></table></figure></p>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/64.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/64.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h4 id="使用场景-1"><a href="#使用场景-1" class="headerlink" title="使用场景:"></a>使用场景:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">仅能提供有限的访问资源，比如：我们项目中的数据库，数据库的最大连接数只有20，而我们的上层应用的并发数会远远大于20，如果同时对数据库进行操作，</span><br><span class="line">就可能会出现因为无法获取数据库连接数导致异常，这时候就可以通过信号量来做并发访问控制，当信号量semaphore把并发数控制到1时，就跟单线程运行很相似，</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.CountDownLatch;</span><br><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line">import java.util.concurrent.Semaphore;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">public class SemaphoreExample1 &#123;</span><br><span class="line"></span><br><span class="line">    private final static int threadCount = 10;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        ExecutorService exec = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">        final Semaphore semaphore = new Semaphore(3);</span><br><span class="line"></span><br><span class="line">        for (int i = 0; i &lt; threadCount; i++) &#123;</span><br><span class="line">            final int threadNum = i;</span><br><span class="line">            exec.execute(() -&gt; &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    semaphore.acquire(); // 获取一个许可</span><br><span class="line">                    test(threadNum);</span><br><span class="line">                    semaphore.release(); // 释放一个许可</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    log.error(&quot;exception&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        exec.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void test(int threadNum) throws Exception &#123;</span><br><span class="line">        log.info(&quot;&#123;&#125;&quot;, threadNum);</span><br><span class="line">        Thread.sleep(1000);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果: 大概每隔1s打印3行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">12:14:18.188 [pool-1-thread-2] INFO com.mmall.concurrency.example.aqs.SemaphoreExample1 - 1</span><br><span class="line">12:14:18.188 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.SemaphoreExample1 - 0</span><br><span class="line">12:14:18.188 [pool-1-thread-3] INFO com.mmall.concurrency.example.aqs.SemaphoreExample1 - 2</span><br><span class="line">12:14:19.194 [pool-1-thread-4] INFO com.mmall.concurrency.example.aqs.SemaphoreExample1 - 3</span><br><span class="line">12:14:19.194 [pool-1-thread-5] INFO com.mmall.concurrency.example.aqs.SemaphoreExample1 - 4</span><br><span class="line">12:14:19.194 [pool-1-thread-6] INFO com.mmall.concurrency.example.aqs.SemaphoreExample1 - 5</span><br><span class="line">12:14:20.195 [pool-1-thread-8] INFO com.mmall.concurrency.example.aqs.SemaphoreExample1 - 7</span><br><span class="line">12:14:20.195 [pool-1-thread-9] INFO com.mmall.concurrency.example.aqs.SemaphoreExample1 - 8</span><br><span class="line">12:14:20.195 [pool-1-thread-7] INFO com.mmall.concurrency.example.aqs.SemaphoreExample1 - 6</span><br><span class="line">12:14:21.196 [pool-1-thread-10] INFO com.mmall.concurrency.example.aqs.SemaphoreExample1 - 9</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line">import java.util.concurrent.Semaphore;</span><br><span class="line"></span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">public class SemaphoreExample2 &#123;</span><br><span class="line"></span><br><span class="line">    private final static int threadCount = 10;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        ExecutorService exec = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">        final Semaphore semaphore = new Semaphore(3);</span><br><span class="line"></span><br><span class="line">        for (int i = 0; i &lt; threadCount; i++) &#123;</span><br><span class="line">            final int threadNum = i;</span><br><span class="line">            exec.execute(() -&gt; &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    semaphore.acquire(3); // 获取多个许可</span><br><span class="line">                    test(threadNum);</span><br><span class="line">                    semaphore.release(3); // 释放多个许可</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    log.error(&quot;exception&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        exec.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void test(int threadNum) throws Exception &#123;</span><br><span class="line">        log.info(&quot;&#123;&#125;&quot;, threadNum);</span><br><span class="line">        Thread.sleep(1000);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果: 大概每隔1s打印1行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">12:17:05.304 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - 0</span><br><span class="line">12:17:06.310 [pool-1-thread-2] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - 1</span><br><span class="line">12:17:07.310 [pool-1-thread-3] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - 2</span><br><span class="line">12:17:08.310 [pool-1-thread-4] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - 3</span><br><span class="line">12:17:09.311 [pool-1-thread-5] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - 4</span><br><span class="line">12:17:10.312 [pool-1-thread-6] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - 5</span><br><span class="line">12:17:11.312 [pool-1-thread-7] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - 6</span><br><span class="line">12:17:12.313 [pool-1-thread-8] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - 7</span><br><span class="line">12:17:13.314 [pool-1-thread-9] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - 8</span><br><span class="line">12:17:14.314 [pool-1-thread-10] INFO com.mmall.concurrency.example.aqs.SemaphoreExample2 - 9</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line">import java.util.concurrent.Semaphore;</span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">public class SemaphoreExample3 &#123;</span><br><span class="line"></span><br><span class="line">    private final static int threadCount = 20;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        ExecutorService exec = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">        final Semaphore semaphore = new Semaphore(3);</span><br><span class="line"></span><br><span class="line">        for (int i = 0; i &lt; threadCount; i++) &#123;</span><br><span class="line">            final int threadNum = i;</span><br><span class="line">            exec.execute(() -&gt; &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    if (semaphore.tryAcquire()) &#123; // 尝试获取一个许可</span><br><span class="line">                        test(threadNum);</span><br><span class="line">                        semaphore.release(); // 释放一个许可</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    log.error(&quot;exception&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        exec.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void test(int threadNum) throws Exception &#123;</span><br><span class="line">        log.info(&quot;&#123;&#125;&quot;, threadNum);</span><br><span class="line">        Thread.sleep(1000);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">12:19:05.556 [pool-1-thread-3] INFO com.mmall.concurrency.example.aqs.SemaphoreExample3 - 2</span><br><span class="line">12:19:05.556 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.SemaphoreExample3 - 0</span><br><span class="line">12:19:05.556 [pool-1-thread-2] INFO com.mmall.concurrency.example.aqs.SemaphoreExample3 - 1</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line">import java.util.concurrent.Semaphore;</span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">public class SemaphoreExample4 &#123;</span><br><span class="line"></span><br><span class="line">    private final static int threadCount = 10;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        ExecutorService exec = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">        final Semaphore semaphore = new Semaphore(3);</span><br><span class="line"></span><br><span class="line">        for (int i = 0; i &lt; threadCount; i++) &#123;</span><br><span class="line">            final int threadNum = i;</span><br><span class="line">            exec.execute(() -&gt; &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    if (semaphore.tryAcquire(5000, TimeUnit.MILLISECONDS)) &#123; // 尝试获取一个许可</span><br><span class="line">                        test(threadNum);</span><br><span class="line">                        semaphore.release(); // 释放一个许可</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    log.error(&quot;exception&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        exec.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void test(int threadNum) throws Exception &#123;</span><br><span class="line">        log.info(&quot;&#123;&#125;&quot;, threadNum);</span><br><span class="line">        Thread.sleep(1000);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果: 大概每隔1s打印3行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">12:22:58.289 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 0</span><br><span class="line">12:22:58.289 [pool-1-thread-3] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 2</span><br><span class="line">12:22:58.289 [pool-1-thread-2] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 1</span><br><span class="line">12:22:59.294 [pool-1-thread-6] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 5</span><br><span class="line">12:22:59.294 [pool-1-thread-5] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 4</span><br><span class="line">12:22:59.294 [pool-1-thread-4] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 3</span><br><span class="line">12:23:00.294 [pool-1-thread-8] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 7</span><br><span class="line">12:23:00.294 [pool-1-thread-7] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 6</span><br><span class="line">12:23:00.294 [pool-1-thread-9] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 8</span><br><span class="line">12:23:01.294 [pool-1-thread-11] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 10</span><br><span class="line">12:23:01.294 [pool-1-thread-10] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 9</span><br><span class="line">12:23:01.294 [pool-1-thread-12] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 11</span><br><span class="line">12:23:02.295 [pool-1-thread-15] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 14</span><br><span class="line">12:23:02.295 [pool-1-thread-13] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 12</span><br><span class="line">12:23:02.295 [pool-1-thread-14] INFO com.mmall.concurrency.example.aqs.SemaphoreExample4 - 13</span><br></pre></td></tr></table></figure></p>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/65.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/65.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.CyclicBarrier;</span><br><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">public class CyclicBarrierExample1 &#123;</span><br><span class="line"></span><br><span class="line">    private static CyclicBarrier barrier = new CyclicBarrier(5);</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        ExecutorService executor = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">        for (int i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">            final int threadNum = i;</span><br><span class="line">            Thread.sleep(1000);</span><br><span class="line">            executor.execute(() -&gt; &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    race(threadNum);</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    log.error(&quot;exception&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        executor.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void race(int threadNum) throws Exception &#123;</span><br><span class="line">        Thread.sleep(1000);</span><br><span class="line">        log.info(&quot;&#123;&#125; is ready&quot;, threadNum);</span><br><span class="line">        barrier.await();</span><br><span class="line"></span><br><span class="line">/*        try &#123;</span><br><span class="line">            barrier.await(2000, TimeUnit.MILLISECONDS);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.warn(&quot;BarrierException&quot;, e);</span><br><span class="line">        &#125;*/</span><br><span class="line"></span><br><span class="line">        log.info(&quot;&#123;&#125; continue&quot;, threadNum);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">23:57:27.925 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 0 is ready</span><br><span class="line">23:57:28.916 [pool-1-thread-2] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 1 is ready</span><br><span class="line">23:57:29.917 [pool-1-thread-3] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 2 is ready</span><br><span class="line">23:57:30.917 [pool-1-thread-4] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 3 is ready</span><br><span class="line">23:57:31.918 [pool-1-thread-5] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 4 is ready</span><br><span class="line">23:57:31.918 [pool-1-thread-5] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 4 continue</span><br><span class="line">23:57:31.918 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 0 continue</span><br><span class="line">23:57:31.918 [pool-1-thread-2] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 1 continue</span><br><span class="line">23:57:31.918 [pool-1-thread-3] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 2 continue</span><br><span class="line">23:57:31.918 [pool-1-thread-4] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 3 continue</span><br><span class="line">23:57:32.919 [pool-1-thread-6] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 5 is ready</span><br><span class="line">23:57:33.918 [pool-1-thread-4] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 6 is ready</span><br><span class="line">23:57:34.919 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 7 is ready</span><br><span class="line">23:57:35.919 [pool-1-thread-2] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 8 is ready</span><br><span class="line">23:57:36.920 [pool-1-thread-3] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 9 is ready</span><br><span class="line">23:57:36.920 [pool-1-thread-3] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 9 continue</span><br><span class="line">23:57:36.920 [pool-1-thread-6] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 5 continue</span><br><span class="line">23:57:36.920 [pool-1-thread-4] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 6 continue</span><br><span class="line">23:57:36.920 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 7 continue</span><br><span class="line">23:57:36.920 [pool-1-thread-2] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample1 - 8 continue</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.CyclicBarrier;</span><br><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">public class CyclicBarrierExample3 &#123;</span><br><span class="line"></span><br><span class="line">    private static CyclicBarrier barrier = new CyclicBarrier(5, () -&gt; &#123;</span><br><span class="line">        log.info(&quot;callback is running&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        ExecutorService executor = Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">        for (int i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">            final int threadNum = i;</span><br><span class="line">            Thread.sleep(1000);</span><br><span class="line">            executor.execute(() -&gt; &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    race(threadNum);</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    log.error(&quot;exception&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        executor.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void race(int threadNum) throws Exception &#123;</span><br><span class="line">        Thread.sleep(1000);</span><br><span class="line">        log.info(&quot;&#123;&#125; is ready&quot;, threadNum);</span><br><span class="line">        barrier.await();</span><br><span class="line">        log.info(&quot;&#123;&#125; continue&quot;, threadNum);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">00:00:48.622 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 0 is ready</span><br><span class="line">00:00:49.618 [pool-1-thread-2] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 1 is ready</span><br><span class="line">00:00:50.618 [pool-1-thread-3] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 2 is ready</span><br><span class="line">00:00:51.618 [pool-1-thread-4] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 3 is ready</span><br><span class="line">00:00:52.617 [pool-1-thread-5] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 4 is ready</span><br><span class="line">00:00:52.617 [pool-1-thread-5] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - callback is running</span><br><span class="line">00:00:52.617 [pool-1-thread-5] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 4 continue</span><br><span class="line">00:00:52.618 [pool-1-thread-2] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 1 continue</span><br><span class="line">00:00:52.618 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 0 continue</span><br><span class="line">00:00:52.618 [pool-1-thread-3] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 2 continue</span><br><span class="line">00:00:52.618 [pool-1-thread-4] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 3 continue</span><br><span class="line">00:00:53.619 [pool-1-thread-6] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 5 is ready</span><br><span class="line">00:00:54.618 [pool-1-thread-4] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 6 is ready</span><br><span class="line">00:00:55.619 [pool-1-thread-3] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 7 is ready</span><br><span class="line">00:00:56.619 [pool-1-thread-2] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 8 is ready</span><br><span class="line">00:00:57.620 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 9 is ready</span><br><span class="line">00:00:57.620 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - callback is running</span><br><span class="line">00:00:57.620 [pool-1-thread-1] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 9 continue</span><br><span class="line">00:00:57.620 [pool-1-thread-6] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 5 continue</span><br><span class="line">00:00:57.620 [pool-1-thread-4] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 6 continue</span><br><span class="line">00:00:57.620 [pool-1-thread-3] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 7 continue</span><br><span class="line">00:00:57.620 [pool-1-thread-2] INFO com.mmall.concurrency.example.aqs.CyclicBarrierExample3 - 8 continue</span><br></pre></td></tr></table></figure>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/66.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/66.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/67.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/67.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<p>synchronized:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.CountDownLatch;</span><br><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line">import java.util.concurrent.Semaphore;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@ThreadSafe</span><br><span class="line">public class LockExample1 &#123;</span><br><span class="line">    // 请求总数</span><br><span class="line">    public static int clientTotal = 5000;</span><br><span class="line"></span><br><span class="line">    // 同时并发执行的线程数</span><br><span class="line">    public static int threadTotal = 200;</span><br><span class="line"></span><br><span class="line">    public static int count = 0;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        final Semaphore semaphore = new Semaphore(threadTotal);</span><br><span class="line">        final CountDownLatch countDownLatch = new CountDownLatch(clientTotal);</span><br><span class="line">        for (int i = 0; i &lt; clientTotal ; i++) &#123;</span><br><span class="line">            executorService.execute(() -&gt; &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    add();</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    log.error(&quot;exception&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(&quot;count:&#123;&#125;&quot;, count);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private synchronized static void add() &#123;</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ReentrantLock:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.CountDownLatch;</span><br><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line">import java.util.concurrent.Semaphore;</span><br><span class="line">import java.util.concurrent.locks.Lock;</span><br><span class="line">import java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@ThreadSafe</span><br><span class="line">public class LockExample2 &#123;</span><br><span class="line"></span><br><span class="line">    // 请求总数</span><br><span class="line">    public static int clientTotal = 5000;</span><br><span class="line"></span><br><span class="line">    // 同时并发执行的线程数</span><br><span class="line">    public static int threadTotal = 200;</span><br><span class="line"></span><br><span class="line">    public static int count = 0;</span><br><span class="line"></span><br><span class="line">    private final static Lock lock = new ReentrantLock();</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        final Semaphore semaphore = new Semaphore(threadTotal);</span><br><span class="line">        final CountDownLatch countDownLatch = new CountDownLatch(clientTotal);</span><br><span class="line">        for (int i = 0; i &lt; clientTotal ; i++) &#123;</span><br><span class="line">            executorService.execute(() -&gt; &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    add();</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    log.error(&quot;exception&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(&quot;count:&#123;&#125;&quot;, count);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void add() &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        try &#123;</span><br><span class="line">            count++;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ReentrantReadWriteLock:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.Set;</span><br><span class="line">import java.util.TreeMap;</span><br><span class="line">import java.util.concurrent.locks.Lock;</span><br><span class="line">import java.util.concurrent.locks.ReentrantReadWriteLock;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">public class LockExample3 &#123;</span><br><span class="line"></span><br><span class="line">    private final Map&lt;String, Data&gt; map = new TreeMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    private final ReentrantReadWriteLock lock = new ReentrantReadWriteLock();</span><br><span class="line"></span><br><span class="line">    private final Lock readLock = lock.readLock();</span><br><span class="line"></span><br><span class="line">    private final Lock writeLock = lock.writeLock();</span><br><span class="line"></span><br><span class="line">    public Data get(String key) &#123;</span><br><span class="line">        readLock.lock();</span><br><span class="line">        try &#123;</span><br><span class="line">            return map.get(key);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            readLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Set&lt;String&gt; getAllKeys() &#123;</span><br><span class="line">        readLock.lock();</span><br><span class="line">        try &#123;</span><br><span class="line">            return map.keySet();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            readLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Data put(String key, Data value) &#123;</span><br><span class="line">        writeLock.lock();</span><br><span class="line">        try &#123;</span><br><span class="line">            return map.put(key, value);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            readLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    class Data &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>StampedLock:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">import java.util.concurrent.locks.StampedLock;</span><br><span class="line"></span><br><span class="line">public class LockExample4 &#123;</span><br><span class="line"></span><br><span class="line">    class Point &#123;</span><br><span class="line">        private double x, y;</span><br><span class="line">        private final StampedLock sl = new StampedLock();</span><br><span class="line"></span><br><span class="line">        void move(double deltaX, double deltaY) &#123; // an exclusively locked method</span><br><span class="line">            long stamp = sl.writeLock();</span><br><span class="line">            try &#123;</span><br><span class="line">                x += deltaX;</span><br><span class="line">                y += deltaY;</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                sl.unlockWrite(stamp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //下面看看乐观读锁案例</span><br><span class="line">        double distanceFromOrigin() &#123; // A read-only method</span><br><span class="line">            long stamp = sl.tryOptimisticRead(); //获得一个乐观读锁</span><br><span class="line">            double currentX = x, currentY = y;  //将两个字段读入本地局部变量</span><br><span class="line">            if (!sl.validate(stamp)) &#123; //检查发出乐观读锁后同时是否有其他写锁发生？</span><br><span class="line">                stamp = sl.readLock();  //如果没有，我们再次获得一个读悲观锁</span><br><span class="line">                try &#123;</span><br><span class="line">                    currentX = x; // 将两个字段读入本地局部变量</span><br><span class="line">                    currentY = y; // 将两个字段读入本地局部变量</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    sl.unlockRead(stamp);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return Math.sqrt(currentX * currentX + currentY * currentY);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //下面是悲观读锁案例</span><br><span class="line">        void moveIfAtOrigin(double newX, double newY) &#123; // upgrade</span><br><span class="line">            // Could instead start with optimistic, not read mode</span><br><span class="line">            long stamp = sl.readLock();</span><br><span class="line">            try &#123;</span><br><span class="line">                while (x == 0.0 &amp;&amp; y == 0.0) &#123; //循环，检查当前状态是否符合</span><br><span class="line">                    long ws = sl.tryConvertToWriteLock(stamp); //将读锁转为写锁</span><br><span class="line">                    if (ws != 0L) &#123; //这是确认转为写锁是否成功</span><br><span class="line">                        stamp = ws; //如果成功 替换票据</span><br><span class="line">                        x = newX; //进行状态改变</span><br><span class="line">                        y = newY;  //进行状态改变</span><br><span class="line">                        break;</span><br><span class="line">                    &#125; else &#123; //如果不能成功转换为写锁</span><br><span class="line">                        sl.unlockRead(stamp);  //我们显式释放读锁</span><br><span class="line">                        stamp = sl.writeLock();  //显式直接进行写锁 然后再通过循环再试</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                sl.unlock(stamp); //释放读锁或写锁</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.CountDownLatch;</span><br><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line">import java.util.concurrent.Semaphore;</span><br><span class="line">import java.util.concurrent.locks.StampedLock;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@ThreadSafe</span><br><span class="line">public class LockExample5 &#123;</span><br><span class="line"></span><br><span class="line">    // 请求总数</span><br><span class="line">    public static int clientTotal = 5000;</span><br><span class="line"></span><br><span class="line">    // 同时并发执行的线程数</span><br><span class="line">    public static int threadTotal = 200;</span><br><span class="line"></span><br><span class="line">    public static int count = 0;</span><br><span class="line"></span><br><span class="line">    private final static StampedLock lock = new StampedLock();</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        final Semaphore semaphore = new Semaphore(threadTotal);</span><br><span class="line">        final CountDownLatch countDownLatch = new CountDownLatch(clientTotal);</span><br><span class="line">        for (int i = 0; i &lt; clientTotal ; i++) &#123;</span><br><span class="line">            executorService.execute(() -&gt; &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    add();</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    log.error(&quot;exception&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        log.info(&quot;count:&#123;&#125;&quot;, count);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void add() &#123;</span><br><span class="line">        long stamp = lock.writeLock();</span><br><span class="line">        try &#123;</span><br><span class="line">            count++;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            lock.unlock(stamp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Condition:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.locks.Condition;</span><br><span class="line">import java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">public class LockExample6 &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        ReentrantLock reentrantLock = new ReentrantLock();</span><br><span class="line">        Condition condition = reentrantLock.newCondition();</span><br><span class="line"></span><br><span class="line">        new Thread(() -&gt; &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                reentrantLock.lock();</span><br><span class="line">                log.info(&quot;wait signal&quot;); // 1</span><br><span class="line">                condition.await();</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            log.info(&quot;get signal&quot;); // 4</span><br><span class="line">            reentrantLock.unlock();</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        new Thread(() -&gt; &#123;</span><br><span class="line">            reentrantLock.lock();</span><br><span class="line">            log.info(&quot;get lock&quot;); // 2</span><br><span class="line">            try &#123;</span><br><span class="line">                Thread.sleep(3000);</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            condition.signalAll();</span><br><span class="line">            log.info(&quot;send signal ~ &quot;); // 3</span><br><span class="line">            reentrantLock.unlock();</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Future:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.Callable;</span><br><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line">import java.util.concurrent.Future;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">public class FutureExample &#123;</span><br><span class="line"></span><br><span class="line">    static class MyCallable implements Callable&lt;String&gt; &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public String call() throws Exception &#123;</span><br><span class="line">            log.info(&quot;do something in callable&quot;);</span><br><span class="line">            Thread.sleep(5000);</span><br><span class="line">            return &quot;Done&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        Future&lt;String&gt; future = executorService.submit(new MyCallable());</span><br><span class="line">        log.info(&quot;do something in main&quot;);</span><br><span class="line">        Thread.sleep(1000);</span><br><span class="line">        String result = future.get();</span><br><span class="line">        log.info(&quot;result：&#123;&#125;&quot;, result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>FutureTask:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.Callable;</span><br><span class="line">import java.util.concurrent.FutureTask;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">public class FutureTaskExample &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        FutureTask&lt;String&gt; futureTask = new FutureTask&lt;String&gt;(new Callable&lt;String&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public String call() throws Exception &#123;</span><br><span class="line">                log.info(&quot;do something in callable&quot;);</span><br><span class="line">                Thread.sleep(5000);</span><br><span class="line">                return &quot;Done&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        new Thread(futureTask).start();</span><br><span class="line">        log.info(&quot;do something in main&quot;);</span><br><span class="line">        Thread.sleep(1000);</span><br><span class="line">        String result = futureTask.get();</span><br><span class="line">        log.info(&quot;result：&#123;&#125;&quot;, result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>结果:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">09:06:15.160 [main] INFO com.mmall.concurrency.example.aqs.FutureTaskExample - do something in main</span><br><span class="line">09:06:15.160 [Thread-0] INFO com.mmall.concurrency.example.aqs.FutureTaskExample - do something in callable</span><br><span class="line">09:06:20.164 [main] INFO com.mmall.concurrency.example.aqs.FutureTaskExample - result：Done</span><br></pre></td></tr></table></figure></p>
<h3 id="JUC组件拓展"><a href="#JUC组件拓展" class="headerlink" title="JUC组件拓展"></a>JUC组件拓展</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/68.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/68.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.ForkJoinPool;</span><br><span class="line">import java.util.concurrent.Future;</span><br><span class="line">import java.util.concurrent.RecursiveTask;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">public class ForkJoinTaskExample extends RecursiveTask&lt;Integer&gt; &#123;</span><br><span class="line"></span><br><span class="line">    public static final int threshold = 2;</span><br><span class="line">    private int start;</span><br><span class="line">    private int end;</span><br><span class="line"></span><br><span class="line">    public ForkJoinTaskExample(int start, int end) &#123;</span><br><span class="line">        this.start = start;</span><br><span class="line">        this.end = end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected Integer compute() &#123;</span><br><span class="line">        int sum = 0;</span><br><span class="line"></span><br><span class="line">        //如果任务足够小就计算任务</span><br><span class="line">        boolean canCompute = (end - start) &lt;= threshold;</span><br><span class="line">        if (canCompute) &#123;</span><br><span class="line">            for (int i = start; i &lt;= end; i++) &#123;</span><br><span class="line">                sum += i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // 如果任务大于阈值，就分裂成两个子任务计算</span><br><span class="line">            int middle = (start + end) / 2;</span><br><span class="line">            ForkJoinTaskExample leftTask = new ForkJoinTaskExample(start, middle);</span><br><span class="line">            ForkJoinTaskExample rightTask = new ForkJoinTaskExample(middle + 1, end);</span><br><span class="line"></span><br><span class="line">            // 执行子任务</span><br><span class="line">            leftTask.fork();</span><br><span class="line">            rightTask.fork();</span><br><span class="line"></span><br><span class="line">            // 等待任务执行结束合并其结果</span><br><span class="line">            int leftResult = leftTask.join();</span><br><span class="line">            int rightResult = rightTask.join();</span><br><span class="line"></span><br><span class="line">            // 合并子任务</span><br><span class="line">            sum = leftResult + rightResult;</span><br><span class="line">        &#125;</span><br><span class="line">        return sum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        ForkJoinPool forkjoinPool = new ForkJoinPool();</span><br><span class="line"></span><br><span class="line">        //生成一个计算任务，计算1+2+3+4</span><br><span class="line">        ForkJoinTaskExample task = new ForkJoinTaskExample(1, 100);</span><br><span class="line"></span><br><span class="line">        //执行一个任务</span><br><span class="line">        Future&lt;Integer&gt; result = forkjoinPool.submit(task);</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            log.info(&quot;result:&#123;&#125;&quot;, result.get());</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;exception&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/69.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/69.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/70.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/70.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/71.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/71.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/72.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/72.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h3 id="线程调度-线程池"><a href="#线程调度-线程池" class="headerlink" title="线程调度-线程池"></a>线程调度-线程池</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/73.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/73.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/74.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/74.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/75.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/75.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">运行的线程数量  &lt;  corePoolSize                        直接创建新线程来处理任务即使线程池中的其他线程是空闲的</span><br><span class="line">corePoolSize  &lt;=  线程池的线程数量  &lt; maximumPoolSize  只有当workQueue满时才会创建新的线程处理任务</span><br><span class="line">corePoolSize   =  maximumPoolSize                     创建的线程池大小是固定的，这时如果有新任务提交，workQueue没满时，把请求放到workQueue里面，等待有空闲等待线程从里面取出任务进行处理</span><br><span class="line">运行的线程数量  &gt;  maximumPoolSize                     如果workQueue满了，通过指定策略来处理这个任务</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">提交一个新的任务到线程池以后，线程池会根据当前线程池中运行的线程数量来决定该任务的处理方式</span><br><span class="line">1.直接切换       SynchronousQueue</span><br><span class="line">2.使用无界队列   LnkedBlockingQueue 能创建的最大线程数就是corePoolSize</span><br><span class="line">3.使用有界队列   ArrayBlockQueue    将线程的最大线程数量设置为maximumPoolSize ，降低资源的消耗</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">降低系统资源的消耗（cpu使用率，操作系统资源的消耗）可以设置一个较大的队列容量，较小的线程池容量，降低线程处理任务的吞吐量</span><br><span class="line">提交的任务经常发生阻塞，调用设置线程最大线程数方法重新设置线程的容量，如果队列容量设置较小通常需要把线程池容量设置大一点，CPU的使用率会相对高一些</span><br></pre></td></tr></table></figure>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/76.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/76.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AbortPolicy：直接抛出异常</span><br><span class="line">CallerRunsPolicy：用调用者使用的线程来执行任务</span><br><span class="line">DiscardOldestPolicy：丢弃掉阻塞队列中最靠前的任务，并执行当前任务</span><br><span class="line">DiscardPolicy：直接丢弃当前任务</span><br></pre></td></tr></table></figure>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/77.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/77.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/78.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/78.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/79.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/79.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/80.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/80.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/81.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/81.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">public class ThreadPoolExample1 &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line"></span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        // ExecutorService executorService = Executors.newFixedThreadPool(3);</span><br><span class="line">        // ExecutorService executorService = Executors.newSingleThreadExecutor();</span><br><span class="line"></span><br><span class="line">        for (int i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">            final int index = i;</span><br><span class="line">            executorService.execute(new Runnable() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void run() &#123;</span><br><span class="line">                    log.info(&quot;task:&#123;&#125;&quot;, index);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">import java.util.Date;</span><br><span class="line">import java.util.Timer;</span><br><span class="line">import java.util.TimerTask;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line">import java.util.concurrent.ScheduledExecutorService;</span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">public class ThreadPoolExample4 &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        ScheduledExecutorService executorService = Executors.newScheduledThreadPool(1);</span><br><span class="line"></span><br><span class="line">//        executorService.schedule(new Runnable() &#123;</span><br><span class="line">//            @Override</span><br><span class="line">//            public void run() &#123;</span><br><span class="line">//                log.warn(&quot;schedule run&quot;);</span><br><span class="line">//            &#125;</span><br><span class="line">//        &#125;, 3, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">        executorService.scheduleAtFixedRate(new Runnable() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                log.warn(&quot;schedule run&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, 1, 3, TimeUnit.SECONDS);</span><br><span class="line">//        executorService.shutdown();</span><br><span class="line"></span><br><span class="line">        Timer timer = new Timer();</span><br><span class="line">        timer.schedule(new TimerTask() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                log.warn(&quot;timer run&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, new Date(), 5 * 1000);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/82.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/82.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h3 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/83.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/83.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">避免死锁</span><br><span class="line">1.按顺序加锁</span><br><span class="line">2.加锁时间（超过一定时间就放弃该锁的请求，并释放自己占有的锁）</span><br><span class="line">3.死锁检测（以上两种方式都无法解决）</span><br><span class="line"></span><br><span class="line">每当一个线程获取了锁，会在线程和锁的相关数据结构中记下来，除此之外，每当有线程请求锁，也需要记录在这个数据结构中，</span><br><span class="line">当一个线程请求锁失败的时候，这个线程可以遍历锁的关系图，看是否有死锁发生，并决定后续操作该怎么办，具体这个结构需要大家根据实际情况去设计一下，</span><br><span class="line">那么，当检测出死锁的时候，线程都可以做哪些是事情呢，一个可执行的做法是释放所有锁，回退，并且等待一定时间（随机）后，之后进行重试，</span><br><span class="line">这个和简单的加锁超时有些类似，不一样的是，只有死锁发生了才回退而不会因为加锁请求超时了，虽然有了回退和等待，但是，</span><br><span class="line">如果有大量线程又同时竞争同一批锁，他们还是有可能出现重复死锁，这时候有个更好的方案，给这些线程设置优先级，</span><br><span class="line">让一个或几个线程回退，剩下的线程就像reantran锁一样，继续保持他们，如果赋予这些线程的优先级是固定不变的，可以在死锁发生的时候设置随机的线程优先级</span><br></pre></td></tr></table></figure>
<h3 id="并发最佳实践"><a href="#并发最佳实践" class="headerlink" title="并发最佳实践"></a>并发最佳实践</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/84.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/84.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/85.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/85.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/86.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/86.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h3 id="spring与线程安全"><a href="#spring与线程安全" class="headerlink" title="spring与线程安全"></a>spring与线程安全</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/87.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/87.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h3 id="HashMap与ConcurrentHashMap解析"><a href="#HashMap与ConcurrentHashMap解析" class="headerlink" title="HashMap与ConcurrentHashMap解析"></a>HashMap与ConcurrentHashMap解析</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/88.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/88.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/89.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/89.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/90.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/90.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/91.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/91.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/92.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/92.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/93.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/93.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/94.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/94.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/并发编程与高并发解决方案/95.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/并发编程与高并发解决方案/95.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>

            

        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">标签</span><br>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/并发编程与高并发解决方案/">并发编程与高并发解决方案</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2019/08/25/高并发解决方案/" data-tooltip="高并发解决方案" aria-label="上一篇: 高并发解决方案">
                
                    <i class="fa fa-angle-left" aria-hidden="true"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                </a>
            </li>
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2019/07/10/docker安装Oracle 12c/" data-tooltip="docker安装Oracle 12c" aria-label="下一篇: docker安装Oracle 12c">
                
                    <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                    <i class="fa fa-angle-right" aria-hidden="true"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com/2019/08/25/并发编程与高并发解决方案/" title="分享到 Facebook">
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://yoursite.com/2019/08/25/并发编程与高并发解决方案/" title="分享到 Twitter">
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://yoursite.com/2019/08/25/并发编程与高并发解决方案/" title="分享到 Google+">
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2019 Brotherc. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2019/08/25/高并发解决方案/" data-tooltip="高并发解决方案" aria-label="上一篇: 高并发解决方案">
                
                    <i class="fa fa-angle-left" aria-hidden="true"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                </a>
            </li>
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2019/07/10/docker安装Oracle 12c/" data-tooltip="docker安装Oracle 12c" aria-label="下一篇: docker安装Oracle 12c">
                
                    <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                    <i class="fa fa-angle-right" aria-hidden="true"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com/2019/08/25/并发编程与高并发解决方案/" title="分享到 Facebook">
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://yoursite.com/2019/08/25/并发编程与高并发解决方案/" title="分享到 Twitter">
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://yoursite.com/2019/08/25/并发编程与高并发解决方案/" title="分享到 Google+">
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="4">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com/2019/08/25/并发编程与高并发解决方案/">
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>分享到 Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=http://yoursite.com/2019/08/25/并发编程与高并发解决方案/">
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>分享到 Twitter</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http://yoursite.com/2019/08/25/并发编程与高并发解决方案/">
                        <i class="fab fa-google-plus" aria-hidden="true"></i><span>分享到 Google+</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/head.jpg" alt="作者的图片">
        
            <h4 id="about-card-name">Brotherc</h4>
        
            <div id="about-card-bio"><p>java development</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br>
                <p>java</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br>
                zhuhai
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-dbd16rvloemmuxdzniplmnxxvwoz24eya9wol0b7vvmlokgqsjivmb8dnscy.min.js"></script>
<!--SCRIPTS END-->

    



    </body>
</html>
