
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Brotherc">
    <title>归档: 2020 - Brotherc</title>
    <meta name="author" content="Brotherc">
    
    
    
    <script type="application/ld+json">{}</script>
    <meta property="og:type" content="blog">
<meta property="og:title" content="Brotherc">
<meta property="og:url" content="http://yoursite.com/archives/2020/page/2/index.html">
<meta property="og:site_name" content="Brotherc">
<meta property="og:locale" content="zh-cn">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Brotherc">
    
    
        
    
    
        <meta property="og:image" content="http://yoursite.com/assets/images/head.jpg"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-c4ozcsklz4kht2pebhp44xorvyverh23toayhn7i6ubrpyedak24hv1v0hyd.min.css">
    <!--STYLES END-->
    

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/ ">Brotherc</a>
    </div>
    
        
            <a class="header-right-picture " href="#about">
        
        
            <img class="header-picture" src="/assets/images/head.jpg" alt="作者的图片">
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="1">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a href="/#about">
                    <img class="sidebar-profile-picture" src="/assets/images/head.jpg" alt="作者的图片">
                </a>
                <h4 class="sidebar-profile-name">Brotherc</h4>
                
                    <h5 class="sidebar-profile-bio"><p>java development</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/ " title="首页">
                    
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首页</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-categories" title="分类">
                    
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">分类</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-tags" title="标签">
                    
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">标签</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link open-algolia-search" href="/all-archives" title="归档">
                    
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">归档</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="#about" title="关于">
                    
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">关于</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://github.com/Brotherc" target="_blank" rel="noopener" title="GitHub">
                    
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="1"
                 class="
                        hasCoverMetaIn
                        ">
                
    <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2020/05/05/logback/">
                            Logback日志配置
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2020-05-05T16:52:54+08:00">
	
		    5月 05, 2020
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/logback/1.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/logback/1.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h3 id="Logback的主要模块"><a href="#Logback的主要模块" class="headerlink" title="Logback的主要模块"></a>Logback的主要模块</h3><h4 id="logback-access"><a href="#logback-access" class="headerlink" title="logback-access"></a>logback-access</h4><p>与server容器集成，提供通过http来访问日志的功能，我们的第三方软件可以通过logback-access来访问到logback里面记录的日志，例如kibanner等都会用到这个模块。</p>
<h4 id="logback-classic"><a href="#logback-classic" class="headerlink" title="logback-classic"></a>logback-classic</h4><p>log4j的改良版本，同时完整的实现了slef4j api，使你可以很方便的更换成其他的日志系统，比如log4j等。</p>
<h4 id="logback-core"><a href="#logback-core" class="headerlink" title="logback-core"></a>logback-core</h4><p>为我们前两个模块提供了基础的服务。</p>
<h3 id="Logback的主要标签"><a href="#Logback的主要标签" class="headerlink" title="Logback的主要标签"></a>Logback的主要标签</h3><h4 id="logger"><a href="#logger" class="headerlink" title="logger"></a>logger</h4><p>作为日志的记录器，主要用于存放日志对象，也可以定义日志的类型还有级别等。</p>
<h4 id="appender"><a href="#appender" class="headerlink" title="appender"></a>appender</h4><p>用于指定日志输出的目的地，可以是控制台、文件、远程套接字服务器等。</p>
<h4 id="layout"><a href="#layout" class="headerlink" title="layout"></a>layout</h4><p>用于格式化日志信息输出的。</p>
<h3 id="Logback的加载顺序"><a href="#Logback的加载顺序" class="headerlink" title="Logback的加载顺序"></a>Logback的加载顺序</h3><p>程序在运行的时候会按照一定的顺序去加载我们logback相关的配置文件</p>
<h4 id="1-如果我们在配置里面指定了logback-configurationFile这个属性那我们将使用这个属性的的地址去寻找相关的配置文件"><a href="#1-如果我们在配置里面指定了logback-configurationFile这个属性那我们将使用这个属性的的地址去寻找相关的配置文件" class="headerlink" title="1.如果我们在配置里面指定了logback.configurationFile这个属性那我们将使用这个属性的的地址去寻找相关的配置文件"></a>1.如果我们在配置里面指定了logback.configurationFile这个属性那我们将使用这个属性的的地址去寻找相关的配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Dlogback.configurationFile=xxxxxx/xxx.xml</span><br></pre></td></tr></table></figure>
<h4 id="2-如果没有配置这个属性他将会加载我们classpath下的logback-groovy文件"><a href="#2-如果没有配置这个属性他将会加载我们classpath下的logback-groovy文件" class="headerlink" title="2.如果没有配置这个属性他将会加载我们classpath下的logback.groovy文件"></a>2.如果没有配置这个属性他将会加载我们classpath下的logback.groovy文件</h4><h4 id="3-如果也找不到这个文件，才会加载同级目录下的logback-test-xml文件"><a href="#3-如果也找不到这个文件，才会加载同级目录下的logback-test-xml文件" class="headerlink" title="3.如果也找不到这个文件，才会加载同级目录下的logback-test.xml文件"></a>3.如果也找不到这个文件，才会加载同级目录下的logback-test.xml文件</h4><h4 id="4-如果也没有，它就会加载logback-xml文件"><a href="#4-如果也没有，它就会加载logback-xml文件" class="headerlink" title="4.如果也没有，它就会加载logback.xml文件"></a>4.如果也没有，它就会加载logback.xml文件</h4><h4 id="5-如果都没找到上述的配置文件，jdk1-6以上就会调用service-provider-loading-facility去查找com-qos-logback-classic-spi-Configurator这个接口的第一个实现类"><a href="#5-如果都没找到上述的配置文件，jdk1-6以上就会调用service-provider-loading-facility去查找com-qos-logback-classic-spi-Configurator这个接口的第一个实现类" class="headerlink" title="5.如果都没找到上述的配置文件，jdk1.6以上就会调用service-provider loading facility去查找com.qos.logback.classic.spi.Configurator这个接口的第一个实现类"></a>5.如果都没找到上述的配置文件，jdk1.6以上就会调用service-provider loading facility去查找com.qos.logback.classic.spi.Configurator这个接口的第一个实现类</h4><h4 id="6-如果上面的都没有，则会使用ch-qos-logback-classic-BasicConfigurator这个实现类，就是直接在控制台输出"><a href="#6-如果上面的都没有，则会使用ch-qos-logback-classic-BasicConfigurator这个实现类，就是直接在控制台输出" class="headerlink" title="6.如果上面的都没有，则会使用ch.qos.logback.classic.BasicConfigurator这个实现类，就是直接在控制台输出"></a>6.如果上面的都没有，则会使用ch.qos.logback.classic.BasicConfigurator这个实现类，就是直接在控制台输出</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; standalone=&quot;no&quot;?&gt;</span><br><span class="line">&lt;!-- scan=&quot;true&quot; 如果配置文件被改变，将会重新去加载 --&gt;</span><br><span class="line">&lt;!-- scanPeriod 设置监测我们的配置文件是否有修改时间的时间间隔，默认单位是毫秒，当scan为true时生效，每分钟扫一下配置文件看有没有发生变化如果有变化就会重新去加载配置，这样就不需要重启服务器 --&gt;</span><br><span class="line">&lt;!-- debug 打印出logback的内部信息 实时查看logback的运行状态 --&gt;</span><br><span class="line">&lt;configuration scan=&quot;true&quot; scanPeriod=&quot;60 seconds&quot; debug=&quot;false&quot;&gt;</span><br><span class="line">	&lt;!-- 定义参数常量 --&gt;</span><br><span class="line">	&lt;!-- TRACE&lt;DEBUG&lt;INFO&lt;WARN&lt;ERROR &gt;以上的级别才会显示--&gt;</span><br><span class="line">	&lt;property name=&quot;log.level&quot; value=&quot;debug&quot; /&gt;</span><br><span class="line">	&lt;!-- 文件保留的时长 --&gt;</span><br><span class="line">	&lt;property name=&quot;log.maxHistory&quot; value=&quot;30&quot; /&gt;</span><br><span class="line">	&lt;!-- 日志存储的根路径 --&gt;</span><br><span class="line">	&lt;property name=&quot;log.filePath&quot; value=&quot;$&#123;catalina.base&#125;/logs/webapps&quot; /&gt;</span><br><span class="line">	&lt;!-- 日志展示的格式 --&gt;</span><br><span class="line">	&lt;property name=&quot;log.pattern&quot; value=&quot;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; -</span><br><span class="line">		%msg%n&quot; /&gt;</span><br><span class="line">	&lt;!-- 控制台设置 --&gt;</span><br><span class="line">	&lt;appender name=&quot;consoleAppender&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;</span><br><span class="line">		&lt;!-- 将一个event事件转化为一组byte数组，还会将转化后的数据输出到文件中 --&gt;</span><br><span class="line">		&lt;encoder&gt;</span><br><span class="line">			&lt;pattern&gt;$&#123;log.pattern&#125;&lt;/pattern&gt;</span><br><span class="line">		&lt;/encoder&gt;</span><br><span class="line">	&lt;/appender&gt;</span><br><span class="line">	&lt;!-- DEBUG --&gt;</span><br><span class="line">	&lt;!-- 随着大小或时间滚动日志 --&gt;</span><br><span class="line">	&lt;appender name=&quot;debugAppender&quot; class=&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">		&lt;!-- 文件路径 --&gt;</span><br><span class="line">		&lt;file&gt;$&#123;log.filePath&#125;/debug.log&lt;/file&gt;</span><br><span class="line">		&lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">			&lt;!-- 文件名称 --&gt;</span><br><span class="line">			&lt;fileNamePattern&gt;$&#123;log.filePath&#125;/debug/debug.%d&#123;yyyy-MM-dd&#125;.%i.log.gz&lt;/fileNamePattern&gt;</span><br><span class="line">			&lt;!-- 文件最大保存历史数量 --&gt;</span><br><span class="line">			&lt;maxHistory&gt;$&#123;log.maxHistory&#125;&lt;/maxHistory&gt;</span><br><span class="line">		&lt;/rollingPolicy&gt;</span><br><span class="line">		&lt;encoder&gt;</span><br><span class="line">			&lt;pattern&gt;$&#123;log.pattern&#125;&lt;/pattern&gt;</span><br><span class="line">		&lt;/encoder&gt;</span><br><span class="line">		&lt;filter class=&quot;ch.qos.logback.classic.filter.LevelFilter&quot;&gt;</span><br><span class="line">			&lt;level&gt;DEBUG&lt;/level&gt;</span><br><span class="line">			&lt;onMatch&gt;ACCEPT&lt;/onMatch&gt;</span><br><span class="line">			&lt;onMismatch&gt;DENY&lt;/onMismatch&gt;</span><br><span class="line">		&lt;/filter&gt;</span><br><span class="line">	&lt;/appender&gt;</span><br><span class="line">	&lt;!-- INFO --&gt;</span><br><span class="line">	&lt;appender name=&quot;infoAppender&quot; class=&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">		&lt;!-- 文件路径 --&gt;</span><br><span class="line">		&lt;file&gt;$&#123;log.filePath&#125;/info.log&lt;/file&gt;</span><br><span class="line">		&lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">			&lt;!-- 文件名称 --&gt;</span><br><span class="line">			&lt;fileNamePattern&gt;$&#123;log.filePath&#125;/info/info.%d&#123;yyyy-MM-dd&#125;.%i.log.gz&lt;/fileNamePattern&gt;</span><br><span class="line">			&lt;!-- 文件最大保存历史数量 --&gt;</span><br><span class="line">			&lt;maxHistory&gt;$&#123;log.maxHistory&#125;&lt;/maxHistory&gt;</span><br><span class="line">		&lt;/rollingPolicy&gt;</span><br><span class="line">		&lt;encoder&gt;</span><br><span class="line">			&lt;pattern&gt;$&#123;log.pattern&#125;&lt;/pattern&gt;</span><br><span class="line">		&lt;/encoder&gt;</span><br><span class="line">		&lt;filter class=&quot;ch.qos.logback.classic.filter.LevelFilter&quot;&gt;</span><br><span class="line">			&lt;level&gt;INFO&lt;/level&gt;</span><br><span class="line">			&lt;onMatch&gt;ACCEPT&lt;/onMatch&gt;</span><br><span class="line">			&lt;onMismatch&gt;DENY&lt;/onMismatch&gt;</span><br><span class="line">		&lt;/filter&gt;</span><br><span class="line">	&lt;/appender&gt;</span><br><span class="line">	&lt;!-- ERROR --&gt;</span><br><span class="line">	&lt;appender name=&quot;errorAppender&quot; class=&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">		&lt;!-- 文件路径 --&gt;</span><br><span class="line">		&lt;file&gt;$&#123;log.filePath&#125;/error.log&lt;/file&gt;</span><br><span class="line">		&lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">			&lt;!-- 文件名称 --&gt;</span><br><span class="line">			&lt;fileNamePattern&gt;$&#123;log.filePath&#125;/error/error.%d&#123;yyyy-MM-dd&#125;.%i.log.gz&lt;/fileNamePattern&gt;</span><br><span class="line">			&lt;!-- 文件最大保存历史数量 --&gt;</span><br><span class="line">			&lt;maxHistory&gt;$&#123;log.maxHistory&#125;&lt;/maxHistory&gt;</span><br><span class="line">		&lt;/rollingPolicy&gt;</span><br><span class="line">		&lt;encoder&gt;</span><br><span class="line">			&lt;pattern&gt;$&#123;log.pattern&#125;&lt;/pattern&gt;</span><br><span class="line">		&lt;/encoder&gt;</span><br><span class="line">		&lt;filter class=&quot;ch.qos.logback.classic.filter.LevelFilter&quot;&gt;</span><br><span class="line">			&lt;level&gt;ERROR&lt;/level&gt;</span><br><span class="line">			&lt;onMatch&gt;ACCEPT&lt;/onMatch&gt;</span><br><span class="line">			&lt;onMismatch&gt;DENY&lt;/onMismatch&gt;</span><br><span class="line">		&lt;/filter&gt;</span><br><span class="line">	&lt;/appender&gt;</span><br><span class="line">	&lt;!-- logger 存放日志对象，同时告诉我们logback我们需要关注哪个package下的信息 --&gt;</span><br><span class="line">	&lt;!-- additivity 如果additivity为true那么root下面的appender也会想到logger下面 --&gt;</span><br><span class="line">	&lt;logger name=&quot;com.brotherc.demo&quot; level=&quot;$&#123;log.level&#125;&quot; additivity=&quot;true&quot;&gt;</span><br><span class="line">		&lt;appender-ref ref=&quot;debugAppender&quot; /&gt;</span><br><span class="line">		&lt;appender-ref ref=&quot;infoAppender&quot; /&gt;</span><br><span class="line">		&lt;appender-ref ref=&quot;errorAppender&quot; /&gt;</span><br><span class="line">	&lt;/logger&gt;</span><br><span class="line">	&lt;!--root 就是特殊的logger，根logger。如果logger没有指定level，默认继承root --&gt;</span><br><span class="line">	&lt;root level=&quot;info&quot;&gt;</span><br><span class="line">		&lt;appender-ref ref=&quot;consoleAppender&quot; /&gt;</span><br><span class="line">	&lt;/root&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>

                    
                        

                    
                    
                        <p>
                            <a href="/2020/05/05/logback/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2020/05/04/分布式事务/">
                            分布式事务
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2020-05-04T19:43:32+08:00">
	
		    5月 04, 2020
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/分布式事务/1.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/分布式事务/1.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/分布式事务/2.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/分布式事务/2.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/分布式事务/3.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/分布式事务/3.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/分布式事务/4.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/分布式事务/4.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/分布式事务/5.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/分布式事务/5.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/分布式事务/6.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/分布式事务/6.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h5 id="两段式：2PC"><a href="#两段式：2PC" class="headerlink" title="两段式：2PC"></a>两段式：2PC</h5><h5 id="三段式：3PC"><a href="#三段式：3PC" class="headerlink" title="三段式：3PC"></a>三段式：3PC</h5><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/分布式事务/7.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/分布式事务/7.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/分布式事务/8.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/分布式事务/8.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/分布式事务/9.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/分布式事务/9.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/分布式事务/10.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/分布式事务/10.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/分布式事务/11.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/分布式事务/11.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/分布式事务/12.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/分布式事务/12.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h5 id="1-需要提供分布式事务支持的接口上添加-Compensable"><a href="#1-需要提供分布式事务支持的接口上添加-Compensable" class="headerlink" title="1.需要提供分布式事务支持的接口上添加@Compensable"></a>1.需要提供分布式事务支持的接口上添加@Compensable</h5><h5 id="2-在对应的接口实现上添加-Compensable"><a href="#2-在对应的接口实现上添加-Compensable" class="headerlink" title="2.在对应的接口实现上添加@Compensable"></a>2.在对应的接口实现上添加@Compensable</h5><h5 id="3-在接口上添加confirmMethod、cancelMethod、transactionContextEditor"><a href="#3-在接口上添加confirmMethod、cancelMethod、transactionContextEditor" class="headerlink" title="3.在接口上添加confirmMethod、cancelMethod、transactionContextEditor"></a>3.在接口上添加confirmMethod、cancelMethod、transactionContextEditor</h5><h5 id="4-实现对应的confirmMethod、cancelMethod（注意：confirm方法和cancel方法必须与try方法在同一个类中）"><a href="#4-实现对应的confirmMethod、cancelMethod（注意：confirm方法和cancel方法必须与try方法在同一个类中）" class="headerlink" title="4.实现对应的confirmMethod、cancelMethod（注意：confirm方法和cancel方法必须与try方法在同一个类中）"></a>4.实现对应的confirmMethod、cancelMethod（注意：confirm方法和cancel方法必须与try方法在同一个类中）</h5><h5 id="5-主事务的业务都已经实现的差不多的时候才调用子事务"><a href="#5-主事务的业务都已经实现的差不多的时候才调用子事务" class="headerlink" title="5.主事务的业务都已经实现的差不多的时候才调用子事务"></a>5.主事务的业务都已经实现的差不多的时候才调用子事务</h5><h4 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h4><h5 id="1-分布式事务里，不要轻易在业务层捕获所有异常"><a href="#1-分布式事务里，不要轻易在业务层捕获所有异常" class="headerlink" title="1.分布式事务里，不要轻易在业务层捕获所有异常"></a>1.分布式事务里，不要轻易在业务层捕获所有异常</h5><h5 id="2-使用TCC-Transaction时，confirm和cancel的幂等性需要自己代码支持"><a href="#2-使用TCC-Transaction时，confirm和cancel的幂等性需要自己代码支持" class="headerlink" title="2.使用TCC-Transaction时，confirm和cancel的幂等性需要自己代码支持"></a>2.使用TCC-Transaction时，confirm和cancel的幂等性需要自己代码支持</h5><h5 id="幂等性：使用相同参数对同一资源重复调用某个接口的结果与调用一次的结果相同"><a href="#幂等性：使用相同参数对同一资源重复调用某个接口的结果与调用一次的结果相同" class="headerlink" title="幂等性：使用相同参数对同一资源重复调用某个接口的结果与调用一次的结果相同"></a>幂等性：使用相同参数对同一资源重复调用某个接口的结果与调用一次的结果相同</h5><p>参考：<br><a href="https://github.com/changmingxie/tcc-transaction" target="_blank" rel="noopener">https://github.com/changmingxie/tcc-transaction</a></p>

                    
                        

                    
                    
                        <p>
                            <a href="/2020/05/04/分布式事务/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2020/04/18/加密类型及其相关算法/">
                            加密类型及其相关算法
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2020-04-18T14:50:24+08:00">
	
		    4月 18, 2020
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="一、数据传输安全性"><a href="#一、数据传输安全性" class="headerlink" title="一、数据传输安全性"></a>一、数据传输安全性</h2><h5 id="在TCP-IP层中不涉及安全"><a href="#在TCP-IP层中不涉及安全" class="headerlink" title="在TCP/IP层中不涉及安全"></a>在TCP/IP层中不涉及安全</h5><ul>
<li>机密性：明文传输（ftp,smtp,talnet）别人一拦截就能看到请求的内容。</li>
<li>完整性：10颗原子弹（被改成100）所以数据在互联网上传播的时候，不应该也不能够被其他人非法篡改掉。当收到的和发送的不一致时拒绝接受这就能保证数据的完整性。</li>
<li>身份验证：通过有效的手段保证所访问的对象就是我们所要的那个人。</li>
</ul>
<h4 id="保证数据的机密性"><a href="#保证数据的机密性" class="headerlink" title="保证数据的机密性"></a>保证数据的机密性</h4><ul>
<li>plaintext(明文) –&gt; 加密（转换规则）–&gt; ciphertext（密文）</li>
<li>ciphertext –&gt; 转换规则 –&gt; plaintext</li>
<li>转换算法：依赖密钥（即使得到了转换规则也没用）</li>
<li>对称加密：加密和解密使用同一个密钥（有加密算法和解密算法，算法不同，但密钥相同）。<br>好处是计算速度快，在一定程度上解决了机密性问题。坏处是不能解决密钥有效管理的问题。<br>假如a跟b，c,d通信，如果密钥相同，则c只要用密钥就可以看到a发送给b的内容，显然密钥不能相同，<br>那就得维护很多密钥。</li>
</ul>
<h4 id="保证数据的完整性"><a href="#保证数据的完整性" class="headerlink" title="保证数据的完整性"></a>保证数据的完整性</h4><ul>
<li>A：plaintext:footprint –&gt; B<br>B使用同样的加密算法去重复计算这个明文的特征码，并跟A所发过来的特征码进行比较，<br>如果一样，则说明没被篡改。</li>
<li>单项加密算法：提取数据特征码，追加到数据后面。数据的输入一样：特征码必然相同。</li>
<li>特点：<br>输入一样，输出必然相同<br>雪崩效应（输入的微小改变，将其会引起结果的巨大改变）<br>定长输出（无论原始数据是多长，结果大小都是相同的）<br>不可逆（无法根据原始特征码还原原来的数据）</li>
</ul>
<h4 id="中间人攻击问题"><a href="#中间人攻击问题" class="headerlink" title="中间人攻击问题"></a>中间人攻击问题</h4><ul>
<li>E(A)：plaintext2:footprint2 –&gt; B<br>A生成一段数据，并对它计算特征码，E在中间经过的路由时拿到这个明文，并重新修改明文和再计算特征码发给B，还声称自己是A，B拿到数据之后就算使用了数据完整性的算法之后，计算特征码还是一模一样，还认为是A发过来的，所以需要借助额外的机制。</li>
<li>解决办法：A：plaintext:footprint(加密) –&gt; B B拿到特征码之后通过密钥进行解密，能解密<br>说明数据没有被改过。如果E拿到plaintext并修改为plaintext2，并重新生成特征码，就没办法加密<br>特征码或者加密后就不是A和B之间实现约定的密码。</li>
</ul>
<h4 id="A与B之间如何进行密码约定"><a href="#A与B之间如何进行密码约定" class="headerlink" title="A与B之间如何进行密码约定"></a>A与B之间如何进行密码约定</h4><ul>
<li>假如A与B之间从未通信或从未见过面，如何进行密码约定呢？</li>
<li>协商生成密码：密码交换（Internet Key Exchange / IKE）,密码交换是不让第三方得到密钥，<br>密码交换需要特殊的互联网协议支撑。比如：Dffie-Hellman协议。</li>
<li>A和B事先约定两个数p(大素数)，g(生成数)。A生成一个自己知道的x，B生成一个自己知道的y。<br>A将 g^x % p 发送给B，B将g^y % p 发送给A。<br>A拿到之后进行计算 （g^y % p）^x = g^xy % p，<br>B拿到之后进行计算 （g^x % p）^y = g^xy % p。<br>这个相同的结果就是密钥。<br>在互联网上可以看到g、p、g^x % p、g^y % p，但看不到x、y。</li>
<li>A和B只需要选好几个数，让这些数的计算结果作为密钥来用，使得彼此不用计算密码，只要双方<br>生成密钥的软件一样就可以随时生成密钥。</li>
</ul>
<h4 id="身份验证"><a href="#身份验证" class="headerlink" title="身份验证"></a>身份验证</h4><ul>
<li>之前是A和B一起约定好的密码，所以身份验证没问题。但是密钥是交换生成的，事先之前谁也不知道。<br>E跳出来，截取了数据并篡改，然后与B进行连接通信，还告诉它自己是A。</li>
<li>解决办法：公钥加密算法（非对称加密算法）</li>
<li>特点：拥有一对密钥对，分别是公钥（是从私钥中提取出来的）、私钥。用公钥加密的，只能用私钥<br>解密，反之亦然。</li>
</ul>
<h4 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h4><ul>
<li>机密性：用B的公钥加密，B的私钥解密。发送方用对方的公钥加密数据，可以保证数据机密性。</li>
<li>身份验证：用A的私钥加密，A的公钥解密。发送方用自己的私钥加密数据，可以实现身份验证。</li>
<li>公钥加密算法很少用来加密数据：速度太慢。非对称加密的主要作用也就是身份验证。</li>
</ul>
<h2 id="二、数据传输"><a href="#二、数据传输" class="headerlink" title="二、数据传输"></a>二、数据传输</h2><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/加密/数据传输.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/加密/数据传输.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<p>PKI:公钥基础设施(Public Key Infrastructure) 核心就是CA和彼此之间的信任关系<br>CA:证书颁发机构(Certificate Authority)，CA中还维护了CRL<br>CRL:证书撤销列表，CRL中保存了此前曾经发出去的证书，但仍未过期，只不过已经各种原因被撤销了</p>
<h2 id="三、TLS-SSL"><a href="#三、TLS-SSL" class="headerlink" title="三、TLS/SSL"></a>三、TLS/SSL</h2><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/加密/1.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/加密/1.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h3 id="不同标准下的证书格式是不同的"><a href="#不同标准下的证书格式是不同的" class="headerlink" title="不同标准下的证书格式是不同的"></a>不同标准下的证书格式是不同的</h3><p>比如x509, pkcs12<br>x509: 公钥及其有效期限，证书的合法拥有者，证书该如何被使用，CA的信息，CA签名的校验码<br>TLS/SSL所使用的正是x509的证书，TLS/SSL其实就是一种PKI，PKI的第二种实现OpenGPG</p>
<h3 id="TLS-SSL-如何实现握手认证、密钥交换"><a href="#TLS-SSL-如何实现握手认证、密钥交换" class="headerlink" title="TLS/SSL 如何实现握手认证、密钥交换"></a>TLS/SSL 如何实现握手认证、密钥交换</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/加密/2.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/加密/2.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h2 id="四、加密"><a href="#四、加密" class="headerlink" title="四、加密"></a>四、加密</h2><h3 id="对称加密"><a href="#对称加密" class="headerlink" title="对称加密"></a>对称加密</h3><p>加密解密使用同一个密码</p>
<ul>
<li>DES(Data Encrption Standard, 56bit)</li>
<li>3DES</li>
<li>AES(Advanced, AES192/AES256/AES512)</li>
<li>Blowfish</li>
</ul>
<h3 id="单向加密"><a href="#单向加密" class="headerlink" title="单向加密"></a>单向加密</h3><ul>
<li>MD4</li>
<li>MD5</li>
<li>SHA1</li>
<li>SHA192、SHA256、SHA384</li>
<li>CRC-32</li>
</ul>
<h3 id="非对称加密（公钥加密）"><a href="#非对称加密（公钥加密）" class="headerlink" title="非对称加密（公钥加密）"></a>非对称加密（公钥加密）</h3><p>身份认证（数字签名）、数据加密、密钥交换</p>
<ul>
<li>RSA(加密、签名)</li>
<li>DSA(签名)</li>
<li>ElGamal</li>
</ul>
<h3 id="加密实现"><a href="#加密实现" class="headerlink" title="加密实现"></a>加密实现</h3><p>OpenSSL: SSL的开源实现<br>  libcryptc: 通用的加密库<br>  libssl: TLS/SSL的实现<br>    基于会话的、实现了省份认证、数据机密性和会话完整性的TLS/SSL库<br>  openssl: 多用途命令行工具<br>    实现私有证书颁发机构</p>

                    
                        

                    
                    
                        <p>
                            <a href="/2020/04/18/加密类型及其相关算法/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2020/04/12/docker/">
                            docker基础
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2020-04-12T12:05:46+08:00">
	
		    4月 12, 2020
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/1.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/1.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/2.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/2.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/3.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/3.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/4.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/4.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/5.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/5.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/6.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/6.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/7.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/7.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/8.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/8.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/9.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/9.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/10.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/10.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/11.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/11.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/12.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/12.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/13.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/13.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/14.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/14.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/15.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/15.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/16.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/16.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/17.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/17.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/18.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/18.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/19.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/19.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/20.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/20.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/21.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/21.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sudo yum remove docker \</span><br><span class="line">docker-common \</span><br><span class="line">docker-selinux \</span><br><span class="line">docker-engine</span><br><span class="line"></span><br><span class="line">sudo yum install -y yum-utils \</span><br><span class="line">device-mapper-persistent-data \</span><br><span class="line">lvm2</span><br><span class="line"></span><br><span class="line">sudo yum-config-manager \</span><br><span class="line">--add-repo \</span><br><span class="line">https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line">sudo yum install docker-ce</span><br></pre></td></tr></table></figure>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start docker</span><br><span class="line">sudo docker version</span><br></pre></td></tr></table></figure>
<h3 id="helloworld"><a href="#helloworld" class="headerlink" title="helloworld"></a>helloworld</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run hello-world</span><br></pre></td></tr></table></figure>
<h3 id="镜像"><a href="#镜像" class="headerlink" title="镜像"></a>镜像</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/22.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/22.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/23.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/23.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/24.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/24.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 查看进程</span><br><span class="line">ps -ef | grep docker</span><br><span class="line">// 查看镜像</span><br><span class="line">sudo docker image ls</span><br><span class="line">// 拉取镜像</span><br><span class="line">sudo docker pull ubuntu:14.04</span><br><span class="line">// 运行镜像</span><br><span class="line">docker run hello-world</span><br><span class="line">docker run -it centos</span><br><span class="line">// 删除镜像</span><br><span class="line">docker image rm 67759a80360c(镜像ID)</span><br><span class="line">docker image rmi f2a91732366c(镜像ID)</span><br></pre></td></tr></table></figure>
<h3 id="自己实现helloworld"><a href="#自己实现helloworld" class="headerlink" title="自己实现helloworld"></a>自己实现helloworld</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mkdir hello-world</span><br><span class="line">cd hello-world/</span><br><span class="line">vim hello.c</span><br><span class="line"></span><br><span class="line">// 内容</span><br><span class="line">#include&lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">  printf(&quot;hello docker\n&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gcc -static hello.c -o hello</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim Dockerfile</span><br><span class="line"></span><br><span class="line">// 内容</span><br><span class="line">FROM scratch</span><br><span class="line">ADD hello /</span><br><span class="line">CMD [&quot;/hello&quot;]</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build -t brotherc/hello-world .</span><br><span class="line">docker run brotherc/hello-world</span><br></pre></td></tr></table></figure>
<h3 id="容器"><a href="#容器" class="headerlink" title="容器"></a>容器</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/25.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/25.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">docker container ls</span><br><span class="line">docker container ls -a</span><br><span class="line">docker container ps -a</span><br><span class="line">docker rm $(docker container ls -f &quot;status-exited&quot; -q)</span><br><span class="line">docker rm $(docker container ls -aq)</span><br><span class="line">docker container rm 846b5efe98d4(容器ID)</span><br><span class="line">docker container rm 84(容器ID前缀)</span><br><span class="line">// 将已有容器提交成新的镜像</span><br><span class="line">Usage: docker commit [OPTIONS] CONTAINER [REPOSITORY[:TAG]] [flags]</span><br><span class="line">docker commit xenodochial_pare(容器名称) brotherc/centos-vim</span><br><span class="line">docker stop 容器id或名称</span><br><span class="line">docker start 容器id或名称</span><br><span class="line">docker inspect 容器id或名称</span><br><span class="line">docker logs 容器id或名称</span><br></pre></td></tr></table></figure>
<h3 id="基于已经存在的container创建一个image"><a href="#基于已经存在的container创建一个image" class="headerlink" title="基于已经存在的container创建一个image"></a>基于已经存在的container创建一个image</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 运行一个已安装好vim的centos容器</span><br><span class="line">docker run -it centos</span><br><span class="line">yum install -y vim</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 容器名：xenodochial_pare</span><br><span class="line">docker commit xenodochial_pare brotherc/centos-vim</span><br></pre></td></tr></table></figure>
<h3 id="基于Dockerfile创建一个image"><a href="#基于Dockerfile创建一个image" class="headerlink" title="基于Dockerfile创建一个image"></a>基于Dockerfile创建一个image</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mkdir docker-centos-vim</span><br><span class="line">cd docker-centos-vim/</span><br><span class="line">vim Dockerfile</span><br><span class="line"></span><br><span class="line">FROM centos</span><br><span class="line">RUN yum install -y vim</span><br><span class="line"></span><br><span class="line">docker build -t brotherc/centos-vim-new .</span><br></pre></td></tr></table></figure>
<h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><h4 id="FROM"><a href="#FROM" class="headerlink" title="FROM"></a>FROM</h4><p>尽量使用官方的image作为base image!<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FROM scratch #制作base image</span><br><span class="line">FROM centos  #使用base image</span><br><span class="line">FROM ubuntu:14.04</span><br></pre></td></tr></table></figure></p>
<h4 id="LABEL"><a href="#LABEL" class="headerlink" title="LABEL"></a>LABEL</h4><p>Metadata不可少!<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LABEL maintainer=&quot;brotherc@136.com&quot;</span><br><span class="line">LABEL version=&quot;1.0&quot;</span><br><span class="line">LABEL description=&quot;This is description&quot;</span><br></pre></td></tr></table></figure></p>
<h4 id="RUN"><a href="#RUN" class="headerlink" title="RUN"></a>RUN</h4><p>为了美观，复杂的RUN请用反斜杠换行!避免无用分层，合并多条命令成一行!<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RUN yum update &amp;&amp; yum install -y vim \ #反斜线换行</span><br><span class="line">    python-dev</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RUN apt-get update &amp;&amp; apt-get install -y perl \</span><br><span class="line">    pwgen --no-install-recommends &amp;&amp; rm -rf \</span><br><span class="line">    /var/lib/apt/lists/* #注意清理cache</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RUN /bin/bash -c&apos;source $HOME/.bashrc;echo $HOME&apos;</span><br></pre></td></tr></table></figure>
<h4 id="WORKDIR"><a href="#WORKDIR" class="headerlink" title="WORKDIR"></a>WORKDIR</h4><p>设定当前工作目录，类似cd<br>用WORKDIR，不要用RUN cd!尽量使用绝对目录!<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WORKDIR /root</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WORKDIR /test #如果没有会自动创建test目录</span><br><span class="line">WORKDIR demo</span><br><span class="line">RUN pwd       #输出结果应该是 /test/demo</span><br></pre></td></tr></table></figure>
<h4 id="ADD-and-COPY"><a href="#ADD-and-COPY" class="headerlink" title="ADD and COPY"></a>ADD and COPY</h4><p>将本地文件添加到image里面<br>大部分情况，COPY优于ADD!ADD除了COPY还有额外功能(解压)!添加远程文件/目录<br>请使用curl或者wget!<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ADD hello /</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ADD test.tar.gz / #添加到根目录并解压</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">WORKDIR /root</span><br><span class="line">ADD hello test/ # /root/test/hello</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">WORKDIR /root</span><br><span class="line">COPY hello test/</span><br></pre></td></tr></table></figure>
<h4 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a>ENV</h4><p>尽量使用ENV增加可维护性!<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ENV MYSQL_VERSION 5.6 #设置常量</span><br><span class="line">RUN apt-get install -y mysql-server=&quot;$&#123;MYSQL_VERSION&#125;&quot; \</span><br><span class="line">    &amp;&amp; rm -rf /var/lib/apt/lists/* #引用常量</span><br></pre></td></tr></table></figure></p>
<h4 id="RUN-vs-CMD-vs-ENTRYPOINT"><a href="#RUN-vs-CMD-vs-ENTRYPOINT" class="headerlink" title="RUN vs CMD vs ENTRYPOINT"></a>RUN vs CMD vs ENTRYPOINT</h4><p>RUN:执行命令并创建新的image layer<br>CMD:设置容器启动后默认执行的命令和参数<br>ENTRYPOINT:设置容器启动时运行的命令</p>
<h4 id="Shell格式"><a href="#Shell格式" class="headerlink" title="Shell格式"></a>Shell格式</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RUN apt-get install -y vim</span><br><span class="line">CMD echo &quot;hello docker&quot;</span><br><span class="line">ENTRYPOINT echo &quot;hello docker&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FROM centos</span><br><span class="line">ENV name Docker</span><br><span class="line">ENTRYPOINT echo &quot;hello $name&quot;</span><br></pre></td></tr></table></figure>
<h4 id="Exec格式"><a href="#Exec格式" class="headerlink" title="Exec格式"></a>Exec格式</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RUN [&quot;apt-get&quot;, &quot;install&quot;, &quot;-y&quot;, &quot;vim&quot;]</span><br><span class="line">CMD [&quot;/bin/echo&quot;, &quot;hello docker&quot;]</span><br><span class="line">ENTRYPOINT [&quot;/bin/echo&quot;, &quot;hello docker&quot;]</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FROM centos</span><br><span class="line">ENV name Docker</span><br><span class="line">ENTRYPOINT [&quot;/bin/echo&quot;, &quot;hello docker&quot;]</span><br></pre></td></tr></table></figure>
<h3 id="Dockerfile实践"><a href="#Dockerfile实践" class="headerlink" title="Dockerfile实践"></a>Dockerfile实践</h3><p>Dockerfile:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FROM centos</span><br><span class="line">ENV name Docker</span><br><span class="line">ENTRYPOINT echo &quot;hello $name&quot;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker build -t brotherc/centos-entrypoint-shell .</span><br><span class="line">docker run brotherc/centos-entrypoint-shell</span><br><span class="line">hello Docker</span><br></pre></td></tr></table></figure>
<p>Dockerfile:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FROM centos</span><br><span class="line">ENV name Docker</span><br><span class="line">ENTRYPOINT [&quot;/bin/bash&quot;, &quot;-c&quot;, &quot;echo hello $name&quot;]</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker build -t brotherc/centos-entrypoint-exec .</span><br><span class="line">docker run brotherc/centos-entrypoint-exec</span><br><span class="line">hello Docker</span><br></pre></td></tr></table></figure>
<h4 id="CMD"><a href="#CMD" class="headerlink" title="CMD"></a>CMD</h4><p>容器启动时默认执行的命令<br>如果docker run指定了其它命令，CMD命令被忽略<br>如果定义了多个CMD，只有最后一个会执行<br>Dockerfile:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FROM centos</span><br><span class="line">ENV name Docker</span><br><span class="line">CMD echo &quot;hello $name&quot;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker build -t brotherc/centos-cmd-shell .</span><br><span class="line">docker run brotherc/centos-cmd-shell</span><br><span class="line">hello Docker</span><br><span class="line"></span><br><span class="line">docker run -it brotherc/centos-cmd-shell /bin/bash</span><br><span class="line">无输出</span><br></pre></td></tr></table></figure>
<h4 id="ENTRYPOINT"><a href="#ENTRYPOINT" class="headerlink" title="ENTRYPOINT"></a>ENTRYPOINT</h4><p>让容器以应用程序或者服务的形式运行<br>不会被忽略，一定会执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run brotherc/centos-entrypoint-shell</span><br><span class="line">hello Docker</span><br><span class="line"></span><br><span class="line">docker run -it brotherc/centos-entrypoint-shell /bin/bash</span><br><span class="line">hello Docker</span><br></pre></td></tr></table></figure></p>
<h3 id="镜像的发布"><a href="#镜像的发布" class="headerlink" title="镜像的发布"></a>镜像的发布</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker login</span><br><span class="line">docker push DockerId/镜像名称</span><br><span class="line">docker pull DockerId/镜像名称</span><br></pre></td></tr></table></figure>
<h4 id="分享产生image"><a href="#分享产生image" class="headerlink" title="分享产生image"></a>分享产生image</h4><p>把我们的账户link到github或bitbucket，在github上面创建一个代码仓库，把我们的dockerfile push上去，这样就做了一个关联。<br>只要我们这个仓库里面有dockerfile，就会自动去克隆获取到这个dockerfile然后dockerhub后台服务器会帮我们去build。<br>这样我们既提供了dockerfile，docker image又是dockerhub后台服务器帮我们build的，这个安全性会有很大的提升。<br><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/78.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/78.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div></p>
<h4 id="私有的registry"><a href="#私有的registry" class="headerlink" title="私有的registry"></a>私有的registry</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 5000:5000 --restart always --name registry</span><br><span class="line">// 访问ip:5000</span><br></pre></td></tr></table></figure>
<p>/etc/docker/daemon.json:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;insecure-registries&quot;:[&quot;ip:5000&quot;]&#125;</span><br></pre></td></tr></table></figure></p>
<p>/lib/systemd/system/docker.service:<br><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/79.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/79.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service docker restart</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">telnet ip:5000</span><br><span class="line"></span><br><span class="line">docker push ip:5000/镜像名称</span><br><span class="line">docker pull ip:5000/镜像名称</span><br></pre></td></tr></table></figure>
<h3 id="Docker-Network"><a href="#Docker-Network" class="headerlink" title="Docker Network"></a>Docker Network</h3><h4 id="基础网络概念"><a href="#基础网络概念" class="headerlink" title="基础网络概念"></a>基础网络概念</h4><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/32.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/32.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/33.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/33.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/34.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/34.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/35.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/35.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/36.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/36.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/37.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/37.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/38.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/38.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/39.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/39.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/40.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/40.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -d --name test1 busybox /bin/sh -c &quot;while true; do sleep 3600; done&quot;</span><br><span class="line">sudo docker exec -it test1 /bin/sh</span><br><span class="line"></span><br><span class="line">ip a</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -d --name test2 busybox /bin/sh -c &quot;while true; do sleep 3600; done&quot;</span><br><span class="line">sudo docker exec test2 ip a</span><br></pre></td></tr></table></figure>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/41.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/41.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/42.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/42.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/43.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/43.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/44.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/44.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/45.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/45.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/46.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/46.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/47.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/47.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/48.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/48.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/49.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/49.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/50.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/50.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/51.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/51.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/52.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/52.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/53.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/53.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/54.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/54.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/55.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/55.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/56.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/56.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/57.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/57.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/58.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/58.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/59.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/59.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/60.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/60.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/61.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/61.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/62.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/62.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/63.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/63.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/64.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/64.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/65.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/65.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/66.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/66.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/67.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/67.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/68.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/68.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/69.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/69.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/70.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/70.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/71.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/71.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/72.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/72.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/73.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/73.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/74.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/74.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/75.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/75.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/76.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/76.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/77.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/77.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h3 id="Docker的持久化存储和数据共享"><a href="#Docker的持久化存储和数据共享" class="headerlink" title="Docker的持久化存储和数据共享"></a>Docker的持久化存储和数据共享</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/26.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/26.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/27.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/27.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/28.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/28.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/29.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/29.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h4 id="数据持久化：Data-Volume"><a href="#数据持久化：Data-Volume" class="headerlink" title="数据持久化：Data Volume"></a>数据持久化：Data Volume</h4><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/30.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/30.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//mysql镜像会默认将数据挂载到本地</span><br><span class="line">sudo docker run -d --name mysql1 -e MYSQL_ALLOW_EMPTY_PASSWORD=true mysql</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo docker volume ls</span><br><span class="line"></span><br><span class="line">DRIVER        VOLUME NAME</span><br><span class="line">local         e6ee5901156...</span><br><span class="line"></span><br><span class="line">sudo docker volume inspect e6ee5901156...</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo docker stop mysql1</span><br><span class="line">sudo docker rm mysql1</span><br><span class="line">sudo docker volume ls</span><br><span class="line"></span><br><span class="line">DRIVER        VOLUME NAME</span><br><span class="line">local         e6ee5901156...</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//给volume指定名字</span><br><span class="line">sudo docker run -d -v mysql:/var/lib/mysql --name mysql1 -e MYSQL_ALLOW_EMPTY_PASSWORD=true mysql</span><br><span class="line">sudo docker volume ls</span><br><span class="line"></span><br><span class="line">DRIVER        VOLUME NAME</span><br><span class="line">local         mysql</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//让mysql容器使用已存在的volume</span><br><span class="line">sudo docker rm -rf mysql1</span><br><span class="line">sudo docker run -d -v mysql:/var/lib/mysql --name mysql2 -e MYSQL_ALLOW_EMPTY_PASSWORD=true mysql</span><br></pre></td></tr></table></figure>
<h4 id="数据持久化：Bind-Mouting"><a href="#数据持久化：Bind-Mouting" class="headerlink" title="数据持久化：Bind Mouting"></a>数据持久化：Bind Mouting</h4><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/docker/31.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/docker/31.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<p>Dockerfile:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FROM nginx:latest</span><br><span class="line">WORKDIR /usr/share/nginx/html</span><br><span class="line">COPY index.html index.html</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build -t brotherc/my-nginx .</span><br><span class="line">docker run -d -p 80:80 --name web brotherc/my-nginx</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker rm -f web</span><br><span class="line">docker run -d -v $(pwd):/usr/share/nginx/html -p 80:80 --name web brotherc/my-nginx</span><br><span class="line">docker exec -it web /bin/bash</span><br><span class="line">//在容器中</span><br><span class="line">cd /usr/share/nginx/html</span><br><span class="line">touch test.txt</span><br><span class="line">exit</span><br><span class="line">//在linux中看到刚刚创建的test.txt文件</span><br></pre></td></tr></table></figure>

                    
                        

                    
                    
                        <p>
                            <a href="/2020/04/12/docker/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2020/04/09/网站/">
                            网站
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2020-04-09T20:46:59+08:00">
	
		    4月 09, 2020
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>参考：<br><a href="https://www.wireshark.org" target="_blank" rel="noopener">https://www.wireshark.org</a><br><a href="https://www.processon.com/" target="_blank" rel="noopener">https://www.processon.com/</a></p>
<p><a href="http://xinjipin.com/list.asp?id=26" target="_blank" rel="noopener">http://xinjipin.com/list.asp?id=26</a><br><a href="https://www.yunpanjingling.com/" target="_blank" rel="noopener">https://www.yunpanjingling.com/</a></p>

                    
                        

                    
                    
                        <p>
                            <a href="/2020/04/09/网站/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2020/04/09/Spring Security技术栈开发企业级认证与授权-Spring Security 开发基于表单的认证/">
                            Spring Security技术栈开发企业级认证与授权-Spring Security 开发基于表单的认证
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2020-04-09T20:29:14+08:00">
	
		    4月 09, 2020
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="1-Spring-Security-原理介绍"><a href="#1-Spring-Security-原理介绍" class="headerlink" title="1.Spring Security 原理介绍"></a>1.Spring Security 原理介绍</h2><h5 id="如果在classpath下有spring-security相关jar包，springboot会替我们做安全配置。"><a href="#如果在classpath下有spring-security相关jar包，springboot会替我们做安全配置。" class="headerlink" title="如果在classpath下有spring security相关jar包，springboot会替我们做安全配置。"></a>如果在classpath下有spring security相关jar包，springboot会替我们做安全配置。</h5><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/11.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/11.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">用户名：（固定）</span><br><span class="line">user</span><br></pre></td></tr></table></figure>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/12.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/12.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">密码：（看启动日志，默认安全密码）</span><br></pre></td></tr></table></figure>
<h5 id="默认不做任何配置的时候，spring-security做了两件事。把访问的所有服务都保护起来，访问任何一个restful服务，都要先进行身份认证，认证方式是http-base方式。"><a href="#默认不做任何配置的时候，spring-security做了两件事。把访问的所有服务都保护起来，访问任何一个restful服务，都要先进行身份认证，认证方式是http-base方式。" class="headerlink" title="默认不做任何配置的时候，spring security做了两件事。把访问的所有服务都保护起来，访问任何一个restful服务，都要先进行身份认证，认证方式是http.base方式。"></a>默认不做任何配置的时候，spring security做了两件事。把访问的所有服务都保护起来，访问任何一个restful服务，都要先进行身份认证，认证方式是http.base方式。</h5><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/13.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/13.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h5 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h5><p>security-browser:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class BrowserSecurityConfig extends AbstractChannelSecurityConfig &#123;</span><br><span class="line">	@Override</span><br><span class="line">	protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line">//  http.formLogin()  //formLogin表单登录</span><br><span class="line">    http.httpBasic()  //http.base登录</span><br><span class="line">        .and()</span><br><span class="line">        .authorizeRequests()</span><br><span class="line">        .anyRequest()  //任何请求都要身份认证</span><br><span class="line">        .authenticated();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/14.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/14.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">绿色过滤器：认证用户的身份，每一个过滤器处理一种认证方式。</span><br><span class="line">橙色过滤器：最终到这里，决定当前请求能不能去访问后面的服务，依据代码里的配置，判断是不是经过了前面的认证配置，根据代码中的规则判断过还是不过，不过会根据不用的原因抛出异常。</span><br><span class="line">蓝色过滤器：捕获后面这个过滤器抛出的异常，根据抛出的异常做出相应的处理。</span><br></pre></td></tr></table></figure>
<h2 id="2-基于Spring-Security的默认实现开发“用户名-密码”-认证"><a href="#2-基于Spring-Security的默认实现开发“用户名-密码”-认证" class="headerlink" title="2.基于Spring Security的默认实现开发“用户名 + 密码” 认证"></a>2.基于Spring Security的默认实现开发“用户名 + 密码” 认证</h2><h3 id="自定义用户认证逻辑"><a href="#自定义用户认证逻辑" class="headerlink" title="自定义用户认证逻辑"></a>自定义用户认证逻辑</h3><h5 id="处理用户信息获取逻辑-UserDetailsService-amp-处理用户校验逻辑-UserDetails"><a href="#处理用户信息获取逻辑-UserDetailsService-amp-处理用户校验逻辑-UserDetails" class="headerlink" title="处理用户信息获取逻辑 UserDetailsService &amp; 处理用户校验逻辑 UserDetails"></a>处理用户信息获取逻辑 UserDetailsService &amp; 处理用户校验逻辑 UserDetails</h5><p>security-demo:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class MyUserDetailsService implements UserDetailsService &#123;</span><br><span class="line">	private Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123;</span><br><span class="line">		logger.info(&quot;表单登录用户名:&quot; + username);</span><br><span class="line">		// 根据用户名查找用户信息</span><br><span class="line">		// 根据查找到的用户信息判断用户是否被冻结</span><br><span class="line">    // User =&gt; isAccountNonExpired()</span><br><span class="line">    // User =&gt; isAccountNonLocked()</span><br><span class="line">    // User =&gt; isCredentialsNonExpired()</span><br><span class="line">    // User =&gt; isEnabled()</span><br><span class="line">		return new User(username, &quot;123456&quot;, true, true, true, true, AuthorityUtils.commaSeparatedStringToAuthorityList(&quot;admin&quot;));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="处理密码加密解密-PasswordEncoder"><a href="#处理密码加密解密-PasswordEncoder" class="headerlink" title="处理密码加密解密 PasswordEncoder"></a>处理密码加密解密 PasswordEncoder</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class BrowserSecurityConfig extends AbstractChannelSecurityConfig &#123;</span><br><span class="line">	@Bean</span><br><span class="line">	public PasswordEncoder passwordEncoder() &#123;</span><br><span class="line">		return new BCryptPasswordEncoder();</span><br><span class="line">	&#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class MyUserDetailsService implements UserDetailsService &#123;</span><br><span class="line">	private Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line">	@Autowired</span><br><span class="line">	private PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123;</span><br><span class="line">    ...</span><br><span class="line">    String password = passwordEncoder.encode(&quot;123456&quot;);</span><br><span class="line">		logger.info(&quot;数据库密码是:&quot;+password);</span><br><span class="line">		return new User(username, password, true, true, true, true, AuthorityUtils.commaSeparatedStringToAuthorityList(&quot;admin&quot;));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="个性化用户认证流程"><a href="#个性化用户认证流程" class="headerlink" title="个性化用户认证流程"></a>个性化用户认证流程</h3><h5 id="自定义登录页面"><a href="#自定义登录页面" class="headerlink" title="自定义登录页面"></a>自定义登录页面</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class BrowserSecurityConfig extends AbstractChannelSecurityConfig &#123;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line">    http.formLogin()</span><br><span class="line">        .loginPage(&quot;/login.html&quot;)</span><br><span class="line">        .loginProcessingUrl(&quot;/authentication/form&quot;)</span><br><span class="line">        .and()</span><br><span class="line">        .authorizeRequests()</span><br><span class="line">        .antMatchers(&quot;login.html&quot;).permitAll()</span><br><span class="line">        .anyRequest()</span><br><span class="line">        .authenticated()</span><br><span class="line">        .and()</span><br><span class="line">        .csrf().disable();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>security-browser \src\main\resources\resources\login.html<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">&lt;title&gt;登录&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">	&lt;h2&gt;标准登录页面&lt;/h2&gt;</span><br><span class="line">	&lt;h3&gt;表单登录&lt;/h3&gt;</span><br><span class="line">	&lt;form action=&quot;/authentication/form&quot; method=&quot;post&quot;&gt;</span><br><span class="line">		&lt;table&gt;</span><br><span class="line">			&lt;tr&gt;</span><br><span class="line">				&lt;td&gt;用户名:&lt;/td&gt;</span><br><span class="line">				&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;username&quot;&gt;&lt;/td&gt;</span><br><span class="line">			&lt;/tr&gt;</span><br><span class="line">			&lt;tr&gt;</span><br><span class="line">				&lt;td&gt;密码:&lt;/td&gt;</span><br><span class="line">				&lt;td&gt;&lt;input type=&quot;password&quot; name=&quot;password&quot;&gt;&lt;/td&gt;</span><br><span class="line">			&lt;/tr&gt;</span><br><span class="line">			&lt;tr&gt;</span><br><span class="line">				&lt;td colspan=&quot;2&quot;&gt;&lt;button type=&quot;submit&quot;&gt;登录&lt;/button&gt;&lt;/td&gt;</span><br><span class="line">			&lt;/tr&gt;</span><br><span class="line">		&lt;/table&gt;</span><br><span class="line">	&lt;/form&gt;</span><br><span class="line">	&lt;br&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/15.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/15.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/16.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/16.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<p>security-core:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class BrowserProperties &#123;</span><br><span class="line">	private String loginPage = &quot;login.html&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">@ConfigurationProperties(prefix = &quot;demo.security&quot;)</span><br><span class="line">public class SecurityProperties &#123;</span><br><span class="line">	private BrowserProperties browser = new BrowserProperties();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@EnableConfigurationProperties(SecurityProperties.class)</span><br><span class="line">public class SecurityCoreConfig &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>security-browser<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class BrowserSecurityController &#123;</span><br><span class="line">	private Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line">	private RequestCache requestCache = new HttpSessionRequestCache();</span><br><span class="line">	private RedirectStrategy redirectStrategy = new DefaultRedirectStrategy();</span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">	private SecurityProperties securityProperties;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 当需要身份认证时，跳转到这里</span><br><span class="line">	 */</span><br><span class="line">	@RequestMapping(&quot;/authentication/require&quot;)</span><br><span class="line">	@ResponseStatus(code = HttpStatus.UNAUTHORIZED)</span><br><span class="line">	public SimpleResponse requireAuthentication(HttpServletRequest request, HttpServletResponse response)</span><br><span class="line">			throws IOException &#123;</span><br><span class="line"></span><br><span class="line">		SavedRequest savedRequest = requestCache.getRequest(request, response);</span><br><span class="line"></span><br><span class="line">		if (savedRequest != null) &#123;</span><br><span class="line">			String targetUrl = savedRequest.getRedirectUrl();</span><br><span class="line">			logger.info(&quot;引发跳转的请求是:&quot; + targetUrl);</span><br><span class="line">			if (StringUtils.endsWithIgnoreCase(targetUrl, &quot;.html&quot;)) &#123;</span><br><span class="line">				redirectStrategy.sendRedirect(request, response, securityProperties.getBrowser().getLoginPage());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		return new SimpleResponse(&quot;访问的服务需要身份认证，请引导用户到登录页&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">@AllArgsConstructor</span><br><span class="line">public class SimpleResponse &#123;</span><br><span class="line">	private Object content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class BrowserSecurityConfig extends AbstractChannelSecurityConfig &#123;</span><br><span class="line">	...</span><br><span class="line">	@Autowired</span><br><span class="line">	private SecurityProperties securityProperties;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line">    http.formLogin()</span><br><span class="line">        .loginPage(&quot;/authentication/require&quot;)</span><br><span class="line">        .loginProcessingUrl(&quot;/authentication/form&quot;)</span><br><span class="line">        .and()</span><br><span class="line">        .authorizeRequests()</span><br><span class="line">        .antMatchers(&quot;/authentication/require&quot;, securityProperties.getBrowser().getLoginPage()).permitAll()</span><br><span class="line">        .anyRequest()</span><br><span class="line">        .authenticated()</span><br><span class="line">        .and()</span><br><span class="line">        .csrf().disable();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>security-demo \src\main\resources\resources\demo-login.html<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">&lt;title&gt;登录&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">	&lt;h2&gt;Demo登录页&lt;/h2&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>security-demo application.properties<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">demo.security.browser.loginPage = /demo-login.html</span><br></pre></td></tr></table></figure></p>
<h5 id="自定义登录成功处理"><a href="#自定义登录成功处理" class="headerlink" title="自定义登录成功处理"></a>自定义登录成功处理</h5><p>security-browser:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@Component(&quot;myAuthenticationSuccessHandler&quot;)</span><br><span class="line">public class MyAuthenticationSuccessHandler extends SavedRequestAwareAuthenticationSuccessHandler &#123;</span><br><span class="line">	private Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">	private ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">	private SecurityProperties securityProperties;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response,</span><br><span class="line">			Authentication authentication) throws IOException, ServletException &#123;</span><br><span class="line">		logger.info(&quot;登录成功&quot;);</span><br><span class="line"></span><br><span class="line">		if (LoginResponseType.JSON.equals(securityProperties.getBrowser().getLoginType())) &#123;</span><br><span class="line">			response.setContentType(&quot;application/json;charset=UTF-8&quot;);</span><br><span class="line">			response.getWriter().write(objectMapper.writeValueAsString(authentication));</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			super.onAuthenticationSuccess(request, response, authentication);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="自定义登录失败处理"><a href="#自定义登录失败处理" class="headerlink" title="自定义登录失败处理"></a>自定义登录失败处理</h5><p>security-browser:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@Component(&quot;myAuthenctiationFailureHandler&quot;)</span><br><span class="line">public class MyAuthenctiationFailureHandler extends SimpleUrlAuthenticationFailureHandler &#123;</span><br><span class="line">	private Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">	private ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">	private SecurityProperties securityProperties;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response,</span><br><span class="line">			AuthenticationException exception) throws IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">		logger.info(&quot;登录失败&quot;);</span><br><span class="line"></span><br><span class="line">		if (LoginResponseType.JSON.equals(securityProperties.getBrowser().getLoginType())) &#123;</span><br><span class="line">			response.setStatus(HttpStatus.INTERNAL_SERVER_ERROR.value());</span><br><span class="line">			response.setContentType(&quot;application/json;charset=UTF-8&quot;);</span><br><span class="line">			response.getWriter().write(objectMapper.writeValueAsString(new SimpleResponse(exception.getMessage())));</span><br><span class="line">		&#125;else&#123;</span><br><span class="line">			super.onAuthenticationFailure(request, response, exception);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class BrowserProperties &#123;</span><br><span class="line">  ...</span><br><span class="line">  private LoginResponseType loginType = LoginResponseType.JSON;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public enum LoginResponseType &#123;</span><br><span class="line">	/**</span><br><span class="line">	 * 跳转</span><br><span class="line">	 */</span><br><span class="line">	REDIRECT,</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 返回json</span><br><span class="line">	 */</span><br><span class="line">	JSON</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class BrowserSecurityConfig extends AbstractChannelSecurityConfig &#123;</span><br><span class="line">	...</span><br><span class="line">	@Autowired</span><br><span class="line">	private SecurityProperties securityProperties;</span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">	private AuthenticationSuccessHandler myAuthenticationSuccessHandler;</span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">	private AuthenctiationFailureHandler myAuthenctiationFailureHandler;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line">    http.formLogin()</span><br><span class="line">        .loginPage(&quot;/authentication/require&quot;)</span><br><span class="line">        .loginProcessingUrl(&quot;/authentication/form&quot;)</span><br><span class="line">        .successHandler(myAuthenticationSuccessHandler)</span><br><span class="line">        .failureHandler(myAuthenctiationFailureHandler)</span><br><span class="line">        .and()</span><br><span class="line">        .authorizeRequests()</span><br><span class="line">        .antMatchers(&quot;/authentication/require&quot;, securityProperties.getBrowser().getLoginPage()).permitAll()</span><br><span class="line">        .anyRequest()</span><br><span class="line">        .authenticated()</span><br><span class="line">        .and()</span><br><span class="line">        .csrf().disable();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>security-demo application.properties<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">demo.security.browser.loginType = REDIRECT</span><br></pre></td></tr></table></figure></p>
<h3 id="实现图形验证码功能"><a href="#实现图形验证码功能" class="headerlink" title="实现图形验证码功能"></a>实现图形验证码功能</h3><h5 id="开发生成图形验证码接口"><a href="#开发生成图形验证码接口" class="headerlink" title="开发生成图形验证码接口"></a>开发生成图形验证码接口</h5><p>security-core<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class ImageCode &#123;</span><br><span class="line">	private BufferedImage image;</span><br><span class="line">	private String code;</span><br><span class="line">	private LocalDateTime expireTime;</span><br><span class="line"></span><br><span class="line">	public ImageCode(String code, int expireIn)&#123;</span><br><span class="line">		this.code = code;</span><br><span class="line">		this.expireTime = LocalDateTime.now().plusSeconds(expireIn);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public ImageCode(String code, LocalDateTime expireTime)&#123;</span><br><span class="line">		this.code = code;</span><br><span class="line">		this.expireTime = expireTime;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public boolean isExpried() &#123;</span><br><span class="line">		return LocalDateTime.now().isAfter(expireTime);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class ValidateCodeController &#123;</span><br><span class="line">	public static final String SESSION_KEY = &quot;SESSION_KEY_IMAGE_CODE&quot;;</span><br><span class="line">	private SessionStrategy sessionStrategy = new HttpSessionSessionStrategy();</span><br><span class="line">	@Autowired</span><br><span class="line">	private ValidateCodeGenerator imageCodeGenerator;</span><br><span class="line"></span><br><span class="line">	@GetMapping(&quot;/code/image&quot;)</span><br><span class="line">	public void createCode(HttpServletRequest request, HttpServletResponse response)</span><br><span class="line">			throws Exception &#123;</span><br><span class="line">    ImageCode imageCode = imageCodeGenerator.generate(new ServletWebRequest(request));</span><br><span class="line">    sessionStrategy.setAttribute(new ServletWebRequest(request), SESSION_KEY, imageCode);</span><br><span class="line">		ImageIO.write(imageCode.getImage(), &quot;JPEG&quot;, request.getResponse().getOutputStream());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="验证码的生成逻辑可配置"><a href="#验证码的生成逻辑可配置" class="headerlink" title="验证码的生成逻辑可配置"></a>验证码的生成逻辑可配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class ValidateCodeBeanConfig &#123;</span><br><span class="line">	@Autowired</span><br><span class="line">	private SecurityProperties securityProperties;</span><br><span class="line"></span><br><span class="line">	@Bean</span><br><span class="line">	@ConditionalOnMissingBean(name = &quot;imageValidateCodeGenerator&quot;)</span><br><span class="line">	public ValidateCodeGenerator imageValidateCodeGenerator() &#123;</span><br><span class="line">		ImageCodeGenerator codeGenerator = new ImageCodeGenerator();</span><br><span class="line">		codeGenerator.setSecurityProperties(securityProperties);</span><br><span class="line">		return codeGenerator;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface ValidateCodeGenerator &#123;</span><br><span class="line">	ValidateCode generate(ServletWebRequest request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">public class ImageCodeGenerator implements ValidateCodeGenerator &#123;</span><br><span class="line">	/**</span><br><span class="line">	 * 系统配置</span><br><span class="line">	 */</span><br><span class="line">	@Autowired</span><br><span class="line">	private SecurityProperties securityProperties;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public ImageCode generate(ServletWebRequest request) &#123;</span><br><span class="line">		int width = ServletRequestUtils.getIntParameter(request.getRequest(), &quot;width&quot;,</span><br><span class="line">				securityProperties.getCode().getImage().getWidth());</span><br><span class="line">		int height = ServletRequestUtils.getIntParameter(request.getRequest(), &quot;height&quot;,</span><br><span class="line">				securityProperties.getCode().getImage().getHeight());</span><br><span class="line">		BufferedImage image = new BufferedImage(width, height, BufferedImage.TYPE_INT_RGB);</span><br><span class="line"></span><br><span class="line">		Graphics g = image.getGraphics();</span><br><span class="line"></span><br><span class="line">		Random random = new Random();</span><br><span class="line"></span><br><span class="line">		g.setColor(getRandColor(200, 250));</span><br><span class="line">		g.fillRect(0, 0, width, height);</span><br><span class="line">		g.setFont(new Font(&quot;Times New Roman&quot;, Font.ITALIC, 20));</span><br><span class="line">		g.setColor(getRandColor(160, 200));</span><br><span class="line">		for (int i = 0; i &lt; 155; i++) &#123;</span><br><span class="line">			int x = random.nextInt(width);</span><br><span class="line">			int y = random.nextInt(height);</span><br><span class="line">			int xl = random.nextInt(12);</span><br><span class="line">			int yl = random.nextInt(12);</span><br><span class="line">			g.drawLine(x, y, x + xl, y + yl);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		String sRand = &quot;&quot;;</span><br><span class="line">		for (int i = 0; i &lt; securityProperties.getCode().getImage().getLength(); i++) &#123;</span><br><span class="line">			String rand = String.valueOf(random.nextInt(10));</span><br><span class="line">			sRand += rand;</span><br><span class="line">			g.setColor(new Color(20 + random.nextInt(110), 20 + random.nextInt(110), 20 + random.nextInt(110)));</span><br><span class="line">			g.drawString(rand, 13 * i + 6, 16);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		g.dispose();</span><br><span class="line"></span><br><span class="line">		return new ImageCode(image, sRand, securityProperties.getCode().getImage().getExpireIn());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 生成随机背景条纹</span><br><span class="line">	 *</span><br><span class="line">	 * @param fc</span><br><span class="line">	 * @param bc</span><br><span class="line">	 * @return</span><br><span class="line">	 */</span><br><span class="line">	private Color getRandColor(int fc, int bc) &#123;</span><br><span class="line">		Random random = new Random();</span><br><span class="line">		if (fc &gt; 255) &#123;</span><br><span class="line">			fc = 255;</span><br><span class="line">		&#125;</span><br><span class="line">		if (bc &gt; 255) &#123;</span><br><span class="line">			bc = 255;</span><br><span class="line">		&#125;</span><br><span class="line">		int r = fc + random.nextInt(bc - fc);</span><br><span class="line">		int g = fc + random.nextInt(bc - fc);</span><br><span class="line">		int b = fc + random.nextInt(bc - fc);</span><br><span class="line">		return new Color(r, g, b);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public SecurityProperties getSecurityProperties() &#123;</span><br><span class="line">		return securityProperties;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void setSecurityProperties(SecurityProperties securityProperties) &#123;</span><br><span class="line">		this.securityProperties = securityProperties;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="验证码基本参数可配置"><a href="#验证码基本参数可配置" class="headerlink" title="验证码基本参数可配置"></a>验证码基本参数可配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@ConfigurationProperties(prefix = &quot;demo.security&quot;)</span><br><span class="line">public class SecurityProperties &#123;</span><br><span class="line">  ...</span><br><span class="line">  private ValidateCodeProperties code = new ValidateCodeProperties();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class ValidateCodeProperties &#123;</span><br><span class="line">	private ImageCodeProperties image = new ImageCodeProperties();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class ImageCodeProperties &#123;</span><br><span class="line">	private int length = 4;</span><br><span class="line">	private int width = 67;</span><br><span class="line">	private int height = 23;</span><br><span class="line">	private int expireIn = 60;</span><br><span class="line"></span><br><span class="line">	private String url;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class BrowserSecurityConfig extends AbstractChannelSecurityConfig &#123;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line">    http.formLogin()</span><br><span class="line">        .loginPage(&quot;/authentication/require&quot;)</span><br><span class="line">        .loginProcessingUrl(&quot;/authentication/form&quot;)</span><br><span class="line">        .successHandler(myAuthenticationSuccessHandler)</span><br><span class="line">        .failureHandler(myAuthenctiationFailureHandler)</span><br><span class="line">        .and()</span><br><span class="line">        .authorizeRequests()</span><br><span class="line">        .antMatchers(&quot;/authentication/require&quot;, securityProperties.getBrowser().getLoginPage(), &quot;/code/image&quot;).permitAll()</span><br><span class="line">        .anyRequest()</span><br><span class="line">        .authenticated()</span><br><span class="line">        .and()</span><br><span class="line">        .csrf().disable();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">			&lt;tr&gt;</span><br><span class="line">				&lt;td&gt;图形验证码:&lt;/td&gt;</span><br><span class="line">				&lt;td&gt;</span><br><span class="line">					&lt;input type=&quot;text&quot; name=&quot;imageCode&quot;&gt;</span><br><span class="line">					&lt;img src=&quot;/code/image?width=200&quot;&gt;</span><br><span class="line">				&lt;/td&gt;</span><br><span class="line">			&lt;/tr&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="在认证流程中加入图形验证码校验-amp-验证码拦截的接口可配置"><a href="#在认证流程中加入图形验证码校验-amp-验证码拦截的接口可配置" class="headerlink" title="在认证流程中加入图形验证码校验 &amp; 验证码拦截的接口可配置"></a>在认证流程中加入图形验证码校验 &amp; 验证码拦截的接口可配置</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/17.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/17.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">public class ValidateCodeFilter extends OncePerRequestFilter implements InitializingBean &#123;</span><br><span class="line">  private AuthenticationFailureHandler authenticationFailureHandler;</span><br><span class="line">  private SessionStrategy sessionStrategy = new HttpSessionSessionStrategy();</span><br><span class="line">  private Set&lt;String&gt; urls = new HashSet&lt;&gt;();</span><br><span class="line">  private SecurityProperties securityProperties;</span><br><span class="line">  private AntPathMatcher pathMatcher = new AntPathMatcher();</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void afterPropertiesSet() throws ServletException &#123;</span><br><span class="line">		super.afterPropertiesSet();</span><br><span class="line">		String[] urls = StringUtils.splitByWholeSeparatorPreserveAllTokens(securityProperties.getCode().getImage().getUrl(), &quot;,&quot;);</span><br><span class="line">		for (String url : urls) &#123;</span><br><span class="line">			urls.put(url);</span><br><span class="line">		&#125;</span><br><span class="line">    urls.add(&quot;/authentication/form&quot;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span><br><span class="line">			throws ServletException, IOException &#123;</span><br><span class="line">    boolean action = false;</span><br><span class="line">    for (String url : urls) &#123;</span><br><span class="line">      if (pathMatcher.match(url, request.getRequestURI())) &#123;</span><br><span class="line">        action = true;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">		if (action) &#123;</span><br><span class="line">			try &#123;</span><br><span class="line">				validate(new ServletWebRequest(request, response));</span><br><span class="line">			&#125; catch (ValidateCodeException exception) &#123;</span><br><span class="line">				authenticationFailureHandler.onAuthenticationFailure(request, response, exception);</span><br><span class="line">				return;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		chain.doFilter(request, response);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  public void validate(ServletWebRequest request) &#123;</span><br><span class="line">		String sessionKey = ValidateCodeController.SESSION_KEY;</span><br><span class="line">		ImageCode codeInSession = (ImageCode)sessionStrategy.getAttribute(request, sessionKey);</span><br><span class="line"></span><br><span class="line">		String codeInRequest;</span><br><span class="line">		try &#123;</span><br><span class="line">			codeInRequest = ServletRequestUtils.getStringParameter(request.getRequest(), &quot;imageCode&quot;);</span><br><span class="line">		&#125; catch (ServletRequestBindingException e) &#123;</span><br><span class="line">			throw new ValidateCodeException(&quot;获取验证码的值失败&quot;);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if (StringUtils.isBlank(codeInRequest)) &#123;</span><br><span class="line">			throw new ValidateCodeException(processorType + &quot;验证码的值不能为空&quot;);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if (codeInSession == null) &#123;</span><br><span class="line">			throw new ValidateCodeException(processorType + &quot;验证码不存在&quot;);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if (codeInSession.isExpried()) &#123;</span><br><span class="line">			sessionStrategy.removeAttribute(request, sessionKey);</span><br><span class="line">			throw new ValidateCodeException(processorType + &quot;验证码已过期&quot;);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if (!StringUtils.equals(codeInSession.getCode(), codeInRequest)) &#123;</span><br><span class="line">			throw new ValidateCodeException(processorType + &quot;验证码不匹配&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">		sessionStrategy.removeAttribute(request, sessionKey);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public class ValidateCodeException extends AuthenticationException &#123;</span><br><span class="line">	private static final long serialVersionUID = -7285211528095468156L;</span><br><span class="line"></span><br><span class="line">	public ValidateCodeException(String msg) &#123;</span><br><span class="line">		super(msg);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class BrowserSecurityConfig extends AbstractChannelSecurityConfig &#123;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line">    ValidateCodeFilter validateCodeFilter = new ValidateCodeFilter();</span><br><span class="line">    validateCodeFilter.setAuthenticationFailureHandler(myAuthenticationFailureHandler);</span><br><span class="line">    validateCodeFilter.setSecurityProperties(securityProperties);</span><br><span class="line">    validateCodeFilter.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line">    http.addFilterBefore(validateCodeFilter, UsernamePasswordAuthenticationFilter.class)</span><br><span class="line">        .formLogin()</span><br><span class="line">        .loginPage(&quot;/authentication/require&quot;)</span><br><span class="line">        .loginProcessingUrl(&quot;/authentication/form&quot;)</span><br><span class="line">        .successHandler(myAuthenticationSuccessHandler)</span><br><span class="line">        .failureHandler(myAuthenctiationFailureHandler)</span><br><span class="line">        .and()</span><br><span class="line">        .authorizeRequests()</span><br><span class="line">        .antMatchers(&quot;/authentication/require&quot;, securityProperties.getBrowser().getLoginPage(), &quot;/code/image&quot;).permitAll()</span><br><span class="line">        .anyRequest()</span><br><span class="line">        .authenticated()</span><br><span class="line">        .and()</span><br><span class="line">        .csrf().disable();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/18.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/18.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<p>security-demo application.properties<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">demo.security.code.image.length = 6</span><br><span class="line">demo.security.code.image.width = 100</span><br><span class="line">demo.security.code.image.url = /user,/user/*</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Component(&quot;imageCodeGenerator&quot;)</span><br><span class="line">public class DemoImageCodeGenerator implements ValidateCodeGenerator &#123;</span><br><span class="line">	@Override</span><br><span class="line">	public ImageCode generate(ServletWebRequest request) &#123;</span><br><span class="line">		System.out.println(&quot;更高级的图形验证码生成代码&quot;);</span><br><span class="line">		return null;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="实现-“记住我”-功能"><a href="#实现-“记住我”-功能" class="headerlink" title="实现 “记住我” 功能"></a>实现 “记住我” 功能</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/19.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/19.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/20.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/20.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<p>security-browser:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;tr&gt;</span><br><span class="line">	&lt;td colspan=&apos;2&apos;&gt;&lt;input name=&quot;remember-me&quot; type=&quot;checkbox&quot; value=&quot;true&quot; /&gt;记住我&lt;/td&gt;</span><br><span class="line">&lt;/tr&gt;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public class BrowserProperties &#123;</span><br><span class="line">	...</span><br><span class="line">	private int rememberMeSeconds = 3600;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class BrowserSecurityConfig extends AbstractChannelSecurityConfig &#123;</span><br><span class="line">	...</span><br><span class="line">	@Autowired</span><br><span class="line">	private DataSource dataSource;</span><br><span class="line">	@Autowired</span><br><span class="line">	private UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line">    ValidateCodeFilter validateCodeFilter = new ValidateCodeFilter();</span><br><span class="line">    validateCodeFilter.setAuthenticationFailureHandler(myAuthenticationFailureHandler);</span><br><span class="line">    validateCodeFilter.setSecurityProperties(securityProperties);</span><br><span class="line">    validateCodeFilter.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line">    http.addFilterBefore(validateCodeFilter, UsernamePasswordAuthenticationFilter.class)</span><br><span class="line">        .formLogin()</span><br><span class="line">        .loginPage(&quot;/authentication/require&quot;)</span><br><span class="line">        .loginProcessingUrl(&quot;/authentication/form&quot;)</span><br><span class="line">        .successHandler(myAuthenticationSuccessHandler)</span><br><span class="line">        .failureHandler(myAuthenctiationFailureHandler)</span><br><span class="line">        .and()</span><br><span class="line">			  .rememberMe()</span><br><span class="line">				.tokenRepository(persistentTokenRepository())</span><br><span class="line">				.tokenValiditySeconds(securityProperties.getBrowser().getRememberMeSeconds())</span><br><span class="line">				.userDetailsService(userDetailsService)</span><br><span class="line">        .and()</span><br><span class="line">        .authorizeRequests()</span><br><span class="line">        .antMatchers(&quot;/authentication/require&quot;, securityProperties.getBrowser().getLoginPage(), &quot;/code/image&quot;).permitAll()</span><br><span class="line">        .anyRequest()</span><br><span class="line">        .authenticated()</span><br><span class="line">        .and()</span><br><span class="line">        .csrf().disable();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">	@Bean</span><br><span class="line">	public PersistentTokenRepository persistentTokenRepository() &#123;</span><br><span class="line">		JdbcTokenRepositoryImpl tokenRepository = new JdbcTokenRepositoryImpl();</span><br><span class="line">		tokenRepository.setDataSource(dataSource);</span><br><span class="line">//		tokenRepository.setCreateTableOnStartup(true);</span><br><span class="line">		return tokenRepository;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-开发-“手机号-短信”-认证"><a href="#3-开发-“手机号-短信”-认证" class="headerlink" title="3.开发 “手机号 + 短信” 认证"></a>3.开发 “手机号 + 短信” 认证</h2><h3 id="实现短信验证码登录"><a href="#实现短信验证码登录" class="headerlink" title="实现短信验证码登录"></a>实现短信验证码登录</h3><h5 id="开发短信验证码接口"><a href="#开发短信验证码接口" class="headerlink" title="开发短信验证码接口"></a>开发短信验证码接口</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public class ValidateCode &#123;</span><br><span class="line">	private String code;</span><br><span class="line">	private LocalDateTime expireTime;</span><br><span class="line"></span><br><span class="line">	public ValidateCode(String code, int expireIn)&#123;</span><br><span class="line">		this.code = code;</span><br><span class="line">		this.expireTime = LocalDateTime.now().plusSeconds(expireIn);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public ValidateCode(String code, LocalDateTime expireTime)&#123;</span><br><span class="line">		this.code = code;</span><br><span class="line">		this.expireTime = expireTime;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public boolean isExpried() &#123;</span><br><span class="line">		return LocalDateTime.now().isAfter(expireTime);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改ValidateCodeGenerator返回值<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface ValidateCodeGenerator &#123;</span><br><span class="line">	ValidateCode generate(ServletWebRequest request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class SmsCodeProperties &#123;</span><br><span class="line">	private int length = 6;</span><br><span class="line">	private int expireIn = 60;</span><br><span class="line">	private String url;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class ValidateCodeProperties &#123;</span><br><span class="line">	...</span><br><span class="line">	private SmsCodeProperties sms = new SmsCodeProperties();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">@Component(&quot;smsValidateCodeGenerator&quot;)</span><br><span class="line">public class SmsCodeGenerator implements ValidateCodeGenerator &#123;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public ValidateCode generate(ServletWebRequest request) &#123;</span><br><span class="line">		String code = RandomStringUtils.randomNumeric(securityProperties.getCode().getSms().getLength());</span><br><span class="line">		return new ValidateCode(code, securityProperties.getCode().getSms().getExpireIn());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface SmsCodeSender &#123;</span><br><span class="line">	void send(String mobile, String code);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class ValidateCodeBeanConfig &#123;</span><br><span class="line">	...</span><br><span class="line">	@Bean</span><br><span class="line">	@ConditionalOnMissingBean(SmsCodeSender.class)</span><br><span class="line">	public SmsCodeSender smsCodeSender() &#123;</span><br><span class="line">		return new DefaultSmsCodeSender();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public class DefaultSmsCodeSender implements SmsCodeSender &#123;</span><br><span class="line">	@Override</span><br><span class="line">	public void send(String mobile, String code) &#123;</span><br><span class="line">		System.out.println(&quot;向手机&quot;+mobile+&quot;发送短信验证码&quot;+code);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class ValidateCodeController &#123;</span><br><span class="line">  ...</span><br><span class="line">  @Autowired</span><br><span class="line">  private SmsCodeSender smsCodeSender;</span><br><span class="line"></span><br><span class="line">  @Autowired</span><br><span class="line">  private SmsCodeGenerator smsCodeGenerator;</span><br><span class="line"></span><br><span class="line">  @GetMapping(&quot;/code/sms&quot;)</span><br><span class="line">  public void createSmsCode(HttpServletRequest request, HttpServletResponse response)</span><br><span class="line">      throws Exception &#123;</span><br><span class="line">      ValidateCode smsCode = smsCodeGenerator.generate(new ServletWebRequest(request));</span><br><span class="line">      sessionStrategy.setAttribute(new ServletWebRequest(request), SESSION_KEY, smsCode);</span><br><span class="line">  		String mobile = ServletRequestUtils.getRequiredStringParameter(request.getRequest(), &quot;mobile&quot;);</span><br><span class="line">  		smsCodeSender.send(mobile, validateCode.getCode());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">&lt;h3&gt;短信登录&lt;/h3&gt;</span><br><span class="line">&lt;form action=&quot;/authentication/mobile&quot; method=&quot;post&quot;&gt;</span><br><span class="line">  &lt;table&gt;</span><br><span class="line">    &lt;tr&gt;</span><br><span class="line">      &lt;td&gt;手机号:&lt;/td&gt;</span><br><span class="line">      &lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;mobile&quot; value=&quot;13012345678&quot;&gt;&lt;/td&gt;</span><br><span class="line">    &lt;/tr&gt;</span><br><span class="line">    &lt;tr&gt;</span><br><span class="line">      &lt;td&gt;短信验证码:&lt;/td&gt;</span><br><span class="line">      &lt;td&gt;</span><br><span class="line">        &lt;input type=&quot;text&quot; name=&quot;smsCode&quot;&gt;</span><br><span class="line">        &lt;a href=&quot;/code/sms?mobile=13012345678&quot;&gt;发送验证码&lt;/a&gt;</span><br><span class="line">      &lt;/td&gt;</span><br><span class="line">    &lt;/tr&gt;</span><br><span class="line">    &lt;tr&gt;</span><br><span class="line">      &lt;td colspan=&quot;2&quot;&gt;&lt;button type=&quot;submit&quot;&gt;登录&lt;/button&gt;&lt;/td&gt;</span><br><span class="line">    &lt;/tr&gt;</span><br><span class="line">  &lt;/table&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h5 id="校验短信验证码并登录"><a href="#校验短信验证码并登录" class="headerlink" title="校验短信验证码并登录"></a>校验短信验证码并登录</h5><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/38.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/38.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">public class SmsCodeAuthenticationToken extends AbstractAuthenticationToken &#123;</span><br><span class="line">	private static final long serialVersionUID = SpringSecurityCoreVersion.SERIAL_VERSION_UID;</span><br><span class="line"></span><br><span class="line">	private final Object principal;</span><br><span class="line"></span><br><span class="line">	public SmsCodeAuthenticationToken(String mobile) &#123;</span><br><span class="line">		super(null);</span><br><span class="line">		this.principal = mobile;</span><br><span class="line">		setAuthenticated(false);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public SmsCodeAuthenticationToken(Object principal,</span><br><span class="line">			Collection&lt;? extends GrantedAuthority&gt; authorities) &#123;</span><br><span class="line">		super(authorities);</span><br><span class="line">		this.principal = principal;</span><br><span class="line">		super.setAuthenticated(true); // must use super, as we override</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public Object getCredentials() &#123;</span><br><span class="line">		return null;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public Object getPrincipal() &#123;</span><br><span class="line">		return this.principal;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void setAuthenticated(boolean isAuthenticated) throws IllegalArgumentException &#123;</span><br><span class="line">		if (isAuthenticated) &#123;</span><br><span class="line">			throw new IllegalArgumentException(</span><br><span class="line">					&quot;Cannot set this token to trusted - use constructor which takes a GrantedAuthority list instead&quot;);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		super.setAuthenticated(false);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void eraseCredentials() &#123;</span><br><span class="line">		super.eraseCredentials();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">public class SmsCodeAuthenticationFilter extends AbstractAuthenticationProcessingFilter &#123;</span><br><span class="line">	private String mobileParameter = SecurityConstants.DEFAULT_PARAMETER_NAME_MOBILE;</span><br><span class="line">	private boolean postOnly = true;</span><br><span class="line"></span><br><span class="line">	public SmsCodeAuthenticationFilter() &#123;</span><br><span class="line">		super(new AntPathRequestMatcher(SecurityConstants.DEFAULT_LOGIN_PROCESSING_URL_MOBILE, &quot;POST&quot;));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response)</span><br><span class="line">			throws AuthenticationException &#123;</span><br><span class="line">		if (postOnly &amp;&amp; !request.getMethod().equals(&quot;POST&quot;)) &#123;</span><br><span class="line">			throw new AuthenticationServiceException(&quot;Authentication method not supported: &quot; + request.getMethod());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		String mobile = obtainMobile(request);</span><br><span class="line"></span><br><span class="line">		if (mobile == null) &#123;</span><br><span class="line">			mobile = &quot;&quot;;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		mobile = mobile.trim();</span><br><span class="line"></span><br><span class="line">		SmsCodeAuthenticationToken authRequest = new SmsCodeAuthenticationToken(mobile);</span><br><span class="line"></span><br><span class="line">		// Allow subclasses to set the &quot;details&quot; property</span><br><span class="line">		setDetails(request, authRequest);</span><br><span class="line"></span><br><span class="line">		return this.getAuthenticationManager().authenticate(authRequest);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 获取手机号</span><br><span class="line">	 */</span><br><span class="line">	protected String obtainMobile(HttpServletRequest request) &#123;</span><br><span class="line">		return request.getParameter(mobileParameter);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	protected void setDetails(HttpServletRequest request, SmsCodeAuthenticationToken authRequest) &#123;</span><br><span class="line">		authRequest.setDetails(authenticationDetailsSource.buildDetails(request));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void setMobileParameter(String usernameParameter) &#123;</span><br><span class="line">		Assert.hasText(usernameParameter, &quot;Username parameter must not be empty or null&quot;);</span><br><span class="line">		this.mobileParameter = usernameParameter;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void setPostOnly(boolean postOnly) &#123;</span><br><span class="line">		this.postOnly = postOnly;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public final String getMobileParameter() &#123;</span><br><span class="line">		return mobileParameter;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">public class SmsCodeAuthenticationProvider implements AuthenticationProvider &#123;</span><br><span class="line">	private UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public Authentication authenticate(Authentication authentication) throws AuthenticationException &#123;</span><br><span class="line"></span><br><span class="line">		SmsCodeAuthenticationToken authenticationToken = (SmsCodeAuthenticationToken) authentication;</span><br><span class="line"></span><br><span class="line">		UserDetails user = userDetailsService.loadUserByUsername((String) authenticationToken.getPrincipal());</span><br><span class="line"></span><br><span class="line">		if (user == null) &#123;</span><br><span class="line">			throw new InternalAuthenticationServiceException(&quot;无法获取用户信息&quot;);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		SmsCodeAuthenticationToken authenticationResult = new SmsCodeAuthenticationToken(user, user.getAuthorities());</span><br><span class="line"></span><br><span class="line">		authenticationResult.setDetails(authenticationToken.getDetails());</span><br><span class="line"></span><br><span class="line">		return authenticationResult;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public boolean supports(Class&lt;?&gt; authentication) &#123;</span><br><span class="line">		return SmsCodeAuthenticationToken.class.isAssignableFrom(authentication);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public UserDetailsService getUserDetailsService() &#123;</span><br><span class="line">		return userDetailsService;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void setUserDetailsService(UserDetailsService userDetailsService) &#123;</span><br><span class="line">		this.userDetailsService = userDetailsService;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">public class SmsCodeFilter extends OncePerRequestFilter implements InitializingBean &#123;</span><br><span class="line">  private AuthenticationFailureHandler authenticationFailureHandler;</span><br><span class="line">  private SessionStrategy sessionStrategy = new HttpSessionSessionStrategy();</span><br><span class="line">  private Set&lt;String&gt; urls = new HashSet&lt;&gt;();</span><br><span class="line">  private SecurityProperties securityProperties;</span><br><span class="line">  private AntPathMatcher pathMatcher = new AntPathMatcher();</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void afterPropertiesSet() throws ServletException &#123;</span><br><span class="line">		super.afterPropertiesSet();</span><br><span class="line">		String[] urls = StringUtils.splitByWholeSeparatorPreserveAllTokens(securityProperties.getCode().getImage().getUrl(), &quot;,&quot;);</span><br><span class="line">		for (String url : urls) &#123;</span><br><span class="line">			urls.put(url);</span><br><span class="line">		&#125;</span><br><span class="line">    urls.add(&quot;/authentication/mobile&quot;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span><br><span class="line">			throws ServletException, IOException &#123;</span><br><span class="line">    boolean action = false;</span><br><span class="line">    for (String url : urls) &#123;</span><br><span class="line">      if (pathMatcher.match(url, request.getRequestURI())) &#123;</span><br><span class="line">        action = true;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">		if (action) &#123;</span><br><span class="line">			try &#123;</span><br><span class="line">				validate(new ServletWebRequest(request, response));</span><br><span class="line">			&#125; catch (ValidateCodeException exception) &#123;</span><br><span class="line">				authenticationFailureHandler.onAuthenticationFailure(request, response, exception);</span><br><span class="line">				return;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		chain.doFilter(request, response);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  public void validate(ServletWebRequest request) &#123;</span><br><span class="line">		String sessionKey = ValidateCodeController.SESSION_KEY;</span><br><span class="line">		ValidateCode codeInSession = (ValidateCode)sessionStrategy.getAttribute(request, sessionKey);</span><br><span class="line"></span><br><span class="line">		String codeInRequest;</span><br><span class="line">		try &#123;</span><br><span class="line">			codeInRequest = ServletRequestUtils.getStringParameter(request.getRequest(), &quot;smsCode&quot;);</span><br><span class="line">		&#125; catch (ServletRequestBindingException e) &#123;</span><br><span class="line">			throw new ValidateCodeException(&quot;获取验证码的值失败&quot;);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if (StringUtils.isBlank(codeInRequest)) &#123;</span><br><span class="line">			throw new ValidateCodeException(processorType + &quot;验证码的值不能为空&quot;);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if (codeInSession == null) &#123;</span><br><span class="line">			throw new ValidateCodeException(processorType + &quot;验证码不存在&quot;);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if (codeInSession.isExpried()) &#123;</span><br><span class="line">			sessionStrategy.removeAttribute(request, sessionKey);</span><br><span class="line">			throw new ValidateCodeException(processorType + &quot;验证码已过期&quot;);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if (!StringUtils.equals(codeInSession.getCode(), codeInRequest)) &#123;</span><br><span class="line">			throw new ValidateCodeException(processorType + &quot;验证码不匹配&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">		sessionStrategy.removeAttribute(request, sessionKey);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class SmsCodeAuthenticationSecurityConfig extends SecurityConfigurerAdapter&lt;DefaultSecurityFilterChain, HttpSecurity&gt; &#123;</span><br><span class="line">	@Autowired</span><br><span class="line">	private AuthenticationSuccessHandler myAuthenticationSuccessHandler;</span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">	private AuthenticationFailureHandler myAuthenticationFailureHandler;</span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">	private UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line">		SmsCodeAuthenticationFilter smsCodeAuthenticationFilter = new SmsCodeAuthenticationFilter();</span><br><span class="line">		smsCodeAuthenticationFilter.setAuthenticationManager(http.getSharedObject(AuthenticationManager.class));</span><br><span class="line">		smsCodeAuthenticationFilter.setAuthenticationSuccessHandler(myAuthenticationSuccessHandler);</span><br><span class="line">		smsCodeAuthenticationFilter.setAuthenticationFailureHandler(myAuthenticationFailureHandler);</span><br><span class="line"></span><br><span class="line">		SmsCodeAuthenticationProvider smsCodeAuthenticationProvider = new SmsCodeAuthenticationProvider();</span><br><span class="line">		smsCodeAuthenticationProvider.setUserDetailsService(userDetailsService);</span><br><span class="line"></span><br><span class="line">		http.authenticationProvider(smsCodeAuthenticationProvider)</span><br><span class="line">			.addFilterAfter(smsCodeAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class BrowserSecurityConfig extends AbstractChannelSecurityConfig &#123;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line">    ValidateCodeFilter validateCodeFilter = new ValidateCodeFilter();</span><br><span class="line">    validateCodeFilter.setAuthenticationFailureHandler(myAuthenticationFailureHandler);</span><br><span class="line">    validateCodeFilter.setSecurityProperties(securityProperties);</span><br><span class="line">    validateCodeFilter.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line">    SmsCodeFilter smsCodeFilter = new SmsCodeFilter();</span><br><span class="line">    smsCodeFilter.setAuthenticationFailureHandler(myAuthenticationFailureHandler);</span><br><span class="line">    smsCodeFilter.setSecurityProperties(securityProperties);</span><br><span class="line">    smsCodeFilter.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line">    http.addFilterBefore(smsCodeFilter, UsernamePasswordAuthenticationFilter.class)</span><br><span class="line">        .addFilterBefore(validateCodeFilter, UsernamePasswordAuthenticationFilter.class)</span><br><span class="line">        .formLogin()</span><br><span class="line">        .loginPage(&quot;/authentication/require&quot;)</span><br><span class="line">        .loginProcessingUrl(&quot;/authentication/form&quot;)</span><br><span class="line">        .successHandler(myAuthenticationSuccessHandler)</span><br><span class="line">        .failureHandler(myAuthenctiationFailureHandler)</span><br><span class="line">        .and()</span><br><span class="line">			  .rememberMe()</span><br><span class="line">				.tokenRepository(persistentTokenRepository())</span><br><span class="line">				.tokenValiditySeconds(securityProperties.getBrowser().getRememberMeSeconds())</span><br><span class="line">				.userDetailsService(userDetailsService)</span><br><span class="line">        .and()</span><br><span class="line">        .authorizeRequests()</span><br><span class="line">        .antMatchers(&quot;/authentication/require&quot;, securityProperties.getBrowser().getLoginPage(), &quot;/code/image&quot;).permitAll()</span><br><span class="line">        .anyRequest()</span><br><span class="line">        .authenticated()</span><br><span class="line">        .and()</span><br><span class="line">        .csrf().disable()</span><br><span class="line">        // 相当于把smsCodeAuthenticationSecurityConfig这个类中的配置加到了后面，等于接着往后写</span><br><span class="line">        .apply(smsCodeAuthenticationSecurityConfig);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="重构代码"><a href="#重构代码" class="headerlink" title="重构代码"></a>重构代码</h5><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/39.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/39.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>

                    
                        

                    
                    
                        <p>
                            <a href="/2020/04/09/Spring Security技术栈开发企业级认证与授权-Spring Security 开发基于表单的认证/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2020/04/09/Spring Social开发第三方认证/">
                            Spring Social开发第三方认证
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2020-04-09T20:12:09+08:00">
	
		    4月 09, 2020
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="1-OAuth协议以及Spring-Social原理简介"><a href="#1-OAuth协议以及Spring-Social原理简介" class="headerlink" title="1.OAuth协议以及Spring Social原理简介"></a>1.OAuth协议以及Spring Social原理简介</h2><h3 id="OAuth协议简介"><a href="#OAuth协议简介" class="headerlink" title="OAuth协议简介"></a>OAuth协议简介</h3><h5 id="OAuth协议要解决的问题"><a href="#OAuth协议要解决的问题" class="headerlink" title="OAuth协议要解决的问题"></a>OAuth协议要解决的问题</h5><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/40.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/40.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<ol>
<li>应用可以访问用户在微信上的所有数据</li>
<li>用户只有修改密码，才能收回授权</li>
<li>密码泄露的可能性大大提高</li>
</ol>
<h5 id="OAuth协议中的各种角色-amp-amp-运行流程"><a href="#OAuth协议中的各种角色-amp-amp-运行流程" class="headerlink" title="OAuth协议中的各种角色 &amp;&amp; 运行流程"></a>OAuth协议中的各种角色 &amp;&amp; 运行流程</h5><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/41.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/41.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/42.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/42.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h3 id="Spring-Social原理简介"><a href="#Spring-Social原理简介" class="headerlink" title="Spring Social原理简介"></a>Spring Social原理简介</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/43.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/43.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/44.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/44.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/45.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/45.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h2 id="2-实现QQ认证和微信认证"><a href="#2-实现QQ认证和微信认证" class="headerlink" title="2.实现QQ认证和微信认证"></a>2.实现QQ认证和微信认证</h2><h3 id="QQ认证"><a href="#QQ认证" class="headerlink" title="QQ认证"></a>QQ认证</h3><p>参考：<br><a href="https://wiki.connect.qq.com/" target="_blank" rel="noopener">https://wiki.connect.qq.com/</a><br><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/47.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/47.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div><br>spring-core:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class QQUserInfo &#123;</span><br><span class="line">	/**</span><br><span class="line">	 * 	返回码</span><br><span class="line">	 */</span><br><span class="line">	private String ret;</span><br><span class="line">	/**</span><br><span class="line">	 * 如果ret&lt;0，会有相应的错误信息提示，返回数据全部用UTF-8编码。</span><br><span class="line">	 */</span><br><span class="line">	private String msg;</span><br><span class="line">	/**</span><br><span class="line">	 *</span><br><span class="line">	 */</span><br><span class="line">	private String openId;</span><br><span class="line">	/**</span><br><span class="line">	 * 不知道什么东西，文档上没写，但是实际api返回里有。</span><br><span class="line">	 */</span><br><span class="line">	private String is_lost;</span><br><span class="line">	/**</span><br><span class="line">	 * 省(直辖市)</span><br><span class="line">	 */</span><br><span class="line">	private String province;</span><br><span class="line">	/**</span><br><span class="line">	 * 市(直辖市区)</span><br><span class="line">	 */</span><br><span class="line">	private String city;</span><br><span class="line">	/**</span><br><span class="line">	 * 出生年月</span><br><span class="line">	 */</span><br><span class="line">	private String year;</span><br><span class="line">	/**</span><br><span class="line">	 * 	用户在QQ空间的昵称。</span><br><span class="line">	 */</span><br><span class="line">	private String nickname;</span><br><span class="line">	/**</span><br><span class="line">	 * 	大小为30×30像素的QQ空间头像URL。</span><br><span class="line">	 */</span><br><span class="line">	private String figureurl;</span><br><span class="line">	/**</span><br><span class="line">	 * 	大小为50×50像素的QQ空间头像URL。</span><br><span class="line">	 */</span><br><span class="line">	private String figureurl_1;</span><br><span class="line">	/**</span><br><span class="line">	 * 	大小为100×100像素的QQ空间头像URL。</span><br><span class="line">	 */</span><br><span class="line">	private String figureurl_2;</span><br><span class="line">	/**</span><br><span class="line">	 * 	大小为40×40像素的QQ头像URL。</span><br><span class="line">	 */</span><br><span class="line">	private String figureurl_qq_1;</span><br><span class="line">	/**</span><br><span class="line">	 * 	大小为100×100像素的QQ头像URL。需要注意，不是所有的用户都拥有QQ的100×100的头像，但40×40像素则是一定会有。</span><br><span class="line">	 */</span><br><span class="line">	private String figureurl_qq_2;</span><br><span class="line">	/**</span><br><span class="line">	 * 	性别。 如果获取不到则默认返回”男”</span><br><span class="line">	 */</span><br><span class="line">	private String gender;</span><br><span class="line">	/**</span><br><span class="line">	 * 	标识用户是否为黄钻用户（0：不是；1：是）。</span><br><span class="line">	 */</span><br><span class="line">	private String is_yellow_vip;</span><br><span class="line">	/**</span><br><span class="line">	 * 	标识用户是否为黄钻用户（0：不是；1：是）</span><br><span class="line">	 */</span><br><span class="line">	private String vip;</span><br><span class="line">	/**</span><br><span class="line">	 * 	黄钻等级</span><br><span class="line">	 */</span><br><span class="line">	private String yellow_vip_level;</span><br><span class="line">	/**</span><br><span class="line">	 * 	黄钻等级</span><br><span class="line">	 */</span><br><span class="line">	private String level;</span><br><span class="line">	/**</span><br><span class="line">	 * 标识是否为年费黄钻用户（0：不是； 1：是）</span><br><span class="line">	 */</span><br><span class="line">	private String is_yellow_year_vip;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface QQ &#123;</span><br><span class="line">	QQUserInfo getUserInfo();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">public class QQImpl extends AbstractOAuth2ApiBinding implements QQ &#123;</span><br><span class="line">	private static final String URL_GET_OPENID = &quot;https://graph.qq.com/oauth2.0/me?access_token=%s&quot;;</span><br><span class="line"></span><br><span class="line">	private static final String URL_GET_USERINFO = &quot;https://graph.qq.com/user/get_user_info?oauth_consumer_key=%s&amp;openid=%s&quot;;</span><br><span class="line"></span><br><span class="line">	private String appId;</span><br><span class="line"></span><br><span class="line">	private String openId;</span><br><span class="line"></span><br><span class="line">	private ObjectMapper objectMapper = new ObjectMapper();</span><br><span class="line"></span><br><span class="line">	public QQImpl(String accessToken, String appId) &#123;</span><br><span class="line">		super(accessToken, TokenStrategy.ACCESS_TOKEN_PARAMETER);</span><br><span class="line"></span><br><span class="line">		this.appId = appId;</span><br><span class="line"></span><br><span class="line">		String url = String.format(URL_GET_OPENID, accessToken);</span><br><span class="line">		String result = getRestTemplate().getForObject(url, String.class);</span><br><span class="line"></span><br><span class="line">		this.openId = StringUtils.substringBetween(result, &quot;\&quot;openid\&quot;:\&quot;&quot;, &quot;\&quot;&#125;&quot;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public QQUserInfo getUserInfo() &#123;</span><br><span class="line"></span><br><span class="line">		String url = String.format(URL_GET_USERINFO, appId, openId);</span><br><span class="line">		String result = getRestTemplate().getForObject(url, String.class);</span><br><span class="line"></span><br><span class="line">		QQUserInfo userInfo = null;</span><br><span class="line">		try &#123;</span><br><span class="line">			userInfo = objectMapper.readValue(result, QQUserInfo.class);</span><br><span class="line">			userInfo.setOpenId(openId);</span><br><span class="line">			return userInfo;</span><br><span class="line">		&#125; catch (Exception e) &#123;</span><br><span class="line">			throw new RuntimeException(&quot;获取用户信息失败&quot;, e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">public class QQOAuth2Template extends OAuth2Template &#123;</span><br><span class="line">	private Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">	public QQOAuth2Template(String clientId, String clientSecret, String authorizeUrl, String accessTokenUrl) &#123;</span><br><span class="line">		super(clientId, clientSecret, authorizeUrl, accessTokenUrl);</span><br><span class="line">		setUseParametersForClientAuthentication(true);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	protected AccessGrant postForAccessGrant(String accessTokenUrl, MultiValueMap&lt;String, String&gt; parameters) &#123;</span><br><span class="line">		String responseStr = getRestTemplate().postForObject(accessTokenUrl, parameters, String.class);</span><br><span class="line"></span><br><span class="line">		logger.info(&quot;获取accessToke的响应：&quot;+responseStr);</span><br><span class="line"></span><br><span class="line">		String[] items = StringUtils.splitByWholeSeparatorPreserveAllTokens(responseStr, &quot;&amp;&quot;);</span><br><span class="line"></span><br><span class="line">		String accessToken = StringUtils.substringAfterLast(items[0], &quot;=&quot;);</span><br><span class="line">		Long expiresIn = new Long(StringUtils.substringAfterLast(items[1], &quot;=&quot;));</span><br><span class="line">		String refreshToken = StringUtils.substringAfterLast(items[2], &quot;=&quot;);</span><br><span class="line"></span><br><span class="line">		return new AccessGrant(accessToken, null, refreshToken, expiresIn);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	protected RestTemplate createRestTemplate() &#123;</span><br><span class="line">		RestTemplate restTemplate = super.createRestTemplate();</span><br><span class="line">		restTemplate.getMessageConverters().add(new StringHttpMessageConverter(Charset.forName(&quot;UTF-8&quot;)));</span><br><span class="line">		return restTemplate;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public class QQServiceProvider extends AbstractOAuth2ServiceProvider&lt;QQ&gt; &#123;</span><br><span class="line">	private String appId;</span><br><span class="line"></span><br><span class="line">	private static final String URL_AUTHORIZE = &quot;https://graph.qq.com/oauth2.0/authorize&quot;;</span><br><span class="line"></span><br><span class="line">	private static final String URL_ACCESS_TOKEN = &quot;https://graph.qq.com/oauth2.0/token&quot;;</span><br><span class="line"></span><br><span class="line">	public QQServiceProvider(String appId, String appSecret) &#123;</span><br><span class="line">		super(new QQOAuth2Template(appId, appSecret, URL_AUTHORIZE, URL_ACCESS_TOKEN));</span><br><span class="line">		this.appId = appId;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public QQ getApi(String accessToken) &#123;</span><br><span class="line">		return new QQImpl(accessToken, appId);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public class QQAdapter implements ApiAdapter&lt;QQ&gt; &#123;</span><br><span class="line">	@Override</span><br><span class="line">	public boolean test(QQ api) &#123;</span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void setConnectionValues(QQ api, ConnectionValues values) &#123;</span><br><span class="line">		QQUserInfo userInfo = api.getUserInfo();</span><br><span class="line"></span><br><span class="line">		values.setDisplayName(userInfo.getNickname());</span><br><span class="line">		values.setImageUrl(userInfo.getFigureurl_qq_1());</span><br><span class="line">		values.setProfileUrl(null);</span><br><span class="line">		values.setProviderUserId(userInfo.getOpenId());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public UserProfile fetchUserProfile(QQ api) &#123;</span><br><span class="line">		// TODO Auto-generated method stub</span><br><span class="line">		return null;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void updateStatus(QQ api, String message) &#123;</span><br><span class="line">		//do noting</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public class QQConnectionFactory extends OAuth2ConnectionFactory&lt;QQ&gt; &#123;</span><br><span class="line">	public QQConnectionFactory(String providerId, String appId, String appSecret) &#123;</span><br><span class="line">		super(providerId, new QQServiceProvider(appId, appSecret), new QQAdapter());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public class QQProperties extends SocialProperties &#123;</span><br><span class="line">	private String providerId = &quot;qq&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class SocialProperties &#123;</span><br><span class="line">  private String filterProcessesUrl = &quot;/auth&quot;;</span><br><span class="line"></span><br><span class="line">  private QQProperties qq = new QQProperties();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class BrowserProperties &#123;</span><br><span class="line">  ...</span><br><span class="line">  private String signUpUrl = &quot;/my-signUp.html&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">@ConfigurationProperties(prefix = &quot;security&quot;)</span><br><span class="line">public class SecurityProperties &#123;</span><br><span class="line">  ...</span><br><span class="line">  private SocialProperties social = new SocialProperties();</span><br><span class="line">  private BrowserProperties browser = new BrowserProperties();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public class MySpringSocialConfigurer extends SpringSocialConfigurer &#123;</span><br><span class="line">	private String filterProcessesUrl;</span><br><span class="line"></span><br><span class="line">	public MySpringSocialConfigurer(String filterProcessesUrl) &#123;</span><br><span class="line">		this.filterProcessesUrl = filterProcessesUrl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">	@Override</span><br><span class="line">	protected &lt;T&gt; T postProcess(T object) &#123;</span><br><span class="line">		SocialAuthenticationFilter filter = (SocialAuthenticationFilter) super.postProcess(object);</span><br><span class="line">		filter.setFilterProcessesUrl(filterProcessesUrl);</span><br><span class="line">		return (T) filter;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@EnableSocial</span><br><span class="line">public class SocialConfig extends SocialConfigurerAdapter &#123;</span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">	private DataSource dataSource;</span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">	private SecurityProperties securityProperties;</span><br><span class="line"></span><br><span class="line">	@Autowired(required = false)</span><br><span class="line">	private ConnectionSignUp connectionSignUp;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public UsersConnectionRepository getUsersConnectionRepository(ConnectionFactoryLocator connectionFactoryLocator) &#123;</span><br><span class="line">		JdbcUsersConnectionRepository repository = new JdbcUsersConnectionRepository(dataSource,</span><br><span class="line">				connectionFactoryLocator, Encryptors.noOpText());</span><br><span class="line">		repository.setTablePrefix(&quot;my_&quot;);</span><br><span class="line">		if(connectionSignUp != null) &#123;</span><br><span class="line">			repository.setConnectionSignUp(connectionSignUp);</span><br><span class="line">		&#125;</span><br><span class="line">		return repository;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Bean</span><br><span class="line">	public SpringSocialConfigurer mySocialSecurityConfig() &#123;</span><br><span class="line">		String filterProcessesUrl = securityProperties.getSocial().getFilterProcessesUrl();</span><br><span class="line">		MySpringSocialConfigurer configurer = new MySpringSocialConfigurer(filterProcessesUrl);</span><br><span class="line">		configurer.signupUrl(securityProperties.getBrowser().getSignUpUrl());</span><br><span class="line">		return configurer;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Bean</span><br><span class="line">	public ProviderSignInUtils providerSignInUtils(ConnectionFactoryLocator connectionFactoryLocator) &#123;</span><br><span class="line">		return new ProviderSignInUtils(connectionFactoryLocator,</span><br><span class="line">				getUsersConnectionRepository(connectionFactoryLocator)) &#123;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>org/springframework/social/spring-social-core/1.1.4.RELEASE/spring-social-core-1.1.4.RELEASE.jar!/org/springframework/social/connect/jdbc/JdbcUsersConnectionRepository.sql:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">create table UserConnection (userId varchar(255) not null,</span><br><span class="line">	providerId varchar(255) not null,</span><br><span class="line">	providerUserId varchar(255),</span><br><span class="line">	rank int not null,</span><br><span class="line">	displayName varchar(255),</span><br><span class="line">	profileUrl varchar(512),</span><br><span class="line">	imageUrl varchar(512),</span><br><span class="line">	accessToken varchar(512) not null,</span><br><span class="line">	secret varchar(512),</span><br><span class="line">	refreshToken varchar(512),</span><br><span class="line">	expireTime bigint,</span><br><span class="line">	primary key (userId, providerId, providerUserId));</span><br><span class="line">create unique index UserConnectionRank on UserConnection(userId, providerId, rank);</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@ConditionalOnProperty(prefix = &quot;security.social.qq&quot;, name = &quot;app-id&quot;)</span><br><span class="line">public class QQAutoConfig extends SocialAutoConfigurerAdapter &#123;</span><br><span class="line">	@Autowired</span><br><span class="line">	private SecurityProperties securityProperties;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	protected ConnectionFactory&lt;?&gt; createConnectionFactory() &#123;</span><br><span class="line">		QQProperties qqConfig = securityProperties.getSocial().getQq();</span><br><span class="line">		return new QQConnectionFactory(qqConfig.getProviderId(), qqConfig.getAppId(), qqConfig.getAppSecret());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>spring-browser:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class BrowserSecurityConfig extends AbstractChannelSecurityConfig &#123;</span><br><span class="line">  ...</span><br><span class="line">  @Autowired</span><br><span class="line">  private SpringSocialConfigurer mySocialSecurityConfig;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">	protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line">      http.apply(mySocialSecurityConfig)</span><br><span class="line">          .and()</span><br><span class="line">          .authorizeRequests()</span><br><span class="line">          .antMatchers(</span><br><span class="line">            securityProperties.getBrowser().getSignUpUrl(),</span><br><span class="line">            &quot;/user/regist&quot;</span><br><span class="line">          )</span><br><span class="line">          .permitAll()</span><br><span class="line">          ...</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class SocialUserInfo &#123;</span><br><span class="line">	private String providerId;</span><br><span class="line"></span><br><span class="line">	private String providerUserId;</span><br><span class="line"></span><br><span class="line">	private String nickname;</span><br><span class="line"></span><br><span class="line">	private String headimg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class BrowserSecurityController &#123;</span><br><span class="line">	@Autowired</span><br><span class="line">	private ProviderSignInUtils providerSignInUtils;</span><br><span class="line"></span><br><span class="line">	@GetMapping(&quot;/social/user&quot;)</span><br><span class="line">	public SocialUserInfo getSocialUserInfo(HttpServletRequest request) &#123;</span><br><span class="line">		SocialUserInfo userInfo = new SocialUserInfo();</span><br><span class="line">		Connection&lt;?&gt; connection = providerSignInUtils.getConnectionFromSession(new ServletWebRequest(request));</span><br><span class="line">		userInfo.setProviderId(connection.getKey().getProviderId());</span><br><span class="line">		userInfo.setProviderUserId(connection.getKey().getProviderUserId());</span><br><span class="line">		userInfo.setNickname(connection.getDisplayName());</span><br><span class="line">		userInfo.setHeadimg(connection.getImageUrl());</span><br><span class="line">		return userInfo;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>my-signIn.html<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">&lt;title&gt;登录&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;h3&gt;社交登录&lt;/h3&gt;</span><br><span class="line">  &lt;a href=&quot;/qqLogin/callback.do&quot;&gt;QQ登录&lt;/a&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>spring-demo:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class DemoConnectionSignUp implements ConnectionSignUp &#123;</span><br><span class="line">	@Override</span><br><span class="line">	public String execute(Connection&lt;?&gt; connection) &#123;</span><br><span class="line">		//根据社交用户信息默认创建用户并返回用户唯一标识</span><br><span class="line">		return connection.getDisplayName();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class MyUserDetailsService implements UserDetailsService, SocialUserDetailsService &#123;</span><br><span class="line">	private Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">	private PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123;</span><br><span class="line">		logger.info(&quot;表单登录用户名:&quot; + username);</span><br><span class="line">		return buildUser(username);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public SocialUserDetails loadUserByUserId(String userId) throws UsernameNotFoundException &#123;</span><br><span class="line">		logger.info(&quot;设计登录用户Id:&quot; + userId);</span><br><span class="line">		return buildUser(userId);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	private SocialUserDetails buildUser(String userId) &#123;</span><br><span class="line">		// 根据用户名查找用户信息</span><br><span class="line">		//根据查找到的用户信息判断用户是否被冻结</span><br><span class="line">		String password = passwordEncoder.encode(&quot;123456&quot;);</span><br><span class="line">		logger.info(&quot;数据库密码是:&quot;+password);</span><br><span class="line">		return new SocialUser(userId, password,</span><br><span class="line">				true, true, true, true,</span><br><span class="line">				AuthorityUtils.commaSeparatedStringToAuthorityList(&quot;admin&quot;));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/user&quot;)</span><br><span class="line">public class UserController &#123;</span><br><span class="line">  @Autowired</span><br><span class="line">  private ProviderSignInUtils providerSignInUtils;</span><br><span class="line"></span><br><span class="line">  @PostMapping(&quot;/regist&quot;)</span><br><span class="line">  public void regist(User user, HttpServletRequest request) &#123;</span><br><span class="line"></span><br><span class="line">    //不管是注册用户还是绑定用户，都会拿到一个用户唯一标识。</span><br><span class="line">    String userId = user.getUsername();</span><br><span class="line">    providerSignInUtils.doPostSignUp(userId, new ServletWebRequest(request));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="assets/SpringSecurity技术栈开发企业级认证与授权/46.jpg" alt="46"><br>application.properties:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">security.social.qq.app-id =</span><br><span class="line">security.social.qq.app-secret =</span><br><span class="line">security.social.qq.providerId = callback.do</span><br><span class="line"></span><br><span class="line">security.browser.signUpUrl = /demo-signUp.html</span><br><span class="line"></span><br><span class="line">security.social.filterProcessesUrl = /qqLogin</span><br></pre></td></tr></table></figure></p>
<p>demo-signUp.html:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">&lt;title&gt;登录&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">	&lt;h2&gt;Demo注册页&lt;/h2&gt;</span><br><span class="line"></span><br><span class="line">	&lt;form action=&quot;/user/regist&quot; method=&quot;post&quot;&gt;</span><br><span class="line">		&lt;table&gt;</span><br><span class="line">			&lt;tr&gt;</span><br><span class="line">				&lt;td&gt;用户名:&lt;/td&gt;</span><br><span class="line">				&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;username&quot;&gt;&lt;/td&gt;</span><br><span class="line">			&lt;/tr&gt;</span><br><span class="line">			&lt;tr&gt;</span><br><span class="line">				&lt;td&gt;密码:&lt;/td&gt;</span><br><span class="line">				&lt;td&gt;&lt;input type=&quot;password&quot; name=&quot;password&quot;&gt;&lt;/td&gt;</span><br><span class="line">			&lt;/tr&gt;</span><br><span class="line">			&lt;tr&gt;</span><br><span class="line">				&lt;td colspan=&quot;2&quot;&gt;</span><br><span class="line">					&lt;button type=&quot;submit&quot; name=&quot;type&quot; value=&quot;regist&quot;&gt;注册&lt;/button&gt;</span><br><span class="line">					&lt;button type=&quot;submit&quot; name=&quot;type&quot; value=&quot;binding&quot;&gt;绑定&lt;/button&gt;</span><br><span class="line">				&lt;/td&gt;</span><br><span class="line">			&lt;/tr&gt;</span><br><span class="line">		&lt;/table&gt;</span><br><span class="line">	&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="微信认证"><a href="#微信认证" class="headerlink" title="微信认证"></a>微信认证</h3><p>spring-core:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class WeixinUserInfo &#123;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 普通用户的标识，对当前开发者帐号唯一</span><br><span class="line">	 */</span><br><span class="line">	private String openid;</span><br><span class="line">	/**</span><br><span class="line">	 * 普通用户昵称</span><br><span class="line">	 */</span><br><span class="line">	private String nickname;</span><br><span class="line">	/**</span><br><span class="line">	 * 语言</span><br><span class="line">	 */</span><br><span class="line">	private String language;</span><br><span class="line">	/**</span><br><span class="line">	 * 普通用户性别，1为男性，2为女性</span><br><span class="line">	 */</span><br><span class="line">	private String sex;</span><br><span class="line">	/**</span><br><span class="line">	 * 普通用户个人资料填写的省份</span><br><span class="line">	 */</span><br><span class="line">	private String province;</span><br><span class="line">	/**</span><br><span class="line">	 * 普通用户个人资料填写的城市</span><br><span class="line">	 */</span><br><span class="line">	private String city;</span><br><span class="line">	/**</span><br><span class="line">	 * 国家，如中国为CN</span><br><span class="line">	 */</span><br><span class="line">	private String country;</span><br><span class="line">	/**</span><br><span class="line">	 * 用户头像，最后一个数值代表正方形头像大小（有0、46、64、96、132数值可选，0代表640*640正方形头像），用户没有头像时该项为空</span><br><span class="line">	 */</span><br><span class="line">	private String headimgurl;</span><br><span class="line">	/**</span><br><span class="line">	 * 用户特权信息，json数组，如微信沃卡用户为（chinaunicom）</span><br><span class="line">	 */</span><br><span class="line">	private String[] privilege;</span><br><span class="line">	/**</span><br><span class="line">	 * 用户统一标识。针对一个微信开放平台帐号下的应用，同一用户的unionid是唯一的。</span><br><span class="line">	 */</span><br><span class="line">	private String unionid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface Weixin &#123;</span><br><span class="line">	WeixinUserInfo getUserInfo(String openId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Weixin API调用模板， scope为Request的Spring bean, 根据当前用户的accessToken创建。</span><br><span class="line"> */</span><br><span class="line">public class WeixinImpl extends AbstractOAuth2ApiBinding implements Weixin &#123;</span><br><span class="line">	/**</span><br><span class="line">	 *</span><br><span class="line">	 */</span><br><span class="line">	private ObjectMapper objectMapper = new ObjectMapper();</span><br><span class="line">	/**</span><br><span class="line">	 * 获取用户信息的url</span><br><span class="line">	 */</span><br><span class="line">	private static final String URL_GET_USER_INFO = &quot;https://api.weixin.qq.com/sns/userinfo?openid=&quot;;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * @param accessToken</span><br><span class="line">	 */</span><br><span class="line">	public WeixinImpl(String accessToken) &#123;</span><br><span class="line">		super(accessToken, TokenStrategy.ACCESS_TOKEN_PARAMETER);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 默认注册的StringHttpMessageConverter字符集为ISO-8859-1，而微信返回的是UTF-8的，所以覆盖了原来的方法。</span><br><span class="line">	 */</span><br><span class="line">	protected List&lt;HttpMessageConverter&lt;?&gt;&gt; getMessageConverters() &#123;</span><br><span class="line">		List&lt;HttpMessageConverter&lt;?&gt;&gt; messageConverters = super.getMessageConverters();</span><br><span class="line">		messageConverters.remove(0);</span><br><span class="line">		messageConverters.add(new StringHttpMessageConverter(Charset.forName(&quot;UTF-8&quot;)));</span><br><span class="line">		return messageConverters;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 获取微信用户信息。</span><br><span class="line">	 */</span><br><span class="line">	@Override</span><br><span class="line">	public WeixinUserInfo getUserInfo(String openId) &#123;</span><br><span class="line">		String url = URL_GET_USER_INFO + openId;</span><br><span class="line">		String response = getRestTemplate().getForObject(url, String.class);</span><br><span class="line">		if(StringUtils.contains(response, &quot;errcode&quot;)) &#123;</span><br><span class="line">			return null;</span><br><span class="line">		&#125;</span><br><span class="line">		WeixinUserInfo profile = null;</span><br><span class="line">		try &#123;</span><br><span class="line">			profile = objectMapper.readValue(response, WeixinUserInfo.class);</span><br><span class="line">		&#125; catch (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		return profile;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class WeixinProperties extends SocialProperties &#123;</span><br><span class="line">	/**</span><br><span class="line">	 * 第三方id，用来决定发起第三方登录的url，默认是 weixin。</span><br><span class="line">	 */</span><br><span class="line">	private String providerId = &quot;weixin&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class SocialProperties &#123;</span><br><span class="line">  private String filterProcessesUrl = &quot;/auth&quot;;</span><br><span class="line">  ...</span><br><span class="line">  private WeixinProperties weixin = new WeixinProperties();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 微信的access_token信息。与标准OAuth2协议不同，微信在获取access_token时会同时返回openId,并没有单独的通过accessToke换取openId的服务</span><br><span class="line"> *</span><br><span class="line"> * 所以在这里继承了标准AccessGrant，添加了openId字段，作为对微信access_token信息的封装。</span><br><span class="line"> */</span><br><span class="line">@Data</span><br><span class="line">public class WeixinAccessGrant extends AccessGrant &#123;</span><br><span class="line">	private static final long serialVersionUID = -7243374526633186782L;</span><br><span class="line"></span><br><span class="line">	private String openId;</span><br><span class="line"></span><br><span class="line">	public WeixinAccessGrant() &#123;</span><br><span class="line">		super(&quot;&quot;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public WeixinAccessGrant(String accessToken, String scope, String refreshToken, Long expiresIn) &#123;</span><br><span class="line">		super(accessToken, scope, refreshToken, expiresIn);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 完成微信的OAuth2认证流程的模板类。国内厂商实现的OAuth2每个都不同, spring默认提供的OAuth2Template适应不了，只能针对每个厂商自己微调。</span><br><span class="line"> */</span><br><span class="line">public class WeixinOAuth2Template extends OAuth2Template &#123;</span><br><span class="line">	private String clientId;</span><br><span class="line"></span><br><span class="line">	private String clientSecret;</span><br><span class="line"></span><br><span class="line">	private String accessTokenUrl;</span><br><span class="line"></span><br><span class="line">	private static final String REFRESH_TOKEN_URL = &quot;https://api.weixin.qq.com/sns/oauth2/refresh_token&quot;;</span><br><span class="line"></span><br><span class="line">	private Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">	public WeixinOAuth2Template(String clientId, String clientSecret, String authorizeUrl, String accessTokenUrl) &#123;</span><br><span class="line">		super(clientId, clientSecret, authorizeUrl, accessTokenUrl);</span><br><span class="line">		setUseParametersForClientAuthentication(true);</span><br><span class="line">		this.clientId = clientId;</span><br><span class="line">		this.clientSecret = clientSecret;</span><br><span class="line">		this.accessTokenUrl = accessTokenUrl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public AccessGrant exchangeForAccess(String authorizationCode, String redirectUri,</span><br><span class="line">			MultiValueMap&lt;String, String&gt; parameters) &#123;</span><br><span class="line"></span><br><span class="line">		StringBuilder accessTokenRequestUrl = new StringBuilder(accessTokenUrl);</span><br><span class="line"></span><br><span class="line">		accessTokenRequestUrl.append(&quot;?appid=&quot;+clientId);</span><br><span class="line">		accessTokenRequestUrl.append(&quot;&amp;secret=&quot;+clientSecret);</span><br><span class="line">		accessTokenRequestUrl.append(&quot;&amp;code=&quot;+authorizationCode);</span><br><span class="line">		accessTokenRequestUrl.append(&quot;&amp;grant_type=authorization_code&quot;);</span><br><span class="line">		accessTokenRequestUrl.append(&quot;&amp;redirect_uri=&quot;+redirectUri);</span><br><span class="line"></span><br><span class="line">		return getAccessToken(accessTokenRequestUrl);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public AccessGrant refreshAccess(String refreshToken, MultiValueMap&lt;String, String&gt; additionalParameters) &#123;</span><br><span class="line"></span><br><span class="line">		StringBuilder refreshTokenUrl = new StringBuilder(REFRESH_TOKEN_URL);</span><br><span class="line"></span><br><span class="line">		refreshTokenUrl.append(&quot;?appid=&quot;+clientId);</span><br><span class="line">		refreshTokenUrl.append(&quot;&amp;grant_type=refresh_token&quot;);</span><br><span class="line">		refreshTokenUrl.append(&quot;&amp;refresh_token=&quot;+refreshToken);</span><br><span class="line"></span><br><span class="line">		return getAccessToken(refreshTokenUrl);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">	private AccessGrant getAccessToken(StringBuilder accessTokenRequestUrl) &#123;</span><br><span class="line"></span><br><span class="line">		logger.info(&quot;获取access_token, 请求URL: &quot;+accessTokenRequestUrl.toString());</span><br><span class="line"></span><br><span class="line">		String response = getRestTemplate().getForObject(accessTokenRequestUrl.toString(), String.class);</span><br><span class="line"></span><br><span class="line">		logger.info(&quot;获取access_token, 响应内容: &quot;+response);</span><br><span class="line"></span><br><span class="line">		Map&lt;String, Object&gt; result = null;</span><br><span class="line">		try &#123;</span><br><span class="line">			result = new ObjectMapper().readValue(response, Map.class);</span><br><span class="line">		&#125; catch (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		//返回错误码时直接返回空</span><br><span class="line">		if(StringUtils.isNotBlank(MapUtils.getString(result, &quot;errcode&quot;)))&#123;</span><br><span class="line">			String errcode = MapUtils.getString(result, &quot;errcode&quot;);</span><br><span class="line">			String errmsg = MapUtils.getString(result, &quot;errmsg&quot;);</span><br><span class="line">			throw new RuntimeException(&quot;获取access token失败, errcode:&quot;+errcode+&quot;, errmsg:&quot;+errmsg);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		WeixinAccessGrant accessToken = new WeixinAccessGrant(</span><br><span class="line">				MapUtils.getString(result, &quot;access_token&quot;),</span><br><span class="line">				MapUtils.getString(result, &quot;scope&quot;),</span><br><span class="line">				MapUtils.getString(result, &quot;refresh_token&quot;),</span><br><span class="line">				MapUtils.getLong(result, &quot;expires_in&quot;));</span><br><span class="line"></span><br><span class="line">		accessToken.setOpenId(MapUtils.getString(result, &quot;openid&quot;));</span><br><span class="line"></span><br><span class="line">		return accessToken;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 构建获取授权码的请求。也就是引导用户跳转到微信的地址。</span><br><span class="line">	 */</span><br><span class="line">	public String buildAuthenticateUrl(OAuth2Parameters parameters) &#123;</span><br><span class="line">		String url = super.buildAuthenticateUrl(parameters);</span><br><span class="line">		url = url + &quot;&amp;appid=&quot;+clientId+&quot;&amp;scope=snsapi_login&quot;;</span><br><span class="line">		return url;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public String buildAuthorizeUrl(OAuth2Parameters parameters) &#123;</span><br><span class="line">		return buildAuthenticateUrl(parameters);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 微信返回的contentType是html/text，添加相应的HttpMessageConverter来处理。</span><br><span class="line">	 */</span><br><span class="line">	protected RestTemplate createRestTemplate() &#123;</span><br><span class="line">		RestTemplate restTemplate = super.createRestTemplate();</span><br><span class="line">		restTemplate.getMessageConverters().add(new StringHttpMessageConverter(Charset.forName(&quot;UTF-8&quot;)));</span><br><span class="line">		return restTemplate;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 微信 api适配器，将微信 api的数据模型转为spring social的标准模型。</span><br><span class="line"> */</span><br><span class="line">public class WeixinAdapter implements ApiAdapter&lt;Weixin&gt; &#123;</span><br><span class="line">	private String openId;</span><br><span class="line"></span><br><span class="line">	public WeixinAdapter() &#123;&#125;</span><br><span class="line"></span><br><span class="line">	public WeixinAdapter(String openId)&#123;</span><br><span class="line">		this.openId = openId;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public boolean test(Weixin api) &#123;</span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void setConnectionValues(Weixin api, ConnectionValues values) &#123;</span><br><span class="line">		WeixinUserInfo profile = api.getUserInfo(openId);</span><br><span class="line">		values.setProviderUserId(profile.getOpenid());</span><br><span class="line">		values.setDisplayName(profile.getNickname());</span><br><span class="line">		values.setImageUrl(profile.getHeadimgurl());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public UserProfile fetchUserProfile(Weixin api) &#123;</span><br><span class="line">		return null;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void updateStatus(Weixin api, String message) &#123;</span><br><span class="line">		//do nothing</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 微信的OAuth2流程处理器的提供器，供spring social的connect体系调用</span><br><span class="line"> */</span><br><span class="line">public class WeixinServiceProvider extends AbstractOAuth2ServiceProvider&lt;Weixin&gt; &#123;</span><br><span class="line">	/**</span><br><span class="line">	 * 微信获取授权码的url</span><br><span class="line">	 */</span><br><span class="line">	private static final String URL_AUTHORIZE = &quot;https://open.weixin.qq.com/connect/qrconnect&quot;;</span><br><span class="line">	/**</span><br><span class="line">	 * 微信获取accessToken的url</span><br><span class="line">	 */</span><br><span class="line">	private static final String URL_ACCESS_TOKEN = &quot;https://api.weixin.qq.com/sns/oauth2/access_token&quot;;</span><br><span class="line"></span><br><span class="line">	public WeixinServiceProvider(String appId, String appSecret) &#123;</span><br><span class="line">		super(new WeixinOAuth2Template(appId, appSecret,URL_AUTHORIZE,URL_ACCESS_TOKEN));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public Weixin getApi(String accessToken) &#123;</span><br><span class="line">		return new WeixinImpl(accessToken);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 微信连接工厂</span><br><span class="line"> */</span><br><span class="line">public class WeixinConnectionFactory extends OAuth2ConnectionFactory&lt;Weixin&gt; &#123;</span><br><span class="line"></span><br><span class="line">	public WeixinConnectionFactory(String providerId, String appId, String appSecret) &#123;</span><br><span class="line">		super(providerId, new WeixinServiceProvider(appId, appSecret), new WeixinAdapter());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * 由于微信的openId是和accessToken一起返回的，所以在这里直接根据accessToken设置providerUserId即可，不用像QQ那样通过QQAdapter来获取</span><br><span class="line">	 */</span><br><span class="line">	@Override</span><br><span class="line">	protected String extractProviderUserId(AccessGrant accessGrant) &#123;</span><br><span class="line">		if(accessGrant instanceof WeixinAccessGrant) &#123;</span><br><span class="line">			return ((WeixinAccessGrant)accessGrant).getOpenId();</span><br><span class="line">		&#125;</span><br><span class="line">		return null;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public Connection&lt;Weixin&gt; createConnection(AccessGrant accessGrant) &#123;</span><br><span class="line">		return new OAuth2Connection&lt;Weixin&gt;(getProviderId(), extractProviderUserId(accessGrant), accessGrant.getAccessToken(),</span><br><span class="line">				accessGrant.getRefreshToken(), accessGrant.getExpireTime(), getOAuth2ServiceProvider(), getApiAdapter(extractProviderUserId(accessGrant)));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public Connection&lt;Weixin&gt; createConnection(ConnectionData data) &#123;</span><br><span class="line">		return new OAuth2Connection&lt;Weixin&gt;(data, getOAuth2ServiceProvider(), getApiAdapter(data.getProviderUserId()));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	private ApiAdapter&lt;Weixin&gt; getApiAdapter(String providerUserId) &#123;</span><br><span class="line">		return new WeixinAdapter(providerUserId);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	private OAuth2ServiceProvider&lt;Weixin&gt; getOAuth2ServiceProvider() &#123;</span><br><span class="line">		return (OAuth2ServiceProvider&lt;Weixin&gt;) getServiceProvider();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 微信登录配置</span><br><span class="line"> */</span><br><span class="line">@Configuration</span><br><span class="line">@ConditionalOnProperty(prefix = &quot;security.social.weixin&quot;, name = &quot;app-id&quot;)</span><br><span class="line">public class WeixinAutoConfiguration extends SocialAutoConfigurerAdapter &#123;</span><br><span class="line">	@Autowired</span><br><span class="line">	private SecurityProperties securityProperties;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	protected ConnectionFactory&lt;?&gt; createConnectionFactory() &#123;</span><br><span class="line">		WeixinProperties weixinConfig = securityProperties.getSocial().getWeixin();</span><br><span class="line">		return new WeixinConnectionFactory(weixinConfig.getProviderId(), weixinConfig.getAppId(),</span><br><span class="line">				weixinConfig.getAppSecret());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Bean(&#123;&quot;connect/weixinConnect&quot;, &quot;connect/weixinConnected&quot;&#125;)</span><br><span class="line">	@ConditionalOnMissingBean(name = &quot;weixinConnectedView&quot;)</span><br><span class="line">	public View weixinConnectedView() &#123;</span><br><span class="line">		return new MyConnectView();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public class MyConnectView extends AbstractView &#123;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	protected void renderMergedOutputModel(Map&lt;String, Object&gt; model, HttpServletRequest request,</span><br><span class="line">			HttpServletResponse response) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">		response.setContentType(&quot;text/html;charset=UTF-8&quot;);</span><br><span class="line">		if (model.get(&quot;connection&quot;) == null) &#123;</span><br><span class="line">			response.getWriter().write(&quot;&lt;h3&gt;解绑成功&lt;/h3&gt;&quot;);</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			response.getWriter().write(&quot;&lt;h3&gt;绑定成功&lt;/h3&gt;&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@Component(&quot;connect/status&quot;)</span><br><span class="line">public class MyConnectionStatusView extends AbstractView &#123;</span><br><span class="line">	@Autowired</span><br><span class="line">	private ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">	@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">	@Override</span><br><span class="line">	protected void renderMergedOutputModel(Map&lt;String, Object&gt; model, HttpServletRequest request,</span><br><span class="line">			HttpServletResponse response) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">		Map&lt;String, List&lt;Connection&lt;?&gt;&gt;&gt; connections = (Map&lt;String, List&lt;Connection&lt;?&gt;&gt;&gt;) model.get(&quot;connectionMap&quot;);</span><br><span class="line"></span><br><span class="line">		Map&lt;String, Boolean&gt; result = new HashMap&lt;&gt;();</span><br><span class="line">		for (String key : connections.keySet()) &#123;</span><br><span class="line">			result.put(key, CollectionUtils.isNotEmpty(connections.get(key)));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		response.setContentType(&quot;application/json;charset=UTF-8&quot;);</span><br><span class="line">		response.getWriter().write(objectMapper.writeValueAsString(result));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>spring-browser:<br>my-signIn.html:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">&lt;title&gt;登录&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">...</span><br><span class="line">&lt;a href=&quot;/qqLogin/weixin&quot;&gt;微信登录&lt;/a&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>my-banding.html:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">&lt;title&gt;登录&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">	&lt;h2&gt;标准绑定页面&lt;/h2&gt;</span><br><span class="line">	&lt;form action=&quot;/connect/weixin&quot; method=&quot;post&quot;&gt;</span><br><span class="line">		&lt;button type=&quot;submit&quot;&gt;绑定微信&lt;/button&gt;</span><br><span class="line">	&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>spring-demo:<br>application.properties:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">security.social.weixin.app-id = wxd99431bbff8305a0</span><br><span class="line">security.social.weixin.app-secret = 60f78681d063590a469f1b297feff3c4</span><br></pre></td></tr></table></figure></p>
<h2 id="3-SESSION管理及退出"><a href="#3-SESSION管理及退出" class="headerlink" title="3.SESSION管理及退出"></a>3.SESSION管理及退出</h2><h3 id="Session超时处理"><a href="#Session超时处理" class="headerlink" title="Session超时处理"></a>Session超时处理</h3><h3 id="Session并发控制"><a href="#Session并发控制" class="headerlink" title="Session并发控制"></a>Session并发控制</h3><h3 id="集群Session管理"><a href="#集群Session管理" class="headerlink" title="集群Session管理"></a>集群Session管理</h3>
                    
                        

                    
                    
                        <p>
                            <a href="/2020/04/09/Spring Social开发第三方认证/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2020/04/07/Spring Security技术栈开发企业级认证与授权-使用Spring MVC开发 RESTful API/">
                            SpringSecurity技术栈开发企业级认证与授权-使用Spring MVC开发 RESTful API
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2020-04-07T21:37:40+08:00">
	
		    4月 07, 2020
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="1-开发基本的增删改查接口"><a href="#1-开发基本的增删改查接口" class="headerlink" title="1.开发基本的增删改查接口"></a>1.开发基本的增删改查接口</h2><h3 id="使用Spring-MVC编写Restful-API"><a href="#使用Spring-MVC编写Restful-API" class="headerlink" title="使用Spring MVC编写Restful API"></a>使用Spring MVC编写Restful API</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/1.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/1.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/2.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/2.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h3 id="编写针对RestfulAPI的测试用例"><a href="#编写针对RestfulAPI的测试用例" class="headerlink" title="编写针对RestfulAPI的测试用例"></a>编写针对RestfulAPI的测试用例</h3><p>security-demo：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">@RunWith(SpringRunner.class)</span><br><span class="line">@SpringBootTest</span><br><span class="line">public class UserControllerTest &#123;</span><br><span class="line">	@Autowired</span><br><span class="line">	private WebApplicationContext wac;</span><br><span class="line">	private MockMvc mockMvc;</span><br><span class="line"></span><br><span class="line">	@Before</span><br><span class="line">	public void setup() &#123;</span><br><span class="line">		mockMvc = MockMvcBuilders.webAppContextSetup(wac).build();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Test</span><br><span class="line">	public void whenQuerySuccess() throws Exception &#123;</span><br><span class="line">		String result = mockMvc.perform(</span><br><span class="line">				get(&quot;/user&quot;).param(&quot;username&quot;, &quot;jojo&quot;).param(&quot;age&quot;, &quot;18&quot;).param(&quot;ageTo&quot;, &quot;60&quot;).param(&quot;xxx&quot;, &quot;yyy&quot;)</span><br><span class="line">						// .param(&quot;size&quot;, &quot;15&quot;)</span><br><span class="line">						// .param(&quot;page&quot;, &quot;3&quot;)</span><br><span class="line">						// .param(&quot;sort&quot;, &quot;age,desc&quot;)</span><br><span class="line">						.contentType(MediaType.APPLICATION_JSON_UTF8))</span><br><span class="line">				.andExpect(status().isOk()).andExpect(jsonPath(&quot;$.length()&quot;).value(3))</span><br><span class="line">				.andReturn().getResponse().getContentAsString();</span><br><span class="line"></span><br><span class="line">		System.out.println(result);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Test</span><br><span class="line">	public void whenGetInfoSuccess() throws Exception &#123;</span><br><span class="line">		String result = mockMvc.perform(get(&quot;/user/1&quot;)</span><br><span class="line">				.contentType(MediaType.APPLICATION_JSON_UTF8))</span><br><span class="line">				.andExpect(status().isOk())</span><br><span class="line">				.andExpect(jsonPath(&quot;$.username&quot;).value(&quot;tom&quot;))</span><br><span class="line">				.andReturn().getResponse().getContentAsString();</span><br><span class="line"></span><br><span class="line">		System.out.println(result);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Test</span><br><span class="line">	public void whenGetInfoFail() throws Exception &#123;</span><br><span class="line">		mockMvc.perform(get(&quot;/user/a&quot;)</span><br><span class="line">				.contentType(MediaType.APPLICATION_JSON_UTF8))</span><br><span class="line">				.andExpect(status().is4xxClientError());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Test</span><br><span class="line">	public void whenCreateSuccess() throws Exception &#123;</span><br><span class="line"></span><br><span class="line">		Date date = new Date();</span><br><span class="line">		System.out.println(date.getTime());</span><br><span class="line">		String content = &quot;&#123;\&quot;username\&quot;:\&quot;tom\&quot;,\&quot;password\&quot;:null,\&quot;birthday\&quot;:&quot;+date.getTime()+&quot;&#125;&quot;;</span><br><span class="line">		String reuslt = mockMvc.perform(post(&quot;/user&quot;).contentType(MediaType.APPLICATION_JSON_UTF8)</span><br><span class="line">				.content(content))</span><br><span class="line">				.andExpect(status().isOk())</span><br><span class="line">				.andExpect(jsonPath(&quot;$.id&quot;).value(&quot;1&quot;))</span><br><span class="line">				.andReturn().getResponse().getContentAsString();</span><br><span class="line"></span><br><span class="line">		System.out.println(reuslt);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Test</span><br><span class="line">	public void whenCreateFail() throws Exception &#123;</span><br><span class="line"></span><br><span class="line">		Date date = new Date();</span><br><span class="line">		System.out.println(date.getTime());</span><br><span class="line">		String content = &quot;&#123;\&quot;username\&quot;:\&quot;tom\&quot;,\&quot;password\&quot;:null,\&quot;birthday\&quot;:&quot;+date.getTime()+&quot;&#125;&quot;;</span><br><span class="line">		String reuslt = mockMvc.perform(post(&quot;/user&quot;).contentType(MediaType.APPLICATION_JSON_UTF8)</span><br><span class="line">				.content(content))</span><br><span class="line">//				.andExpect(status().isOk())</span><br><span class="line">//				.andExpect(jsonPath(&quot;$.id&quot;).value(&quot;1&quot;))</span><br><span class="line">				.andReturn().getResponse().getContentAsString();</span><br><span class="line"></span><br><span class="line">		System.out.println(reuslt);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Test</span><br><span class="line">	public void whenUpdateSuccess() throws Exception &#123;</span><br><span class="line"></span><br><span class="line">		Date date = new Date(LocalDateTime.now().plusYears(1).atZone(ZoneId.systemDefault()).toInstant().toEpochMilli());</span><br><span class="line">		System.out.println(date.getTime());</span><br><span class="line">		String content = &quot;&#123;\&quot;id\&quot;:\&quot;1\&quot;, \&quot;username\&quot;:\&quot;tom\&quot;,\&quot;password\&quot;:null,\&quot;birthday\&quot;:&quot;+date.getTime()+&quot;&#125;&quot;;</span><br><span class="line">		String reuslt = mockMvc.perform(put(&quot;/user/1&quot;).contentType(MediaType.APPLICATION_JSON_UTF8)</span><br><span class="line">				.content(content))</span><br><span class="line">				.andExpect(status().isOk())</span><br><span class="line">				.andExpect(jsonPath(&quot;$.id&quot;).value(&quot;1&quot;))</span><br><span class="line">				.andReturn().getResponse().getContentAsString();</span><br><span class="line"></span><br><span class="line">		System.out.println(reuslt);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Test</span><br><span class="line">	public void whenDeleteSuccess() throws Exception &#123;</span><br><span class="line">		mockMvc.perform(delete(&quot;/user/1&quot;)</span><br><span class="line">				.contentType(MediaType.APPLICATION_JSON_UTF8))</span><br><span class="line">				.andExpect(status().isOk());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class User &#123;</span><br><span class="line">	private String id;</span><br><span class="line">	private String username;</span><br><span class="line">	private String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="在url声明中使用正则表达式-amp-PageableDefault指定分页参数默认值"><a href="#在url声明中使用正则表达式-amp-PageableDefault指定分页参数默认值" class="headerlink" title="在url声明中使用正则表达式 &amp; @PageableDefault指定分页参数默认值"></a>在url声明中使用正则表达式 &amp; @PageableDefault指定分页参数默认值</h3><p>security-demo：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/user&quot;)</span><br><span class="line">public class UserController &#123;</span><br><span class="line">	@GetMapping</span><br><span class="line">	@JsonView(User.UserSimpleView.class)</span><br><span class="line">	public List&lt;User&gt; query(</span><br><span class="line">			@PageableDefault(page = 2, size = 17, sort = &quot;username,asc&quot;) Pageable pageable) &#123;</span><br><span class="line">		List&lt;User&gt; users = new ArrayList&lt;&gt;();</span><br><span class="line">		users.add(new User());</span><br><span class="line">		users.add(new User());</span><br><span class="line">		users.add(new User());</span><br><span class="line">		return users;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@GetMapping(&quot;/&#123;id:\\d+&#125;&quot;)</span><br><span class="line">	@JsonView(User.UserDetailView.class)</span><br><span class="line">	public User getInfo(@PathVariable String id) &#123;</span><br><span class="line">		User user = new User();</span><br><span class="line">		user.setUsername(&quot;tom&quot;);</span><br><span class="line">		return user;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="JsonView控制json输出内容"><a href="#JsonView控制json输出内容" class="headerlink" title="@JsonView控制json输出内容"></a>@JsonView控制json输出内容</h3><p>1.使用接口来声明多个视图<br>2.在值对象的get方法上指定视图<br>3.在Controller方法上指定视图<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@Setter</span><br><span class="line">public class User &#123;</span><br><span class="line">	public interface UserSimpleView &#123;&#125;;</span><br><span class="line">	public interface UserDetailView extends UserSimpleView &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	private String id;</span><br><span class="line">	private String username;</span><br><span class="line">	private String password;</span><br><span class="line"></span><br><span class="line">	@JsonView(UserSimpleView.class)</span><br><span class="line">	public String getUsername() &#123;</span><br><span class="line">		return username;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@JsonView(UserDetailView.class)</span><br><span class="line">	public String getPassword() &#123;</span><br><span class="line">		return password;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@JsonView(UserSimpleView.class)</span><br><span class="line">	public String getId() &#123;</span><br><span class="line">		return id;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;/&#123;id:\\d+&#125;&quot;)</span><br><span class="line">@JsonView(User.UserDetailView.class)</span><br><span class="line">public User getInfo(@PathVariable String id) &#123;</span><br><span class="line">  User user = new User();</span><br><span class="line">  user.setUsername(&quot;tom&quot;);</span><br><span class="line">  return user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Valid注解和BindingResult验证请求参数的合法性并处理校验结果"><a href="#Valid注解和BindingResult验证请求参数的合法性并处理校验结果" class="headerlink" title="@Valid注解和BindingResult验证请求参数的合法性并处理校验结果"></a>@Valid注解和BindingResult验证请求参数的合法性并处理校验结果</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/3.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/3.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping</span><br><span class="line">public User create(@Valid @RequestBody User user) &#123;</span><br><span class="line">  user.setId(&quot;1&quot;);</span><br><span class="line">  return user;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@PutMapping(&quot;/&#123;id:\\d+&#125;&quot;)</span><br><span class="line">public User update(@Valid @RequestBody User user, BindingResult errors) &#123;</span><br><span class="line">  user.setId(&quot;1&quot;);</span><br><span class="line">  return user;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@DeleteMapping(&quot;/&#123;id:\\d+&#125;&quot;)</span><br><span class="line">public void delete(@PathVariable String id) &#123;</span><br><span class="line">  System.out.println(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">@Setter</span><br><span class="line">public class User &#123;</span><br><span class="line">	public interface UserSimpleView &#123;&#125;;</span><br><span class="line">	public interface UserDetailView extends UserSimpleView &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	private String id;</span><br><span class="line">	private String username;</span><br><span class="line"></span><br><span class="line">	@NotBlank(message = &quot;密码不能为空&quot;)</span><br><span class="line">	private String password;</span><br><span class="line"></span><br><span class="line">	@JsonView(UserSimpleView.class)</span><br><span class="line">	public String getUsername() &#123;</span><br><span class="line">		return username;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@JsonView(UserDetailView.class)</span><br><span class="line">	public String getPassword() &#123;</span><br><span class="line">		return password;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@JsonView(UserSimpleView.class)</span><br><span class="line">	public String getId() &#123;</span><br><span class="line">		return id;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="自定义Validator"><a href="#自定义Validator" class="headerlink" title="自定义Validator"></a>自定义Validator</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Target(&#123;ElementType.METHOD, ElementType.FIELD&#125;)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Constraint(validatedBy = MyConstraintValidator.class)</span><br><span class="line">public @interface MyConstraint &#123;</span><br><span class="line">	String message();</span><br><span class="line">	Class&lt;?&gt;[] groups() default &#123; &#125;;</span><br><span class="line">	Class&lt;? extends Payload&gt;[] payload() default &#123; &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public class MyConstraintValidator implements ConstraintValidator&lt;MyConstraint, Object&gt; &#123;</span><br><span class="line">	@Override</span><br><span class="line">	public void initialize(MyConstraint constraintAnnotation) &#123;</span><br><span class="line">		System.out.println(&quot;my validator init&quot;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public boolean isValid(Object value, ConstraintValidatorContext context) &#123;</span><br><span class="line">    System.out.println(&quot;my validator valid&quot;);</span><br><span class="line">		System.out.println(value);</span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public class User &#123;</span><br><span class="line">  @MyConstraint(message = &quot;这是一个测试&quot;)</span><br><span class="line">  private String username;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="文件上传下载"><a href="#文件上传下载" class="headerlink" title="文件上传下载"></a>文件上传下载</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void whenUploadSuccess() throws Exception &#123;</span><br><span class="line">	String result = mockMvc.perform(fileUpload(&quot;/file&quot;)</span><br><span class="line">			.file(new MockMultipartFile(&quot;file&quot;, &quot;test.txt&quot;, &quot;multipart/form-data&quot;, &quot;hello upload&quot;.getBytes(&quot;UTF-8&quot;))))</span><br><span class="line">			.andExpect(status().isOk())</span><br><span class="line">			.andReturn().getResponse().getContentAsString();</span><br><span class="line">	System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/file&quot;)</span><br><span class="line">public class FileController &#123;</span><br><span class="line">	private String folder = &quot;/Users/path&quot;;</span><br><span class="line"></span><br><span class="line">	@PostMapping</span><br><span class="line">	public FileInfo upload(MultipartFile file) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">		System.out.println(file.getName());</span><br><span class="line">		System.out.println(file.getOriginalFilename());</span><br><span class="line">		System.out.println(file.getSize());</span><br><span class="line"></span><br><span class="line">		File localFile = new File(folder, new Date().getTime() + &quot;.txt&quot;);</span><br><span class="line">		file.transferTo(localFile);</span><br><span class="line"></span><br><span class="line">		return new FileInfo(localFile.getAbsolutePath());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br><span class="line">	public void download(@PathVariable String id, HttpServletRequest request, HttpServletResponse response) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">		try (InputStream inputStream = new FileInputStream(new File(folder, id + &quot;.txt&quot;));</span><br><span class="line">				OutputStream outputStream = response.getOutputStream();) &#123;</span><br><span class="line"></span><br><span class="line">			response.setContentType(&quot;application/x-download&quot;);</span><br><span class="line">			response.addHeader(&quot;Content-Disposition&quot;, &quot;attachment;filename=test.txt&quot;);</span><br><span class="line"></span><br><span class="line">			IOUtils.copy(inputStream, outputStream);</span><br><span class="line">			outputStream.flush();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">@AllArgsConstructor</span><br><span class="line">public class FileInfo &#123;</span><br><span class="line">	private String path;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="异步处理REST服务"><a href="#异步处理REST服务" class="headerlink" title="异步处理REST服务"></a>异步处理REST服务</h3><p>使用Runnable异步处理：<br><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/7.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/7.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class AsyncController &#123;</span><br><span class="line">	@RequestMapping(&quot;/order&quot;)</span><br><span class="line">	public void order() throws Exception &#123;</span><br><span class="line">		logger.info(&quot;主线程开始&quot;);</span><br><span class="line"></span><br><span class="line">		Callable&lt;String&gt; result = new Callable&lt;String&gt;() &#123;</span><br><span class="line">			@Override</span><br><span class="line">			public String call() throws Exception &#123;</span><br><span class="line">				logger.info(&quot;副线程开始&quot;);</span><br><span class="line">				Thread.sleep(1000);</span><br><span class="line">				logger.info(&quot;副线程返回&quot;);</span><br><span class="line">				return &quot;success&quot;;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用DeferredResult异步处理REST服务：<br><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/8.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/8.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class AsyncController &#123;</span><br><span class="line">	@Autowired</span><br><span class="line">	private MockQueue mockQueue;</span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">	private DeferredResultHolder deferredResultHolder;</span><br><span class="line"></span><br><span class="line">	private Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">	@RequestMapping(&quot;/order&quot;)</span><br><span class="line">	public DeferredResult&lt;String&gt; order() throws Exception &#123;</span><br><span class="line">		logger.info(&quot;主线程开始&quot;);</span><br><span class="line"></span><br><span class="line">		String orderNumber = RandomStringUtils.randomNumeric(8);</span><br><span class="line">		mockQueue.setPlaceOrder(orderNumber);</span><br><span class="line"></span><br><span class="line">		DeferredResult&lt;String&gt; result = new DeferredResult&lt;&gt;();</span><br><span class="line">		deferredResultHolder.getMap().put(orderNumber, result);</span><br><span class="line"></span><br><span class="line">		return result;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class DeferredResultHolder &#123;</span><br><span class="line">	private Map&lt;String, DeferredResult&lt;String&gt;&gt; map = new HashMap&lt;String, DeferredResult&lt;String&gt;&gt;();</span><br><span class="line"></span><br><span class="line">	public Map&lt;String, DeferredResult&lt;String&gt;&gt; getMap() &#123;</span><br><span class="line">		return map;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void setMap(Map&lt;String, DeferredResult&lt;String&gt;&gt; map) &#123;</span><br><span class="line">		this.map = map;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class MockQueue &#123;</span><br><span class="line">	private String placeOrder;</span><br><span class="line">	private String completeOrder;</span><br><span class="line">	private Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">	public String getPlaceOrder() &#123;</span><br><span class="line">		return placeOrder;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void setPlaceOrder(String placeOrder) throws Exception &#123;</span><br><span class="line">		new Thread(() -&gt; &#123;</span><br><span class="line">			logger.info(&quot;接到下单请求, &quot; + placeOrder);</span><br><span class="line">			try &#123;</span><br><span class="line">				Thread.sleep(1000);</span><br><span class="line">			&#125; catch (Exception e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">			this.completeOrder = placeOrder;</span><br><span class="line">			logger.info(&quot;下单请求处理完毕,&quot; + placeOrder);</span><br><span class="line">		&#125;).start();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public String getCompleteOrder() &#123;</span><br><span class="line">		return completeOrder;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void setCompleteOrder(String completeOrder) &#123;</span><br><span class="line">		this.completeOrder = completeOrder;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-Spring-MVC-高级特性"><a href="#2-Spring-MVC-高级特性" class="headerlink" title="2.Spring MVC 高级特性"></a>2.Spring MVC 高级特性</h2><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/4.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/4.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/5.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/5.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/6.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/6.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<h2 id="3-REST服务开发常用工具"><a href="#3-REST服务开发常用工具" class="headerlink" title="3.REST服务开发常用工具"></a>3.REST服务开发常用工具</h2><h3 id="使用swagger自动生成html文档"><a href="#使用swagger自动生成html文档" class="headerlink" title="使用swagger自动生成html文档"></a>使用swagger自动生成html文档</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;io.springfox&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;springfox-swagger2&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;2.7.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;io.springfox&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;springfox-swagger-ui&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;2.7.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@EnableSwagger2</span><br><span class="line">@ApiModelProperty</span><br><span class="line">@ApiOperation</span><br><span class="line">@ApiParam</span><br></pre></td></tr></table></figure>
<h3 id="使用WireMock快速伪造RESTful服务"><a href="#使用WireMock快速伪造RESTful服务" class="headerlink" title="使用WireMock快速伪造RESTful服务"></a>使用WireMock快速伪造RESTful服务</h3><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/9.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/9.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/10.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/10.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar wiremock-standalone-2.7.1.jar --port 8062</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;com.github.tomakehurst&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;wiremock&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public class MockServer &#123;</span><br><span class="line">	public static void main(String[] args) throws IOException &#123;</span><br><span class="line">		configureFor(8062);</span><br><span class="line">		removeAllMappings();</span><br><span class="line"></span><br><span class="line">		mock(&quot;/order/1&quot;, &quot;01&quot;);</span><br><span class="line">		mock(&quot;/order/2&quot;, &quot;02&quot;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	private static void mock(String url, String file) throws IOException &#123;</span><br><span class="line">		ClassPathResource resource = new ClassPathResource(&quot;mock/response/&quot; + file + &quot;.txt&quot;);</span><br><span class="line">		String content = StringUtils.join(FileUtils.readLines(resource.getFile(), &quot;UTF-8&quot;).toArray(), &quot;\n&quot;);</span><br><span class="line">		stubFor(get(urlPathEqualTo(url)).willReturn(aResponse().withBody(content).withStatus(200)));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

                    
                        

                    
                    
                        <p>
                            <a href="/2020/04/07/Spring Security技术栈开发企业级认证与授权-使用Spring MVC开发 RESTful API/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2020/04/07/Spring Security技术栈开发企业级认证与授权-认证流程源码级详解/">
                            SpringSecurity技术栈开发企业级认证与授权-认证流程源码级详解
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2020-04-07T21:37:40+08:00">
	
		    4月 07, 2020
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="1-认证处理流程说明"><a href="#1-认证处理流程说明" class="headerlink" title="1.认证处理流程说明"></a>1.认证处理流程说明</h2><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/21.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/21.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/22.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/22.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken(username, password);</span><br></pre></td></tr></table></figure>
<p>获取请求中携带的用户名和密码，然后拿用户名和密码构建了一个UsernamePasswordAuthenticationToken这样一个对象。</p>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/23.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/23.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/24.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/24.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<p>该对象是Authentication接口的实现，该接口实际上封装了我们的认证信息。<br>通过该类构造函数发现，会先调用父类的构造函数设置空的权限，设置用户名和密码到本地变量上。<br>设置当前传进去的身份信息还没经过认证。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this.setDetails(request, authRequest);</span><br></pre></td></tr></table></figure>
<p>会把请求的一些信息设到authRequest中，包括当前发请求的机器的ip，session等。</p>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/25.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/25.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;? extends Authentication&gt; toTest = authentication.getClass();</span><br><span class="line">AuthenticationException lastException = null;</span><br><span class="line">Authentication result = null;</span><br><span class="line">boolean debug = logger.isDebugEnabled();</span><br><span class="line">Iterator var6 = this.getProviders().iterator();</span><br><span class="line"></span><br><span class="line">while(var6.hasNext()) &#123;</span><br><span class="line">    AuthenticationProvider provider = (AuthenticationProvider)var6.next();</span><br><span class="line">    if (provider.supports(toTest)) &#123;</span><br><span class="line">        if (debug) &#123;</span><br><span class="line">            logger.debug(&quot;Authentication attempt using &quot; + provider.getClass().getName());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            result = provider.authenticate(authentication);</span><br><span class="line">            if (result != null) &#123;</span><br><span class="line">                this.copyDetails(authentication, result);</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (AccountStatusException var11) &#123;</span><br><span class="line">            this.prepareException(var11, authentication);</span><br><span class="line">            throw var11;</span><br><span class="line">        &#125; catch (InternalAuthenticationServiceException var12) &#123;</span><br><span class="line">            this.prepareException(var12, authentication);</span><br><span class="line">            throw var12;</span><br><span class="line">        &#125; catch (AuthenticationException var13) &#123;</span><br><span class="line">            lastException = var13;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AuthenticationManager用来管理下面的AuthenticationProvider。<br>真正的检验逻辑是写在AuthenticationProvider中，不同的登录方式的认证逻辑是不一样的。<br>用户名密码登录，校验的是用户名密码。如果是第三方登录，这时候是不用验密码的。<br>spring提供了两个provider，AuthenticationManager负责把所有的provider收集起来，然后收到请求的时候去循环它们，挨个去问你当前这个provider支不支持我这种登录方式。<br>即调用supports方法，判断支不支持我传进来的这个Authentication类型。<br>比如当前拿到的是UsernamePasswordAuthenticationToken，比如第三方的登录传的就是SocialAuthenticationToken。<br>根据传进来的Authentication类型会挑出其中一个provider来进行校验处理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = provider.authenticate(authentication);</span><br></pre></td></tr></table></figure>
<p>如果支持的话，往下走，真正去执行校验逻辑。</p>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/26.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/26.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/27.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/27.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<p>Authentication的主要校验逻辑是写在抽象类里面的，首先调用retrieveUser，获取到UserDetails对象。<br><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/28.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/28.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div><br>DaoAuthenticationProvider中实现了retrieveUser接口，在实现方法里，调用了我们提供的UserDetailsService实现。<br>通过loadUserByUsername查到我们的用户信息，并包装成UserDetails。如果拿不到，则抛出异常。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this.preAuthenticationChecks.check(user);</span><br></pre></td></tr></table></figure></p>
<p>如果拿到了用户信息，会做预检查。<br><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/29.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/29.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div><br>UserDetalis这个接口有4个方法来判断用户是否可用。锁定，过期等校验。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this.additionalAuthenticationChecks(user, (UsernamePasswordAuthenticationToken)authentication);</span><br></pre></td></tr></table></figure></p>
<p>做完预检查后，会做附加检查。在DaoAuthenticationProvider中有具体实现。<br><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/30.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/30.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div><br>用passwordEncoder校验当前的密码是否匹配。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this.postAuthenticationChecks.check(user);</span><br></pre></td></tr></table></figure></p>
<p>做完前面两步检查之后，还有一个后检查。也是UserDetails中的校验。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return this.createSuccessAuthentication(principalToReturn, authentication, user);</span><br></pre></td></tr></table></figure>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/31.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/31.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<p>所有的这些检查都通过之后，那么认为用户认证是成功的，拿获取到的用户信息、Authentication传进来的认证请求信息来创建SuccessAuthentication。</p>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/32.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/32.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<p>设置权限和认证通过。</p>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/33.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/33.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this.successfulAuthentication(request, response, chain, authResult);</span><br></pre></td></tr></table></figure>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/34.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/34.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<p>会调我们自己写的成功处理器。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">    authResult = this.attemptAuthentication(request, response);</span><br><span class="line">    if (authResult == null) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    this.sessionStrategy.onAuthentication(authResult, request, response);</span><br><span class="line">&#125; catch (InternalAuthenticationServiceException var8) &#123;</span><br><span class="line">    this.logger.error(&quot;An internal error occurred while trying to authenticate the user.&quot;, var8);</span><br><span class="line">    this.unsuccessfulAuthentication(request, response, var8);</span><br><span class="line">    return;</span><br><span class="line">&#125; catch (AuthenticationException var9) &#123;</span><br><span class="line">    this.unsuccessfulAuthentication(request, response, var9);</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果在认证过程中任何一处出了异常，会调用unsuccessfulAuthentication方法，其中会调用我们自己写的失败处理器。</p>
<h2 id="2-认证结果如何在多个请求之间共享"><a href="#2-认证结果如何在多个请求之间共享" class="headerlink" title="2.认证结果如何在多个请求之间共享"></a>2.认证结果如何在多个请求之间共享</h2><div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/36.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/36.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/35.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/35.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<p>在调成功处理器之前，将我们认证成功的Authentication放到SecurityContext，然后放到SecurityContextHolder里面，<br>SecurityContextHolder实际上是ThreadLocal的封装。</p>
<div class="figure center" style="width:100%;"><a class="fancybox" href="/assets/SpringSecurity技术栈开发企业级认证与授权/37.jpg" title="" data-caption="" data-fancybox="travel"><img class="fig-img" src="/assets/SpringSecurity技术栈开发企业级认证与授权/37.jpg" style="width:100%;height:100%;" alt=""></a></div><div style="clear:both;"></div>
<p>当请求进来的时候，检查sessionl里是否有SecurityContext。如果有，把SecurityContext从session中拿出来放到线程里，如果没有，则为空，放过。<br>当整个请求响应回来以后，过它的时候，它检查线程，如果线程里面有SecurityContext,就拿出来放到session里，这样不用的请求就可以在session中<br>拿到相同的认证信息。</p>
<h2 id="3-获取认证用户信息"><a href="#3-获取认证用户信息" class="headerlink" title="3.获取认证用户信息"></a>3.获取认证用户信息</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/user&quot;)</span><br><span class="line">public class UserController &#123;</span><br><span class="line">  @GetMapping(&quot;/me&quot;)</span><br><span class="line">  public Object getCurrentUser(@AuthenticationPrincipal UserDetails user) &#123;</span><br><span class="line">    return user;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @GetMapping(&quot;/me2&quot;)</span><br><span class="line">  public Object getCurrentUser2(Authentication authentication) &#123;</span><br><span class="line">    return authentication;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

                    
                        

                    
                    
                        <p>
                            <a href="/2020/04/07/Spring Security技术栈开发企业级认证与授权-认证流程源码级详解/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a class="link-unstyled" href="/2020/04/04/angular根据路由展开菜单/">
                            angular根据路由展开菜单
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2020-04-04T15:50:56+08:00">
	
		    4月 04, 2020
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h5 id="当路由为“-a”和“-a-b”class-active都会被添加。active可以设置为展开菜单的样式"><a href="#当路由为“-a”和“-a-b”class-active都会被添加。active可以设置为展开菜单的样式" class="headerlink" title="当路由为“/a”和“/a/b”class active都会被添加。active可以设置为展开菜单的样式"></a>当路由为“/a”和“/a/b”class active都会被添加。active可以设置为展开菜单的样式</h5><p>html:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;li [routerLink]=&quot;/a&quot; routerLinkActive=&quot;active&quot;&gt;a&lt;/li&gt;</span><br><span class="line">&lt;li [routerLink]=&quot;/a/b&quot; routerLinkActive=&quot;active&quot;&gt;ab&lt;/li&gt;</span><br></pre></td></tr></table></figure></p>
<h5 id="当路由中携带参数时（即？key-value）"><a href="#当路由中携带参数时（即？key-value）" class="headerlink" title="当路由中携带参数时（即？key=value）"></a>当路由中携带参数时（即？key=value）</h5><p>html:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;li [routerLink]=&quot;/a&quot; [class.active]=&quot;isActive(&quot;/a&quot;)&quot;&gt;a&lt;/li&gt;</span><br></pre></td></tr></table></figure></p>
<p>component:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">isActive(instruction: string): boolean &#123;</span><br><span class="line">  return this.router.isActive(this.router.createUrlTree([instruction]), false);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>参考：<br><a href="https://stackoverflow.com/questions/39271654/routerlinkactive-for-routerlink-with-parameters-dynamic" target="_blank" rel="noopener">https://stackoverflow.com/questions/39271654/routerlinkactive-for-routerlink-with-parameters-dynamic</a><br><a href="https://majing.io/posts/10000019031169" target="_blank" rel="noopener">https://majing.io/posts/10000019031169</a></p>

                    
                        

                    
                    
                        <p>
                            <a href="/2020/04/04/angular根据路由展开菜单/#post-footer" class="postShorten-excerpt_link link">
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
          <li class="pagination-prev">
            <a class="btn btn--default btn--small" href="/archives/2020/">
              <i class="fa fa-angle-left text-base icon-mr"></i>
              <span>上一页</span>
            </a>
          </li>
        
        
          <li class="pagination-next">
            <a class="btn btn--default btn--small" href="/archives/2020/page/3/">
              <span>下一页</span>
              <i class="fa fa-angle-right text-base icon-ml"></i>
            </a>
          </li>
        
        <li class="pagination-number">第 2 页 共 6 页</li>
    </ul>
</div>

</section>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2020 Brotherc. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/head.jpg" alt="作者的图片">
        
            <h4 id="about-card-name">Brotherc</h4>
        
            <div id="about-card-bio"><p>java development</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br>
                <p>java</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br>
                zhuhai
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-dbd16rvloemmuxdzniplmnxxvwoz24eya9wol0b7vvmlokgqsjivmb8dnscy.min.js"></script>
<!--SCRIPTS END-->



    </body>
</html>
